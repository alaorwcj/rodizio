<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rodízio de Organistas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 15px;
            background: #E5E7EB;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1e293b;
        }
        
        body.dark-mode .container {
            background: #0f172a;
            color: #e2e8f0;
        }
        
        body.dark-mode .card {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        body.dark-mode .card h2 {
            color: #93c5fd;
        }
        
        body.dark-mode .nav-tabs {
            background: #1e293b;
            border-bottom-color: #475569;
        }
        
        body.dark-mode .nav-tab,
        body.dark-mode .nav-dropdown-toggle {
            background: #1e293b;
            color: #cbd5e1;
        }
        
        body.dark-mode .nav-tab:hover,
        body.dark-mode .nav-dropdown-toggle:hover {
            background: #334155;
        }
        
        body.dark-mode .nav-tab.active,
        body.dark-mode .nav-dropdown-toggle.active {
            background: #475569;
            color: #93c5fd;
            border-bottom-color: #60a5fa;
        }
        
        body.dark-mode .nav-dropdown-menu {
            background: #0f172a;
        }
        
        body.dark-mode .nav-dropdown-item {
            background: #0f172a;
            color: #cbd5e1;
            border-bottom-color: #1e293b;
        }
        
        body.dark-mode .nav-dropdown-item:hover {
            background: #475569;
            color: #93c5fd;
        }
        
        body.dark-mode .nav-dropdown-item.active {
            background: #475569;
            color: #93c5fd;
            border-left-color: #60a5fa;
        }
        
        body.dark-mode .content {
            background: #0f172a;
        }
        
        body.dark-mode table {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        body.dark-mode table th {
            background: #1e3a8a;
        }
        
        body.dark-mode table tr:hover {
            background: #334155;
        }
        
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #1e293b;
            color: #e2e8f0;
            border-color: #334155;
        }
        
        body.dark-mode .escala-item {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        body.dark-mode .escala-dia-numero {
            color: #93c5fd;
        }
        
        body.dark-mode .escala-dia-semana,
        body.dark-mode .escala-organista {
            color: #cbd5e1;
        }
        
        body.dark-mode .no-escala {
            color: #94a3b8;
        }
        
        body.dark-mode .dashboard-title {
            color: #93c5fd;
        }
        
        body.dark-mode .header {
            background: linear-gradient(120deg, #1e293b 0%, #334155 35%, #475569 65%, #64748b 100%);
        }
        
        body.dark-mode .user-selector {
            background: rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .user-selector select {
            background: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }
        
        body.dark-mode .user-indicator {
            background: #7c3aed;
            color: #e0e7ff;
        }
        
        body.dark-mode .btn-warning {
            background: #7c3aed;
        }
        
        body.dark-mode .btn-warning:hover {
            background: #6d28d9;
        }
        
        /* Botão Dark Mode */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 10000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        body.dark-mode .dark-mode-toggle {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        body.dark-mode .dark-mode-toggle:hover {
            background: rgba(0, 0, 0, 0.4);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #F9FAFB;
            border-radius: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(120deg, #2E5090 0%, #4A6FA5 35%, #7B8FB8 65%, #9CA8C0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .user-selector {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-selector label {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .user-selector select {
            padding: 10px 20px;
            border-radius: 5px;
            border: 2px solid rgba(255,255,255,0.5);
            font-size: 1em;
            cursor: pointer;
            background: white;
            min-width: 200px;
            font-weight: 500;
        }
        
        .user-selector select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        
        .user-indicator {
            background: #CBD5E1;
            color: #1E3A8A;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .nav-tabs {
            display: flex;
            background: #F9FAFB;
            border-bottom: 2px solid #E5E7EB;
            position: relative;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #F9FAFB;
            border: none;
            font-size: 1.1em;
            color: #374151;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-tab:hover {
            background: #E5E7EB;
        }
        
        .nav-tab.active {
            background: #C4B5FD;
            border-bottom: 3px solid #1E3A8A;
            font-weight: 600;
            color: #1E3A8A;
        }
        
        /* Menu Dropdown */
        .nav-dropdown {
            position: relative;
            flex: 1;
        }
        
        .nav-dropdown-toggle {
            width: 100%;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #F9FAFB;
            border: none;
            font-size: 1.1em;
            color: #374151;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .nav-dropdown-toggle:hover {
            background: #E5E7EB;
        }
        
        .nav-dropdown-toggle.active {
            background: #C4B5FD;
            border-bottom: 3px solid #1E3A8A;
            font-weight: 600;
            color: #1E3A8A;
        }
        
        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #F9FAFB;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }
        
        .nav-dropdown-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .nav-dropdown-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #E5E7EB;
            transition: all 0.3s;
            font-size: 0.95em;
            text-align: left;
            background: #F9FAFB;
            color: #374151;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .nav-dropdown-item:hover {
            background: #C4B5FD;
            padding-left: 25px;
            color: #1E3A8A;
        }
        
        .nav-dropdown-item.active {
            background: #C4B5FD;
            border-left: 3px solid #1E3A8A;
            font-weight: 600;
            color: #1E3A8A;
        }
        
        .dropdown-arrow {
            font-size: 0.7em;
            transition: transform 0.3s;
        }
        
        .nav-dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .card h2 {
            color: #1E3A8A;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #2563EB;
            color: white;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #1E40AF;
        }
        
        .btn-success {
            background: #4ADE80;
            color: white;
            font-weight: 500;
        }
        
        .btn-success:hover {
            background: #22c55e;
        }
        
        .btn-danger {
            background: #EF4444;
            color: white;
            font-weight: 500;
        }
        
        .btn-danger:hover {
            background: #B91C1C;
        }
        
        .btn-warning {
            background: #2563EB;
            color: white;
            font-weight: 500;
        }
        
        .btn-warning:hover {
            background: #1E40AF;
        }
        
        .info-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
        }
        
        .info-badge.green {
            background: #d1fae5;
            color: #065f46;
        }
        
        .info-badge.blue {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .escala-atual {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
            margin-top: 20px;
        }
        
        .escala-item {
            background: white;
            border-radius: 6px;
            padding: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-top: 2px solid #2563EB;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .escala-item:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        /* Domingo - Vermelho */
        .escala-item.domingo {
            border-top-color: #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        
        /* Segunda - Azul */
        .escala-item.segunda {
            border-top-color: #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }
        
        /* Terça - Verde */
        .escala-item.terca {
            border-top-color: #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%);
        }
        
        /* Quarta - Laranja */
        .escala-item.quarta {
            border-top-color: #ea580c;
            background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%);
        }
        
        /* Quinta - Roxo */
        .escala-item.quinta {
            border-top-color: #7c3aed;
            background: linear-gradient(135deg, #f5f3ff 0%, #ffffff 100%);
        }
        
        /* Sexta - Turquesa */
        .escala-item.sexta {
            border-top-color: #0891b2;
            background: linear-gradient(135deg, #ecfeff 0%, #ffffff 100%);
        }
        
        /* Sábado - Dourado/Marrom */
        .escala-item.sabado {
            border-top-color: #ca8a04;
            background: linear-gradient(135deg, #fefce8 0%, #ffffff 100%);
        }
        
        .escala-item.passado {
            opacity: 0.5;
        }
        
        .escala-date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .escala-dia-numero {
            font-size: 1.4em;
            font-weight: bold;
            color: #1E3A8A;
            line-height: 1;
            margin-bottom: 2px;
        }
        
        .escala-item.domingo .escala-dia-numero {
            color: #dc2626;
        }
        
        .escala-item.segunda .escala-dia-numero {
            color: #2563eb;
        }
        
        .escala-item.terca .escala-dia-numero {
            color: #059669;
        }
        
        .escala-item.quarta .escala-dia-numero {
            color: #ea580c;
        }
        
        .escala-item.quinta .escala-dia-numero {
            color: #7c3aed;
        }
        
        .escala-item.sexta .escala-dia-numero {
            color: #0891b2;
        }
        
        .escala-item.sabado .escala-dia-numero {
            color: #ca8a04;
        }
        
        .escala-dia-semana {
            font-size: 0.7em;
            font-weight: 600;
            color: #1E3A8A;
            margin-bottom: 1px;
        }
        
        .escala-mes-ano {
            font-size: 0.6em;
            color: #374151;
        }
        
        .escala-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .escala-badge.domingo {
            background: #d1fae5;
            color: #065f46;
        }
        
        .escala-badge.terca {
            background: #fef3c7;
            color: #78350f;
        }
        
        .escala-divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            margin: 15px 0;
        }
        
        .escala-servicos {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .escala-servico {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 6px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: 4px;
            border-left: 2px solid #2563EB;
        }
        
        .escala-item.domingo .escala-servico {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: #10b981;
        }
        
        .escala-item.terca .escala-servico {
            background: rgba(251, 191, 36, 0.05);
            border-left-color: #fbbf24;
        }
        
        .escala-servico-icon {
            font-size: 0.9em;
        }
        
        .escala-servico-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .escala-tipo {
            font-size: 0.55em;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .escala-organista {
            font-size: 0.7em;
            font-weight: 600;
            color: #1E3A8A;
        }
        
        .escala-vazio {
            color: #9CA3AF;
            font-style: italic;
            font-size: 0.65em;
        }
        
        .btn-adicionar-agenda {
            transition: all 0.3s ease;
        }
        
        .btn-adicionar-agenda:hover {
            background: #2563eb !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .btn-adicionar-agenda:active {
            transform: translateY(0);
        }
        
        .dashboard-section {
            margin-bottom: 30px;
        }
        
        .dashboard-title {
            font-size: 1.5em;
            color: #1E3A8A;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .no-escala {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #8B5CF6;
            color: white;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #312E81;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #dc2626;
        }
        
        /* Notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .notification.error {
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ========== RESPONSIVIDADE MOBILE ========== */
        @media (max-width: 768px) {
            /* Evitar scroll horizontal */
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            
            body {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            * {
                box-sizing: border-box !important;
            }
            
            /* Botão Dark Mode menor no mobile */
            .dark-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                font-size: 0.9em;
                gap: 4px;
            }
            
            .dark-mode-toggle span {
                font-size: 0.85em;
            }
            
            /* Header mais compacto e responsivo */
            header {
                padding: 12px 10px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            header h1 {
                font-size: 1.4em !important;
                margin: 0 !important;
                padding-right: 60px !important; /* Espaço para botão dark mode */
            }
            
            /* Container 100% largura no mobile */
            .container {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 0 !important;
            }
            
            /* Menu de abas responsivo em grid */
            nav {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)) !important;
                gap: 5px !important;
                padding: 10px 5px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                overflow-x: visible !important;
                white-space: normal !important;
            }
            
            nav a,
            nav button {
                display: block !important;
                padding: 10px 5px !important;
                font-size: 0.75em !important;
                min-width: 0 !important;
                width: 100% !important;
                text-align: center !important;
                white-space: normal !important;
                line-height: 1.2 !important;
                word-wrap: break-word !important;
            }
            
            /* Dropdown do menu */
            .nav-dropdown {
                position: relative !important;
            }
            
            .nav-dropdown-content {
                position: static !important;
                width: 100% !important;
                box-shadow: none !important;
                margin-top: 5px !important;
            }
            
            .nav-dropdown-content a {
                padding: 8px 10px !important;
                font-size: 0.75em !important;
            }
            
            /* Conteúdo das tabs */
            .tab-content {
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
            }
            
            /* Cards mais compactos e responsivos */
            .card {
                padding: 12px !important;
                margin: 10px 5px !important;
                width: calc(100% - 10px) !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                overflow-x: hidden !important;
            }
            
            .card h2 {
                font-size: 1.1em !important;
                word-wrap: break-word !important;
            }
            
            /* Botões menores e responsivos */
            .btn {
                padding: 8px 12px !important;
                font-size: 0.85em !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* Formulários responsivos */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="date"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important; /* Evita zoom no iOS */
                padding: 10px !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Tabelas responsivas com scroll */
            .escala-table {
                font-size: 0.75em !important;
                display: block !important;
                overflow-x: auto !important;
                white-space: nowrap !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .escala-table thead,
            .escala-table tbody,
            .escala-table tr {
                display: table !important;
                width: 100% !important;
            }
            
            .escala-table th,
            .escala-table td {
                padding: 6px 4px !important;
                font-size: 0.95em !important;
            }
            
            /* Container de tabela com scroll */
            .table-container,
            #escalaContainer,
            #escalaRJMContainer {
                width: 100% !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Grid de cards das escalas - responsivo */
            .escalas-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
                gap: 8px !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 5px !important;
                box-sizing: border-box !important;
            }
            
            .escala-card {
                width: 100% !important;
                padding: 8px !important;
                font-size: 0.85em !important;
            }
            
            /* Modais responsivos */
            .modal-overlay {
                padding: 10px !important;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 10px auto !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                box-sizing: border-box !important;
            }
            
            .modal-header h2 {
                font-size: 1.2em !important;
                padding-right: 40px !important;
            }
            
            .modal-close {
                font-size: 1.5em !important;
            }
            
            /* Ajustes no dashboard */
            .info-box {
                padding: 10px !important;
                margin: 5px !important;
                width: calc(50% - 10px) !important;
                box-sizing: border-box !important;
            }
            
            .info-box h3 {
                font-size: 0.9em !important;
                word-wrap: break-word !important;
            }
            
            .info-box .value {
                font-size: 1.5em !important;
            }
            
            /* Contexto (Regional, Sub-regional, Comum) */
            .context-selector,
            .context-display {
                padding: 10px !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .context-selector select {
                width: 100% !important;
                margin-bottom: 8px !important;
                box-sizing: border-box !important;
            }
            
            /* Botões de ação em linha - responsivos */
            .btn-group,
            .action-buttons,
            div[style*="display: flex"] {
                flex-wrap: wrap !important;
                gap: 6px !important;
                width: 100% !important;
                justify-content: flex-start !important;
            }
            
            .btn-group .btn,
            .action-buttons .btn {
                flex: 1 1 calc(50% - 6px) !important;
                min-width: 0 !important;
                max-width: 100% !important;
                font-size: 0.8em !important;
                padding: 8px 10px !important;
                white-space: normal !important;
                line-height: 1.2 !important;
            }
            
            /* Imagens e ícones proporcionais */
            img {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Prevenir quebra de layout */
            pre, code {
                overflow-x: auto !important;
                word-wrap: break-word !important;
                white-space: pre-wrap !important;
            }
        }
        
        /* Mobile muito pequeno (< 375px) */
        @media (max-width: 375px) {
            header h1 {
                font-size: 1.3em !important;
            }
            
            nav a {
                padding: 10px 12px !important;
                font-size: 0.8em !important;
            }
            
            .btn {
                padding: 8px 12px !important;
                font-size: 0.85em !important;
            }
            
            .escalas-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Botão Dark Mode -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Alternar modo escuro">
        <span id="dark-mode-icon">🌙</span>
        <span id="dark-mode-text">Escuro</span>
    </button>
    
    <div class="container">
        <div class="header">
            <h1>🎹 Rodízio de Organistas</h1>
            <p id="periodo-info">Carregando período...</p>
            
            <!-- Seletor de Contexto Hierárquico -->
            <div id="contexto-selector" class="user-selector" style="background: rgba(255,255,255,0.15); margin-bottom: 15px;">
                <label>📍 Contexto:</label>
                <select id="selectRegional" onchange="carregarSubRegionais()" style="min-width: 150px;">
                    <option value="">Carregando...</option>
                </select>
                <span style="color: white; font-size: 1.2em;">›</span>
                <select id="selectSubRegional" onchange="carregarComuns()" style="min-width: 150px;">
                    <option value="">Selecione...</option>
                </select>
                <span style="color: white; font-size: 1.2em;">›</span>
                <select id="selectComum" onchange="selecionarContexto()" style="min-width: 150px;">
                    <option value="">Selecione...</option>
                </select>
            </div>
            
            <div class="user-selector">
                <label>Você está logado como:</label>
                <span class="user-indicator">
                    {% if user.is_admin %}
                         {{ user.nome }} (Administrador)
                    {% else %}
                        👤 {{ user.nome }} (Organista)
                    {% endif %}
                </span>
                <button onclick="trocarSenha()" class="btn btn-warning" style="margin-left: 10px;">
                    🔐 Trocar Senha
                </button>
                <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px;">
                    🚪 Sair
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <!-- Dashboard -->
            <button class="nav-tab active" onclick="showTab(\'dashboard\')">Dashboard</button>
            
            <!-- Menu: Rodízios -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleDropdown('rodizios-menu')">
                    Rodízios
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div id="rodizios-menu" class="nav-dropdown-menu">
                    <div class="nav-dropdown-item" onclick="showTab('escala')">
                        Culto Oficial
                    </div>
                    <div class="nav-dropdown-item" onclick="showTab('rjm')">
                        RJM
                    </div>
                </div>
            </div>
            
            {% if user.is_admin %}
            <!-- Menu: Encarregado Local (Admin) -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleDropdown('encarregado-menu')">
                    Encarregado Local
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div id="encarregado-menu" class="nav-dropdown-menu">
                    <div class="nav-dropdown-item" onclick="showTab('organistas')">
                        Organistas
                    </div>
                    <div class="nav-dropdown-item" onclick="showTab('config')">
                        Configurações
                    </div>
                </div>
            </div>
            
            <!-- Menu: Agenda Organista (Admin) -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleDropdown('agenda-menu-admin')">
                    Agenda Organista
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div id="agenda-menu-admin" class="nav-dropdown-menu">
                    <div class="nav-dropdown-item" onclick="showTab('admin-indisp')">
                        Restrições de Dias
                    </div>
                </div>
            </div>
            
            {% if user.tipo == 'master' %}
            <!-- Menu: Administrativo (Master) -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleDropdown('admin-menu')">
                    Administrativo
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div id="admin-menu" class="nav-dropdown-menu">
                    <div class="nav-dropdown-item" onclick="showTab('hierarquia')">
                        Hierarquia
                    </div>
                    <div class="nav-dropdown-item" onclick="showTab('usuarios')">
                        Usuários
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <!-- Menu: Agenda Organista (Organista) -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleDropdown('agenda-menu-org')">
                    Agenda Organista
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div id="agenda-menu-org" class="nav-dropdown-menu">
                    <div class="nav-dropdown-item" onclick="showTab('indisponibilidades')">
                        Restrições de Dias
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-panel active">
                <div class="card">
                    <h2 id="dashboardComumTitle">🎹 Rodízio de Organistas</h2>
                    
                    <div style="margin-top: 20px;">
                        <span class="info-badge green">{{ cfg.bimestre.inicio | date_br }}</span>
                        <span class="info-badge blue">até</span>
                        <span class="info-badge green">{{ cfg.bimestre.fim | date_br }}</span>
                    </div>
                </div>
                
                {% if not user.is_admin %}
                <!-- Meus Dias de Rodízio (apenas para organistas) -->
                <div class="card">
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">🎹 Meus Dias de Rodízio</h2>
                        <div id="meusDias" class="escala-atual">
                            <div class="no-escala">Carregando seus dias...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if user.is_admin %}
                <!-- Todas as Escalas (apenas para admin) -->
                <div class="card">
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">📅 Próximas Escalas</h2>
                        <div id="escalaAtual" class="escala-atual">
                            <div class="no-escala">Carregando escala...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <h2>Status Atual</h2>
                    <p id="statusOrganistas">Carregando...</p>
                    <p id="statusIndisponibilidades">Carregando...</p>
                    <p id="statusEscala">Carregando...</p>
                </div>
            </div>
            
            <!-- Organistas Tab -->
            <div id="organistas" class="tab-panel">
                {% if user.is_coordenador %}
                <div class="card">
                    <h2>Cadastro de Organistas</h2>
                    <div id="alertOrganista" class="alert hidden"></div>
                    
                    <form id="formOrganista" onsubmit="addOrganista(event)">
                        {% if user.is_master or user.tipo == 'encarregado_comum' %}
                        <div class="form-group">
                            <label>📍 Comum:</label>
                            <select id="orgComumId" required onchange="carregarDiasDoComum()" {% if user.tipo == 'encarregado_comum' %}disabled{% endif %}>
                                <option value="">{% if user.tipo == 'encarregado_comum' %}Carregando...{% else %}Selecione o comum...{% endif %}</option>
                            </select>
                            <small style="color: #666;">{% if user.tipo == 'encarregado_comum' %}Sua comum será usada automaticamente{% else %}Selecione o comum onde a organista atuará{% endif %}</small>
                            {% if user.tipo == 'encarregado_comum' %}
                            <input type="hidden" id="orgComumIdHidden" value="{{ user.contexto_id }}">
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label>ID (único):</label>
                            <input type="text" id="orgId" required placeholder="Ex: maria_silva">
                            <small style="color: #666;">Use apenas letras minúsculas e underscore</small>
                        </div>
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="orgNome" required placeholder="Ex: Maria Silva">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="orgEmail" placeholder="exemplo@email.com">
                            <small style="color: #666;">Opcional</small>
                        </div>
                        <div class="form-group">
                            <label>Telefone:</label>
                            <input type="tel" id="orgTelefone" placeholder="(11) 98765-4321">
                            <small style="color: #666;">Opcional</small>
                        </div>
                        <div class="form-group">
                            <label>Tipos (Ctrl+clique para múltiplos):</label>
                            <select id="orgTipos" multiple required>
                                <option value="Meia-hora">Meia-hora</option>
                                <option value="Culto">Culto</option>
                                <option value="RJM">RJM (Reunião de Jovens e Menores)</option>
                            </select>
                            <small style="color: #666;">Selecione os tipos que a organista pode tocar</small>
                        </div>
                        <div class="form-group">
                            <label>Dias Permitidos (Ctrl+clique para múltiplos):</label>
                            <select id="orgDias" multiple required>
                                <!-- Será preenchido dinamicamente com base no comum selecionado -->
                            </select>
                            <small style="color: #666;">Baseado nos dias de culto configurados no comum</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar Organista</button>
                    </form>
                </div>
                {% endif %}
                
                <div class="card">
                    <h2>Organistas Cadastrados</h2>
                    <table id="tableOrganistas">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Tipos</th>
                                <th>Dias</th>
                                {% if user.is_admin %}
                                <th>Ações</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="tbodyOrganistas">
                            <tr><td colspan="6" style="text-align: center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Indisponibilidades Tab -->
            <div id="indisponibilidades" class="tab-panel">
                <div class="card">
                    <h2>Restrições de Dias</h2>
                    <p>Marque as datas em que você NÃO poderá tocar no período atual.</p>
                    <div id="alertIndisp" class="alert hidden"></div>
                    
                    <div id="calendarioIndisp" style="margin-top: 20px;">
                        <!-- Calendário será gerado dinamicamente -->
                    </div>
                    
                    <div id="chipsDatas" style="margin-top: 20px;">
                        <!-- Chips com datas selecionadas -->
                    </div>
                </div>
            </div>
            
            <!-- Admin - Todas Indisponibilidades Tab -->
            <div id="admin-indisp" class="tab-panel">
                <div class="card">
                    <h2>🔐 Gerenciar Restrições de Dias</h2>
                    <p>Como administrador, você pode visualizar e gerenciar as restrições de dias de todas as organistas.</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Filtrar por organista:</label>
                        <select id="filterOrganista" onchange="loadAdminIndisp()" style="padding: 8px; margin-left: 10px; border-radius: 5px;">
                            <option value="">Todas</option>
                        </select>
                        <button onclick="loadAdminIndisp()" class="btn btn-primary" style="margin-left: 10px;">🔄 Atualizar</button>
                    </div>
                    
                    <div id="adminIndispList" style="margin-top: 20px;">
                        <!-- Lista será carregada via JS -->
                    </div>
                </div>
            </div>
            
            <!-- Configurações Tab -->
            <div id="config" class="tab-panel">
                <div class="card">
                    <h2>Configurações do Sistema</h2>
                    <div id="alertConfig" class="alert hidden"></div>
                    
                    <form id="formConfig" onsubmit="saveConfig(event)">
                        <div class="form-group">
                            <label>Data de Início do Período:</label>
                            <input type="date" id="configInicio" value="{{ cfg.bimestre.inicio }}" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Fim do Período:</label>
                            <input type="date" id="configFim" value="{{ cfg.bimestre.fim }}" required>
                        </div>
                        <div class="form-group">
                            <label>Prazo para marcar indisponibilidade antes da publicação (dias):</label>
                            <input type="number" id="configFechamento" value="{{ cfg.fechamento_publicacao_dias }}" min="0" max="30" required>
                        </div>
                        <button type="submit" class="btn btn-success">💾 Salvar Configurações</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>📊 Estatísticas do Sistema</h2>
                    <div id="statsSystem">Carregando...</div>
                </div>
            </div>
            
            <!-- Hierarquia Tab (Master Only) -->
            {% if user.tipo == 'master' %}
            <div id="hierarquia" class="tab-panel">
                <div class="card">
                    <h2>🌐 Gerenciamento da Hierarquia</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Gerencie a estrutura hierárquica do sistema: Regionais, Sub-Regionais e Comuns.
                    </p>
                    
                    <div id="alertHierarquia" class="alert hidden"></div>
                    
                    <!-- Regionais -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">🏙️ Regionais</h3>
                            <button onclick="mostrarModalNovaRegional()" class="btn btn-success">➕ Nova Regional</button>
                        </div>
                        <div id="listaRegionais" style="display: grid; gap: 15px;">
                            <p style="color: #999;">Carregando...</p>
                        </div>
                    </div>
                    
                    <!-- Sub-Regionais -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">📍 Sub-Regionais</h3>
                            <button onclick="mostrarModalNovaSubRegional()" class="btn btn-success">➕ Nova Sub-Regional</button>
                        </div>
                        <div id="listaSubRegionais" style="display: grid; gap: 15px;">
                            <p style="color: #999;">Selecione uma Regional acima</p>
                        </div>
                    </div>
                    
                    <!-- Comuns -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">⛪ Comuns</h3>
                            <button onclick="mostrarModalNovoComum()" class="btn btn-success">➕ Novo Comum</button>
                        </div>
                        <div id="listaComuns" style="display: grid; gap: 15px;">
                            <p style="color: #999;">Selecione uma Sub-Regional acima</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Usuários Tab (Master Only) -->
            <div id="usuarios" class="tab-panel">
                <div class="card">
                    <h2>👤 Gerenciamento de Usuários</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Gerencie encarregados e suas atribuições de contexto.
                    </p>
                    
                    <div id="alertUsuarios" class="alert hidden"></div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Lista de Usuários</h3>
                        <button onclick="mostrarModalNovoUsuario()" class="btn btn-success">➕ Novo Usuário</button>
                    </div>
                    
                    <div id="listaUsuarios" style="overflow-x: auto;">
                        <p style="color: #999;">Carregando...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Configurações do Comum Atual</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Configure os dias e horários de culto específicos deste comum.
                    </p>
                    
                    <form id="formConfigComum" onsubmit="salvarConfigComum(event)">
                        <div class="form-group">
                            <label style="font-weight: bold; font-size: 16px; margin-bottom: 15px; display: block;">
                                📅 Dias de Culto e Horários
                            </label>
                            
                            <div id="diasHorariosContainer" style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Domingo -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Domingo" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">☀️ Domingo</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosDomingo" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Domingo')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Segunda -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Segunda" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Segunda</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosSegunda" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Segunda')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Terça -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Terça" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Terça</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosTerça" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Terça')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quarta -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Quarta" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Quarta</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosQuarta" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Quarta')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quinta -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Quinta" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Quinta</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosQuinta" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Quinta')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Sexta -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Sexta" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Sexta</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosSexta" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Sexta')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Sábado -->
                                <div class="dia-horario-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600;">
                                        <input type="checkbox" name="dias_culto" value="Sábado" onchange="toggleHorarios(this)">
                                        <span style="font-size: 15px;">📅 Sábado</span>
                                    </label>
                                    <div class="horarios-container" style="display: none; margin-left: 30px;">
                                        <label style="font-size: 13px; color: #666; margin-bottom: 5px; display: block;">Horários:</label>
                                        <div id="horariosSábado" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
                                        <button type="button" onclick="adicionarHorario('Sábado')" class="btn-add-horario" style="background: #3b82f6; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ➕ Adicionar Horário
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label style="font-weight: bold;">📆 Período do Rodízio:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="date" id="configComumInicio" required style="flex: 1; padding: 8px;">
                                <span style="color: #666;">até</span>
                                <input type="date" id="configComumFim" required style="flex: 1; padding: 8px;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: bold;">⏱️ Fechamento de Publicação:</label>
                            <select id="configFechamentoDias" style="padding: 8px; width: 100%;">
                                <option value="3">3 dias antes</option>
                                <option value="5">5 dias antes</option>
                                <option value="7" selected>7 dias antes (padrão)</option>
                                <option value="10">10 dias antes</option>
                                <option value="15">15 dias antes</option>
                            </select>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Tempo limite para organistas marcarem indisponibilidade antes do culto
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 16px;">
                            💾 Salvar Todas as Configurações
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <!-- Escala Tab -->
            <div id="escala" class="tab-panel">
                {% if user.is_admin %}
                <div class="card">
                    <h2>📋 Gerenciamento de Escala</h2>
                    <div id="alertEscala" class="alert hidden"></div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="loadEscalaAtual()" class="btn" style="background: #64748b; color: white;">
                            🔄 Carregar Escala Atual
                        </button>
                        <button onclick="criarEscalaVazia()" class="btn btn-success">
                            ➕ Criar Nova Escala
                        </button>
                        <button onclick="deletarEscalaAtual()" class="btn btn-danger">
                            🗑️ Deletar Escala Atual
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">� Culto Oficial</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if user.is_admin %}
                            <button onclick="salvarTodasAlteracoes()" class="btn" style="background: #10b981; color: white;">
                                💾 Salvar Todas as Alterações
                            </button>
                            {% endif %}
                            <button onclick="exportarPDF()" class="btn" style="background: #dc2626; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-pdf.gif') }}" alt="PDF" style="width: 20px; height: 20px;">
                                Exportar PDF
                            </button>
                            <button onclick="compartilharWhatsApp()" class="btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-whatsapp.gif') }}" alt="WhatsApp" style="width: 20px; height: 20px;">
                                Compartilhar no WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <div id="infoEscala" style="margin-bottom: 15px; color: #666;">
                        <p>Carregando...</p>
                    </div>
                    
                    <!-- Conteúdo da escala será inserido aqui -->
                    <div id="escalaContainer">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala publicada ainda.</p>
                            {% if user.is_admin %}
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Nova Escala" acima para começar.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>📊 Estatísticas do Culto Oficial</h2>
                    <div id="statsEscala">
                        <p style="color: #666;">Gere uma escala para ver as estatísticas.</p>
                    </div>
                </div>
            </div>
            
            <!-- RJM Tab -->
            <div id="rjm" class="tab-panel">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <img src="{{ url_for('static', filename='icons8-children-48.png') }}" alt="RJM" style="width: 32px; height: 32px;">
                            RJM - Reunião de Jovens e Menores
                        </h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if user.is_admin %}
                            <button onclick="salvarTodasAlteracoesRJM()" class="btn" style="background: #10b981; color: white;">
                                💾 Salvar Todas as Alterações
                            </button>
                            <button onclick="criarEscalaRJM()" class="btn btn-primary">
                                ➕ Criar Escala RJM Vazia
                            </button>
                            <button onclick="deletarEscalaRJM()" class="btn btn-danger">
                                🗑️ Deletar Escala RJM
                            </button>
                            {% endif %}
                            <button onclick="exportarPDFRJM()" class="btn" style="background: #dc2626; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-pdf.gif') }}" alt="PDF" style="width: 20px; height: 20px;">
                                Exportar PDF
                            </button>
                            <button onclick="compartilharWhatsAppRJM()" class="btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-whatsapp.gif') }}" alt="WhatsApp" style="width: 20px; height: 20px;">
                                Compartilhar no WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #92400e;">ℹ️ Sobre a RJM</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                            <li><strong>Horário:</strong> Domingos às 10:00</li>
                            <li><strong>Duração:</strong> Aproximadamente 1h30 (10:00 - 11:30)</li>
                            <li><strong>Organistas:</strong> Apenas 1 organista por domingo (não há meia-hora)</li>
                        </ul>
                    </div>
                    
                    <div id="infoEscalaRJM" style="margin-bottom: 15px; color: #666;">
                        <p>Carregando...</p>
                    </div>
                    
                    <div id="escalaRJMContainer">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala RJM publicada ainda.</p>
                            {% if user.is_admin %}
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Escala RJM Vazia" acima para começar.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>📊 Estatísticas da Escala RJM</h2>
                    <div id="statsEscalaRJM">
                        <p style="color: #666;">Gere uma escala para ver as estatísticas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Organista -->
    <div id="modalEditarOrganista" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">✏️ Editar Organista</h2>
                <button class="modal-close" onclick="fecharModalEditar()">×</button>
            </div>
            <form id="formEditarOrganista" onsubmit="salvarEdicaoOrganista(event)">
                <input type="hidden" id="editOrgId">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="editOrgNome" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="editOrgEmail" placeholder="exemplo@email.com">
                    <small style="color: #666;">Opcional</small>
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="tel" id="editOrgTelefone" placeholder="(11) 98765-4321">
                    <small style="color: #666;">Opcional</small>
                </div>
                <div class="form-group">
                    <label>Tipos (Ctrl+clique para múltiplos):</label>
                    <select id="editOrgTipos" multiple required style="min-height: 120px;">
                        <option value="Meia-hora">Meia-hora</option>
                        <option value="Culto">Culto</option>
                        <option value="RJM">RJM (Reunião de Jovens e Menores)</option>
                    </select>
                    <small style="color: #666;">Selecione os tipos que a organista pode tocar</small>
                </div>
                <div class="form-group">
                    <label>Dias Permitidos (Ctrl+clique para múltiplos):</label>
                    <select id="editOrgDias" multiple required style="min-height: 80px;">
                        <option value="Domingo">Domingo</option>
                        <option value="Terça">Terça</option>
                    </select>
                    <small style="color: #666;">RJM é sempre aos domingos</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn" style="flex: 1; background: #10b981; color: white;">💾 Salvar Alterações</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalEditar()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modais de Hierarquia -->
    {% if user.tipo == 'master' %}
    <!-- Modal Nova Regional -->
    <div id="modalNovaRegional" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="margin: 0;">➕ Nova Regional</h2>
                <button class="modal-close" onclick="fecharModalNovaRegional()">✕</button>
            </div>
            <form onsubmit="criarRegional(event)">
                <div class="form-group">
                    <label>ID da Regional:</label>
                    <input type="text" id="novaRegionalId" required placeholder="Ex: gru, spo, abc">
                    <small style="color: #666;">Use apenas letras minúsculas, sem espaços ou acentos</small>
                </div>
                <div class="form-group">
                    <label>Nome da Regional:</label>
                    <input type="text" id="novaRegionalNome" required placeholder="Ex: GRU - Guarulhos">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">✅ Criar</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalNovaRegional()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Nova Sub-Regional -->
    <div id="modalNovaSubRegional" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="margin: 0;">➕ Nova Sub-Regional</h2>
                <button class="modal-close" onclick="fecharModalNovaSubRegional()">✕</button>
            </div>
            <form onsubmit="criarSubRegional(event)">
                <div class="form-group">
                    <label>Regional:</label>
                    <select id="novaSubRegionalPai" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ID da Sub-Regional:</label>
                    <input type="text" id="novaSubRegionalId" required placeholder="Ex: santa_isabel, centro">
                    <small style="color: #666;">Use apenas letras minúsculas e underscore</small>
                </div>
                <div class="form-group">
                    <label>Nome da Sub-Regional:</label>
                    <input type="text" id="novaSubRegionalNome" required placeholder="Ex: Santa Isabel">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">✅ Criar</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalNovaSubRegional()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Novo Comum -->
    <div id="modalNovoComum" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 style="margin: 0;">➕ Novo Comum</h2>
                <button class="modal-close" onclick="fecharModalNovoComum()">✕</button>
            </div>
            <form onsubmit="criarComum(event)">
                <div class="form-group">
                    <label>Regional:</label>
                    <select id="novoComumRegional" onchange="carregarSubRegionaisModal()" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sub-Regional:</label>
                    <select id="novoComumSubRegional" required>
                        <option value="">Selecione Regional primeiro...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ID do Comum:</label>
                    <input type="text" id="novoComumId" required placeholder="Ex: vila_paula, centro">
                    <small style="color: #666;">Use apenas letras minúsculas e underscore</small>
                </div>
                <div class="form-group">
                    <label>Nome do Comum:</label>
                    <input type="text" id="novoComumNome" required placeholder="Ex: Vila Paula">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb;">
                
                <h3 style="margin-bottom: 15px;">📅 Configuração de Dias e Horários</h3>
                
                <div class="form-group">
                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block;">Selecione os dias de culto e configure os horários:</label>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        <div style="display: grid; gap: 12px;">
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Domingo" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #dc2626;">☀️ Domingo</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários (separados por vírgula):</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Domingo" placeholder="Ex: 09:00, 18:00, 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Segunda" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #2563eb;">📅 Segunda-feira</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Segunda" placeholder="Ex: 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Terça" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #059669;">📅 Terça-feira</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Terça" placeholder="Ex: 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Quarta" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #ea580c;">📅 Quarta-feira</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Quarta" placeholder="Ex: 19:30, 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Quinta" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #7c3aed;">📅 Quinta-feira</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Quinta" placeholder="Ex: 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Sexta" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #0891b2;">📅 Sexta-feira</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Sexta" placeholder="Ex: 19:30, 20:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                            
                            <div class="dia-horario-config">
                                <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="modal_dias_culto" value="Sábado" onchange="toggleModalHorarios(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                        <strong style="font-size: 1.05em; color: #ca8a04;">📅 Sábado</strong>
                                    </div>
                                    <div class="modal-horarios-container" style="display: none; padding-left: 28px;">
                                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                        <input type="text" class="modal-horarios-input" data-dia="Sábado" placeholder="Ex: 18:00, 19:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;">
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                            <small style="color: #1e40af; font-size: 0.9em;">
                                💡 <strong>Dica:</strong> Marque o checkbox do dia e depois digite os horários no formato HH:MM, separados por vírgula.<br>
                                Exemplo: <code style="background: white; padding: 2px 6px; border-radius: 3px;">09:00, 18:00, 20:00</code>
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>⏱️ Fechamento de Publicação:</label>
                    <select id="novoComumFechamentoDias">
                        <option value="3">3 dias antes</option>
                        <option value="5">5 dias antes</option>
                        <option value="7" selected>7 dias antes (padrão)</option>
                        <option value="10">10 dias antes</option>
                        <option value="15">15 dias antes</option>
                    </select>
                    <small style="color: #666;">Prazo para organistas marcarem indisponibilidade</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">✅ Criar Comum</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalNovoComum()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Novo Usuário -->
    <div id="modalNovoUsuario" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 style="margin: 0;">➕ Novo Usuário</h2>
                <button class="modal-close" onclick="fecharModalNovoUsuario()">✕</button>
            </div>
            <form onsubmit="criarUsuario(event)">
                <div class="form-group">
                    <label>ID do Usuário (login):</label>
                    <input type="text" id="novoUsuarioId" required placeholder="Ex: encarregado_itaquera">
                    <small style="color: #666;">Use apenas letras minúsculas e underscore</small>
                </div>
                <div class="form-group">
                    <label>Nome Completo:</label>
                    <input type="text" id="novoUsuarioNome" required placeholder="Ex: João Silva">
                </div>
                <div class="form-group">
                    <label>Tipo de Usuário:</label>
                    <select id="novoUsuarioTipo" required onchange="atualizarContextoUsuario()">
                        <option value="">Selecione...</option>
                        <option value="master">Master (Acesso Total)</option>
                        <option value="admin_regional">Admin Regional</option>
                        <option value="encarregado_sub_regional">Encarregado Sub-Regional</option>
                        <option value="encarregado_comum">Encarregado de Comum</option>
                    </select>
                </div>
                <div class="form-group" id="divContextoUsuario" style="display: none;">
                    <label>Contexto (Atribuição):</label>
                    <select id="novoUsuarioContexto">
                        <option value="">Selecione o tipo primeiro...</option>
                    </select>
                    <small style="color: #666;">Regional, Sub-Regional ou Comum que o usuário gerenciará</small>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="novoUsuarioEmail" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="tel" id="novoUsuarioTelefone" placeholder="(11) 98765-4321">
                </div>
                <div class="form-group">
                    <label>Senha Inicial:</label>
                    <input type="password" id="novoUsuarioSenha" placeholder="Deixe vazio para usar 'senha123'">
                    <small style="color: #666;">O usuário poderá alterar depois no login</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">✅ Criar Usuário</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalNovoUsuario()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Editar Comum -->
    <div id="modalEditarComum" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 style="margin: 0;">✏️ Editar Comum</h2>
                <button class="modal-close" onclick="fecharModalEditarComum()">✕</button>
            </div>
            
            <!-- Informações do Comum -->
            <div id="editComumInfoBox" style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none;">
                <h3 style="margin: 0 0 10px 0; color: #1e40af; font-size: 1em;">📊 Dados Cadastrados</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 0.85em; color: #666;">👥 Organistas</div>
                        <div id="editComumOrganistasCount" style="font-size: 1.5em; font-weight: bold; color: #1e40af;">-</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 0.85em; color: #666;">📅 Escalas Ativas</div>
                        <div id="editComumEscalasCount" style="font-size: 1.5em; font-weight: bold; color: #1e40af;">-</div>
                    </div>
                </div>
                <div id="editComumOrganistasLista" style="margin-top: 10px; max-height: 100px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; font-size: 0.85em; display: none;"></div>
            </div>
            
            <form onsubmit="salvarEdicaoComum(event)">
                <input type="hidden" id="editComumRegionalId">
                <input type="hidden" id="editComumSubRegionalId">
                <input type="hidden" id="editComumId">
                
                <div class="form-group">
                    <label>Nome do Comum:</label>
                    <input type="text" id="editComumNome" required placeholder="Ex: Vila Paula">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e5e7eb;">
                
                <h3 style="margin-bottom: 15px;">📅 Configuração de Dias e Horários</h3>
                
                <div class="form-group">
                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block;">Dias de culto e horários:</label>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
                        <div style="display: grid; gap: 12px;" id="editDiasHorariosContainer">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                            <small style="color: #1e40af; font-size: 0.9em;">
                                💡 <strong>Dica:</strong> Marque/desmarque os dias e ajuste os horários conforme necessário.<br>
                                Formato: <code style="background: white; padding: 2px 6px; border-radius: 3px;">HH:MM</code>, separados por vírgula.
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>⏱️ Fechamento de Publicação:</label>
                    <select id="editComumFechamentoDias">
                        <option value="3">3 dias antes</option>
                        <option value="5">5 dias antes</option>
                        <option value="7">7 dias antes (padrão)</option>
                        <option value="10">10 dias antes</option>
                        <option value="15">15 dias antes</option>
                    </select>
                    <small style="color: #666;">Prazo para organistas marcarem indisponibilidade</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">✅ Salvar Alterações</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalEditarComum()">❌ Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <script>
        // ==================== Dark Mode ====================
        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            
            // Salvar preferência no localStorage
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            
            // Atualizar ícone e texto
            const icon = document.getElementById('dark-mode-icon');
            const text = document.getElementById('dark-mode-text');
            
            if (isDark) {
                icon.textContent = '☀️';
                text.textContent = 'Claro';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'Escuro';
            }
        }
        
        // Carregar preferência salva ao carregar a página
        window.addEventListener('DOMContentLoaded', function() {
            const darkMode = localStorage.getItem('darkMode');
            
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').textContent = '☀️';
                document.getElementById('dark-mode-text').textContent = 'Claro';
            }
        });
        
        // ==================== Variáveis Globais ====================
        const currentUserId = '{{ user.id }}';
        const isAdmin = {{ 'true' if user.is_admin else 'false' }};
        const userTipo = '{{ user.tipo if user.tipo else "organista" }}';
        // Compatibilidade
        const isCoord = isAdmin;
        let organistas = [];
        let indisponibilidades = [];
        
        // Debug: Informações do usuário
        console.log('👤 DEBUG USUÁRIO:');
        console.log('  ID:', '{{ user.id }}');
        console.log('  Nome:', '{{ user.nome }}');
        console.log('  Tipo:', '{{ user.tipo }}');
        console.log('  Contexto ID:', '{{ user.contexto_id }}');
        console.log('  Is Master:', {{ 'true' if user.is_master else 'false' }});
        
        // ==================== Gerenciamento de Contexto ====================
        let contextoAtual = {
            regional: null,
            sub_regional: null,
            comum: null,
            nivel: '{{ user.tipo if user.tipo else "organista" }}'
        };
        
        // Carregar contexto atual do usuário
        async function carregarContextoAtual() {
            try {
                const response = await fetch('/api/contexto/atual');
                const data = await response.json();
                
                contextoAtual = {
                    regional: data.regional,
                    sub_regional: data.sub_regional,
                    comum: data.comum,
                    nivel: data.nivel
                };
                
                // Atualizar título do header
                document.querySelector('.header h1').textContent = `🎹 Rodízio de Organistas - ${data.comum.nome}`;
                
                // Atualizar título do card do dashboard
                const dashboardTitle = document.getElementById('dashboardComumTitle');
                if (dashboardTitle) {
                    dashboardTitle.textContent = `🎹 Rodízio de Organistas - ${data.comum.nome}`;
                }
                
                // Atualizar período
                const config = data.comum.config || {};
                const periodo = config.periodo || config.bimestre || {};
                if (periodo.inicio && periodo.fim) {
                    const dataInicio = new Date(periodo.inicio + 'T00:00:00').toLocaleDateString('pt-BR');
                    const dataFim = new Date(periodo.fim + 'T00:00:00').toLocaleDateString('pt-BR');
                    document.getElementById('periodo-info').textContent = `Período: ${dataInicio} até ${dataFim}`;
                } else {
                    document.getElementById('periodo-info').textContent = 'Período: Não configurado';
                }
                
                // Se for master, mostrar seletor de contexto
                if (data.nivel === 'master') {
                    document.getElementById('contexto-selector').style.display = 'flex';
                    await inicializarSeletorContexto();
                } else {
                    // Para outros níveis, esconder seletor
                    document.getElementById('contexto-selector').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Erro ao carregar contexto:', error);
            }
        }
        
        // Inicializar seletor de contexto (apenas para Master)
        async function inicializarSeletorContexto() {
            try {
                // Carregar regionais
                const response = await fetch('/api/regionais');
                const regionais = await response.json();
                
                const selectRegional = document.getElementById('selectRegional');
                selectRegional.innerHTML = '<option value="">Selecione Regional...</option>';
                
                regionais.forEach(regional => {
                    const option = document.createElement('option');
                    option.value = regional.id;
                    option.textContent = regional.nome;
                    if (contextoAtual.regional && regional.id === contextoAtual.regional.id) {
                        option.selected = true;
                    }
                    selectRegional.appendChild(option);
                });
                
                // Se já tem regional selecionada, carregar sub-regionais
                if (contextoAtual.regional) {
                    await carregarSubRegionais();
                }
            } catch (error) {
                console.error('Erro ao inicializar seletor:', error);
            }
        }
        
        // Carregar sub-regionais quando seleciona uma regional
        async function carregarSubRegionais() {
            const regionalId = document.getElementById('selectRegional').value;
            if (!regionalId) {
                document.getElementById('selectSubRegional').innerHTML = '<option value="">Selecione Regional primeiro</option>';
                document.getElementById('selectComum').innerHTML = '<option value="">Selecione...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais`);
                const subRegionais = await response.json();
                
                const selectSubRegional = document.getElementById('selectSubRegional');
                selectSubRegional.innerHTML = '<option value="">Selecione Sub-Regional...</option>';
                
                subRegionais.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = sub.nome;
                    if (contextoAtual.sub_regional && sub.id === contextoAtual.sub_regional.id) {
                        option.selected = true;
                    }
                    selectSubRegional.appendChild(option);
                });
                
                // Se já tem sub-regional selecionada, carregar comuns
                if (contextoAtual.sub_regional) {
                    await carregarComuns();
                }
            } catch (error) {
                console.error('Erro ao carregar sub-regionais:', error);
            }
        }
        
        // Carregar comuns quando seleciona uma sub-regional
        async function carregarComuns() {
            const regionalId = document.getElementById('selectRegional').value;
            const subRegionalId = document.getElementById('selectSubRegional').value;
            
            if (!regionalId || !subRegionalId) {
                document.getElementById('selectComum').innerHTML = '<option value="">Selecione Sub-Regional primeiro</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subRegionalId}/comuns`);
                const comuns = await response.json();
                
                const selectComum = document.getElementById('selectComum');
                selectComum.innerHTML = '<option value="">Selecione Comum...</option>';
                
                comuns.forEach(comum => {
                    const option = document.createElement('option');
                    option.value = comum.id;
                    option.textContent = comum.nome;
                    if (contextoAtual.comum && comum.id === contextoAtual.comum.id) {
                        option.selected = true;
                    }
                    selectComum.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar comuns:', error);
            }
        }
        
        // Selecionar novo contexto
        async function selecionarContexto() {
            const regionalId = document.getElementById('selectRegional').value;
            const subRegionalId = document.getElementById('selectSubRegional').value;
            const comumId = document.getElementById('selectComum').value;
            
            if (!regionalId || !subRegionalId || !comumId) {
                return;
            }
            
            try {
                const response = await fetch('/api/contexto/selecionar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        regional_id: regionalId,
                        sub_regional_id: subRegionalId,
                        comum_id: comumId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Contexto alterado com sucesso para:', data.contexto.comum_nome);
                    
                    // Mostrar mensagem e recarregar página
                    showNotification(`Contexto alterado para: ${data.contexto.comum_nome}. Recarregando...`, 'success');
                    
                    // Recarregar página após 800ms para garantir que o backend salvou o contexto
                    console.log('🔄 Recarregando página em 800ms...');
                    setTimeout(() => {
                        console.log('🔄 Executando reload agora...');
                        window.location.reload(true); // true força reload do servidor
                    }, 800);
                } else {
                    showNotification('Erro ao alterar contexto', 'error');
                }
            } catch (error) {
                console.error('Erro ao selecionar contexto:', error);
                showNotification('Erro ao selecionar contexto', 'error');
            }
        }
        
        // ==================== Navegação entre tabs ====================
        
        // Controlar dropdowns
        function toggleDropdown(menuId) {
            event.stopPropagation();
            
            const menu = document.getElementById(menuId);
            const toggle = event.currentTarget;
            
            // Fechar todos os outros dropdowns
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
            
            document.querySelectorAll('.nav-dropdown-toggle').forEach(t => {
                if (t !== toggle) {
                    t.classList.remove('open');
                }
            });
            
            // Toggle do menu atual
            menu.classList.toggle('show');
            toggle.classList.toggle('open');
        }
        
        // Fechar dropdowns ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                document.querySelectorAll('.nav-dropdown-toggle').forEach(toggle => {
                    toggle.classList.remove('open');
                });
            }
        });
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-dropdown-toggle').forEach(toggle => {
                toggle.classList.remove('active');
            });
            document.querySelectorAll('.nav-dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Ativar a tab
            document.getElementById(tabName).classList.add('active');
            
            // Ativar o item do menu que foi clicado
            if (event && event.target) {
                if (event.target.classList.contains('nav-dropdown-item')) {
                    event.target.classList.add('active');
                    // Ativar também o dropdown toggle pai
                    const dropdown = event.target.closest('.nav-dropdown');
                    if (dropdown) {
                        dropdown.querySelector('.nav-dropdown-toggle').classList.add('active');
                    }
                } else if (event.target.classList.contains('nav-tab')) {
                    event.target.classList.add('active');
                }
            }
            
            // Fechar dropdown após selecionar
            document.querySelectorAll('.nav-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            document.querySelectorAll('.nav-dropdown-toggle').forEach(toggle => {
                toggle.classList.remove('open');
            });
            
            // Carregar dados específicos de cada aba
            if (tabName === 'indisponibilidades') {
                loadIndisponibilidades();
            } else if (tabName === 'admin-indisp') {
                loadAdminIndisp();
            } else if (tabName === 'organistas') {
                loadOrganistas();
                carregarComunsParaOrganista();
                carregarDiasDoComum();
            } else if (tabName === 'rjm') {
                loadEscalaRJM();
            } else if (tabName === 'hierarquia') {
                carregarHierarquia();
            } else if (tabName === 'usuarios') {
                carregarUsuarios();
                carregarConfigComum();
            }
        }
        
        // Trocar Senha
        function trocarSenha() {
            window.location.href = '/trocar-senha';
        }
        
        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                window.location.href = '/logout';
            }
        }
        
        // Mostrar notificação
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // Carregar organistas
        async function loadOrganistas() {
            try {
                const response = await fetch('/organistas');
                organistas = await response.json();
                
                // Atualizar tabela
                const tbody = document.getElementById('tbodyOrganistas');
                tbody.innerHTML = '';
                
                if (!isCoord) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Apenas coordenador pode gerenciar organistas.</td></tr>';
                    return;
                }
                
                organistas.forEach(org => {
                    const tr = document.createElement('tr');
                    const emailDisplay = org.email ? org.email : '<span style="color: #999;">-</span>';
                    const telefoneDisplay = org.telefone ? org.telefone : '<span style="color: #999;">-</span>';
                    
                    tr.innerHTML = `
                        <td>${org.nome}</td>
                        <td>${emailDisplay}</td>
                        <td>${telefoneDisplay}</td>
                        <td>${org.tipos.join(', ')}</td>
                        <td>${org.dias_permitidos.join(', ')}</td>
                        <td>
                            <button class="btn" style="background: #3b82f6; color: white; margin-right: 5px;" onclick="editarOrganista('${org.id}')">✏️ Editar</button>
                            <button class="btn btn-danger" onclick="deleteOrganista('${org.id}')">🗑️ Remover</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Atualizar dashboard
                document.getElementById('statusOrganistas').textContent = 
                    `✅ ${organistas.length} organista(s) cadastrado(s)`;
                    
                // Atualizar contador de indisponibilidades
                loadIndispCount();
            } catch (error) {
                console.error('Erro ao carregar organistas:', error);
            }
        }
        
        // Carregar contagem de indisponibilidades
        async function loadIndispCount() {
            try {
                const response = await fetch('/indisponibilidades');
                const indisp = await response.json();
                document.getElementById('statusIndisponibilidades').textContent = 
                    `✅ ${indisp.length} indisponibilidade(s) marcada(s)`;
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Renderizar escala atual no dashboard
        async function renderEscalaAtual() {
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                console.log('Dados recebidos da API:', data);
                const escala = data.escala || [];
                console.log('Escala extraída:', escala);
                
                const container = document.getElementById('escalaAtual');
                
                if (!escala || escala.length === 0) {
                    container.innerHTML = '<div class="no-escala">Nenhuma escala cadastrada ainda</div>';
                    document.getElementById('statusEscala').textContent = '⚠️ Nenhuma escala cadastrada';
                    return;
                }
                
                // Pegar data atual para comparação
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Filtrar e ordenar: pegar próximos 20 eventos a partir de hoje
                const proximasEscalas = escala
                    .filter(item => {
                        const dataEscala = new Date(item.data);
                        return dataEscala >= hoje;
                    })
                    .sort((a, b) => new Date(a.data) - new Date(b.data))
                    .slice(0, 20);
                
                if (proximasEscalas.length === 0) {
                    container.innerHTML = '<div class="no-escala">Todas as escalas já passaram</div>';
                    document.getElementById('statusEscala').textContent = '✅ Todas as escalas já passaram';
                    return;
                }
                
                // Renderizar as próximas escalas
                container.innerHTML = proximasEscalas.map(item => {
                    const data = new Date(item.data);
                    const dataEscala = new Date(item.data);
                    const passado = dataEscala < hoje;
                    
                    const dia = data.getDate();
                    const nomeMes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][data.getMonth()];
                    const ano = data.getFullYear();
                    
                    // Mapear corretamente todos os dias da semana
                    const diasSemanaMap = {
                        'Sunday': 'Domingo',
                        'Monday': 'Segunda',
                        'Tuesday': 'Terça',
                        'Wednesday': 'Quarta',
                        'Thursday': 'Quinta',
                        'Friday': 'Sexta',
                        'Saturday': 'Sábado'
                    };
                    const diaSemana = diasSemanaMap[item.dia_semana] || item.dia_semana;
                    
                    // Map day of week to CSS class
                    const tipoDiaMap = {
                        'Sunday': 'domingo',
                        'Monday': 'segunda',
                        'Tuesday': 'terca',
                        'Wednesday': 'quarta',
                        'Thursday': 'quinta',
                        'Friday': 'sexta',
                        'Saturday': 'sabado'
                    };
                    const tipoDia = tipoDiaMap[item.dia_semana] || '';
                    const emoji = diaSemana === 'Domingo' ? '🙏' : '📖';
                    
                    return `
                        <div class="escala-item ${tipoDia} ${passado ? 'passado' : ''}">
                            <div class="escala-date-box">
                                <div class="escala-dia-numero">${dia}</div>
                                <div class="escala-dia-semana">${emoji} ${diaSemana}</div>
                                <div class="escala-mes-ano">${nomeMes} ${ano}</div>
                            </div>
                            
                            <div class="escala-divider"></div>
                            
                            <div class="escala-servicos">
                                <div class="escala-servico">
                                    <div class="escala-servico-icon">⏰</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Meia-hora</div>
                                        <div class="escala-organista ${!item.meia_hora ? 'escala-vazio' : ''}">
                                            ${item.meia_hora || 'Não definido'}
                                        </div>
                                    </div>
                                </div>
                                <div class="escala-servico">
                                    <div class="escala-servico-icon">🎹</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Culto</div>
                                        <div class="escala-organista ${!item.culto ? 'escala-vazio' : ''}">
                                            ${item.culto || 'Não definido'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('statusEscala').textContent = 
                    `✅ ${escala.length} escala(s) cadastrada(s)`;
                    
            } catch (error) {
                console.error('Erro ao renderizar escala atual:', error);
                document.getElementById('escalaAtual').innerHTML = 
                    '<div class="no-escala">Erro ao carregar escala</div>';
            }
        }
        
        // Renderizar apenas os dias do organista logado
        async function renderMeusDias() {
            if (isAdmin) return; // Admin não precisa desta função
            
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escala = data.escala || [];
                
                const container = document.getElementById('meusDias');
                
                if (!escala || escala.length === 0) {
                    container.innerHTML = '<div class="no-escala">Nenhuma escala cadastrada ainda</div>';
                    return;
                }
                
                // Pegar data atual para comparação
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Pegar o nome do usuário atual
                const nomeUsuario = '{{ user.nome }}';
                
                // Filtrar apenas os dias onde o usuário está escalado
                const meusDias = escala
                    .filter(item => {
                        const dataEscala = new Date(item.data);
                        // Mostrar apenas dias futuros ou de hoje
                        if (dataEscala < hoje) return false;
                        
                        // Verificar se o usuário está escalado (meia_hora ou culto)
                        return item.meia_hora === nomeUsuario || item.culto === nomeUsuario;
                    })
                    .sort((a, b) => new Date(a.data) - new Date(b.data));
                
                if (meusDias.length === 0) {
                    container.innerHTML = '<div class="no-escala">Você não está escalado(a) em nenhuma data próxima</div>';
                    return;
                }
                
                // Renderizar os dias do organista
                container.innerHTML = meusDias.map(item => {
                    const data = new Date(item.data);
                    const dia = data.getDate();
                    const nomeMes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][data.getMonth()];
                    const ano = data.getFullYear();
                    
                    // Mapear corretamente todos os dias da semana
                    const diasSemanaMap = {
                        'Sunday': 'Domingo',
                        'Monday': 'Segunda',
                        'Tuesday': 'Terça',
                        'Wednesday': 'Quarta',
                        'Thursday': 'Quinta',
                        'Friday': 'Sexta',
                        'Saturday': 'Sábado'
                    };
                    const diaSemana = diasSemanaMap[item.dia_semana] || item.dia_semana;
                    
                    // Map day of week to CSS class
                    const tipoDiaMap = {
                        'Sunday': 'domingo',
                        'Monday': 'segunda',
                        'Tuesday': 'terca',
                        'Wednesday': 'quarta',
                        'Thursday': 'quinta',
                        'Friday': 'sexta',
                        'Saturday': 'sabado'
                    };
                    const tipoDia = tipoDiaMap[item.dia_semana] || '';
                    const emoji = diaSemana === 'Domingo' ? '🙏' : '📖';
                    
                    // Verificar em qual serviço o organista está
                    const isMeiaHora = item.meia_hora === nomeUsuario;
                    const isCulto = item.culto === nomeUsuario;
                    
                    // Preparar lista de serviços para passar para a função
                    const servicos = [];
                    if (isMeiaHora) servicos.push('meia_hora');
                    if (isCulto) servicos.push('culto');
                    const servicosStr = JSON.stringify(servicos).replace(/"/g, '&quot;');
                    
                    return `
                        <div class="escala-item ${tipoDia}">
                            <div class="escala-date-box">
                                <div class="escala-dia-numero">${dia}</div>
                                <div class="escala-dia-semana">${emoji} ${diaSemana}</div>
                                <div class="escala-mes-ano">${nomeMes} ${ano}</div>
                            </div>
                            
                            <div class="escala-divider"></div>
                            
                            <div class="escala-servicos">
                                ${isMeiaHora ? `
                                <div class="escala-servico" style="background: rgba(16, 185, 129, 0.15); border-left-color: #10b981; border-left-width: 4px;">
                                    <div class="escala-servico-icon">⏰</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Meia-hora</div>
                                        <div class="escala-organista" style="color: #10b981; font-weight: bold;">✓ Você</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${isCulto ? `
                                <div class="escala-servico" style="background: rgba(16, 185, 129, 0.15); border-left-color: #10b981; border-left-width: 4px;">
                                    <div class="escala-servico-icon">🎹</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Culto</div>
                                        <div class="escala-organista" style="color: #10b981; font-weight: bold;">✓ Você</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <button onclick="adicionarAgenda('${item.data}', '${item.dia_semana}', ${servicosStr})" 
                                        class="btn-adicionar-agenda"
                                        style="margin-top: 10px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    📅 Adicionar à Agenda
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                    
            } catch (error) {
                console.error('Erro ao renderizar meus dias:', error);
                document.getElementById('meusDias').innerHTML = 
                    '<div class="no-escala">Erro ao carregar seus dias</div>';
            }
        }
        // Carregar lista de comuns para seletor de organistas
        async function carregarComunsParaOrganista() {
            console.log('🔄 carregarComunsParaOrganista() chamada');
            
            const selectComum = document.getElementById('orgComumId');
            console.log('  📋 selectComum encontrado:', selectComum !== null);
            
            if (!selectComum) {
                console.log('⚠️ Campo orgComumId não encontrado - usuário não é Master ou Encarregado');
                return;
            }
            
            // Se for encarregado de comum, carregar apenas sua comum
            const hiddenComumId = document.getElementById('orgComumIdHidden');
            console.log('  📋 hiddenComumId encontrado:', hiddenComumId !== null);
            console.log('  📋 hiddenComumId.value:', hiddenComumId ? hiddenComumId.value : 'N/A');
            
            if (hiddenComumId && hiddenComumId.value) {
                console.log('👤 Usuário é Encarregado de Comum, carregando contexto específico...');
                await carregarComumDoEncarregado(hiddenComumId.value);
                return;
            }
            
            console.log('🔄 Iniciando carregamento de comuns (Master)...');
            selectComum.innerHTML = '<option value="">⏳ Carregando comuns...</option>';
            selectComum.disabled = true;
            
            try {
                const response = await fetch('/api/regionais');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const regionais = await response.json();
                console.log('✅ Regionais carregadas:', regionais.length, regionais);
                
                if (!Array.isArray(regionais) || regionais.length === 0) {
                    selectComum.innerHTML = '<option value="">❌ Nenhuma regional encontrada</option>';
                    console.warn('⚠️ Array de regionais vazio ou inválido');
                    return;
                }
                
                selectComum.innerHTML = '<option value="">Selecione o comum...</option>';
                let totalComuns = 0;
                
                for (const regional of regionais) {
                    console.log(`📍 Processando regional: ${regional.nome} (${regional.id})`);
                    
                    try {
                        const subResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais`);
                        if (!subResponse.ok) {
                            throw new Error(`HTTP ${subResponse.status}`);
                        }
                        const subRegionais = await subResponse.json();
                        console.log(`  ✅ Sub-regionais: ${subRegionais.length}`, subRegionais);
                        
                        for (const sub of subRegionais) {
                            console.log(`    📍 Processando sub-regional: ${sub.nome} (${sub.id})`);
                            
                            try {
                                const comunsResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais/${sub.id}/comuns`);
                                if (!comunsResponse.ok) {
                                    throw new Error(`HTTP ${comunsResponse.status}`);
                                }
                                const comuns = await comunsResponse.json();
                                console.log(`      ✅ Comuns: ${comuns.length}`, comuns);
                                
                                for (const comum of comuns) {
                                    const option = document.createElement('option');
                                    option.value = comum.id;
                                    option.textContent = `${regional.nome} › ${sub.nome} › ${comum.nome}`;
                                    selectComum.appendChild(option);
                                    totalComuns++;
                                    console.log(`        ✅ Adicionado: ${comum.nome} (ID: ${comum.id})`);
                                }
                            } catch (error) {
                                console.error(`      ❌ Erro ao carregar comuns de ${sub.nome}:`, error);
                            }
                        }
                    } catch (error) {
                        console.error(`  ❌ Erro ao carregar sub-regionais de ${regional.nome}:`, error);
                    }
                }
                
                console.log(`🎉 Total de comuns carregados: ${totalComuns}`);
                
                if (totalComuns === 0) {
                    selectComum.innerHTML = '<option value="">❌ Nenhum comum encontrado</option>';
                    console.warn('⚠️ Nenhum comum foi carregado. Verifique se existem comuns cadastrados.');
                } else {
                    selectComum.disabled = false;
                    console.log(`✅ Seletor habilitado com ${totalComuns} comuns`);
                }
                
            } catch (error) {
                console.error('❌ ERRO CRÍTICO ao carregar comuns:', error);
                selectComum.innerHTML = '<option value="">❌ Erro ao carregar - veja console</option>';
                selectComum.disabled = false;
            }
        }
        
        // Carregar comum específica para encarregado
        async function carregarComumDoEncarregado(comumId) {
            const selectComum = document.getElementById('orgComumId');
            selectComum.innerHTML = '<option value="">⏳ Carregando sua comum...</option>';
            selectComum.disabled = true;
            
            try {
                console.log(`🔍 Encarregado de Comum detectado`);
                console.log(`🔑 contexto_id: "${comumId}"`);
                console.log(`📡 Buscando dados da comum...`);
                
                // Buscar em todas as regionais para encontrar a comum
                const response = await fetch('/api/regionais');
                if (!response.ok) {
                    throw new Error(`Erro ao buscar regionais: HTTP ${response.status}`);
                }
                const regionais = await response.json();
                console.log(`✅ Regionais recebidas:`, regionais);
                
                let comumEncontrada = null;
                let hierarquia = null;
                
                // Buscar a comum na hierarquia
                for (const regional of regionais) {
                    console.log(`🔎 Procurando em regional: ${regional.nome} (${regional.id})`);
                    
                    const subResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais`);
                    if (!subResponse.ok) {
                        console.warn(`⚠️ Erro ao buscar sub-regionais de ${regional.id}`);
                        continue;
                    }
                    const subRegionais = await subResponse.json();
                    console.log(`  ✅ Sub-regionais:`, subRegionais);
                    
                    for (const sub of subRegionais) {
                        console.log(`  🔎 Procurando em sub-regional: ${sub.nome} (${sub.id})`);
                        
                        const comunsResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais/${sub.id}/comuns`);
                        if (!comunsResponse.ok) {
                            console.warn(`    ⚠️ Erro ao buscar comuns de ${sub.id}`);
                            continue;
                        }
                        const comuns = await comunsResponse.json();
                        console.log(`    ✅ Comuns encontradas:`, comuns);
                        
                        // Comparar IDs
                        console.log(`    🔍 Procurando comum com ID: "${comumId}"`);
                        const comum = comuns.find(c => {
                            console.log(`      🔸 Comparando: "${c.id}" === "${comumId}" = ${c.id === comumId}`);
                            return c.id === comumId;
                        });
                        
                        if (comum) {
                            console.log(`    🎯 COMUM ENCONTRADA!`, comum);
                            comumEncontrada = comum;
                            hierarquia = {
                                regional: regional.nome,
                                subRegional: sub.nome
                            };
                            break;
                        }
                    }
                    if (comumEncontrada) break;
                }
                
                if (comumEncontrada && hierarquia) {
                    const textoCompleto = `${hierarquia.regional} › ${hierarquia.subRegional} › ${comumEncontrada.nome}`;
                    selectComum.innerHTML = `<option value="${comumId}" selected>${textoCompleto}</option>`;
                    selectComum.disabled = true; // Mantém desabilitado para encarregados
                    console.log(`✅ Select preenchido com: "${textoCompleto}"`);
                    console.log(`🎉 Comum carregada com sucesso!`);
                    
                    // Carregar dias da comum automaticamente
                    await carregarDiasDoComum();
                } else {
                    console.error(`❌ Comum "${comumId}" NÃO ENCONTRADA na hierarquia!`);
                    console.warn(`💡 Possíveis causas:`);
                    console.warn(`   1. ID errado no user.contexto_id`);
                    console.warn(`   2. Comum não cadastrada no banco`);
                    console.warn(`   3. Problema na estrutura hierárquica`);
                    
                    // Mesmo assim, usar o ID para permitir cadastro
                    selectComum.innerHTML = `<option value="${comumId}" selected>Sua Comum (${comumId})</option>`;
                    selectComum.disabled = true;
                }
                
            } catch (error) {
                console.error('❌ ERRO CRÍTICO ao carregar comum do encarregado:');
                console.error(error);
                selectComum.innerHTML = `<option value="${comumId}" selected>Sua Comum (${comumId})</option>`;
                selectComum.disabled = true;
                showAlert('alertOrganista', `Aviso: Não foi possível carregar o nome completo da sua comum. O sistema usará automaticamente a comum "${comumId}". Entre em contato com o administrador se o problema persistir.`, 'warning');
            }
        }
        
        // Carregar dias do comum selecionado e atualizar contexto para Master
        async function carregarDiasDoComum() {
            // Se for Master, também atualizar o contexto do dashboard
            if (userTipo === 'master') {
                const selectComum = document.getElementById('orgComumId');
                if (selectComum && selectComum.value) {
                    console.log('🔄 Master: atualizando contexto do dashboard para comum:', selectComum.value);
                    await atualizarContextoMaster(selectComum.value);
                }
            }
            
            // Continuar com carregamento normal dos dias
            await carregarDiasDoComumInterno();
        }
        
        // Atualizar contexto do Master no backend
        async function atualizarContextoMaster(comumId) {
            try {
                // Buscar informações completas da comum
                const db = await fetch('/api/regionais').then(r => r.json());
                
                let regional_id, sub_regional_id;
                for (const regional of db) {
                    for (const subRegional of regional.sub_regionais || []) {
                        const comum = (subRegional.comuns || []).find(c => c.id === comumId);
                        if (comum) {
                            regional_id = regional.id;
                            sub_regional_id = subRegional.id;
                            break;
                        }
                    }
                    if (regional_id) break;
                }
                
                if (regional_id && sub_regional_id) {
                    // Atualizar contexto no backend
                    const response = await fetch('/api/contexto/selecionar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ regional_id, sub_regional_id, comum_id: comumId })
                    });
                    
                    if (response.ok) {
                        console.log('✅ Contexto atualizado no backend');
                        // Recarregar organistas e escala
                        await loadOrganistas();
                        await loadEscalaAtual();
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao atualizar contexto:', error);
            }
        }
        
        // Carregar dias do comum selecionado (lógica interna)
        async function carregarDiasDoComumInterno() {
            const selectComum = document.getElementById('orgComumId');
            const hiddenComumId = document.getElementById('orgComumIdHidden');
            const selectDias = document.getElementById('orgDias');
            
            // Pegar comum_id: primeiro do hidden (encarregado), depois do select (master), depois do contexto
            let comumId = null;
            if (hiddenComumId && hiddenComumId.value) {
                comumId = hiddenComumId.value;
                console.log('🔑 carregarDiasDoComum: usando comum_id do hidden:', comumId);
            } else if (selectComum && selectComum.value) {
                comumId = selectComum.value;
                console.log('🔑 carregarDiasDoComum: usando comum_id do select:', comumId);
            } else if (contextoAtual.comum && contextoAtual.comum.id) {
                comumId = contextoAtual.comum.id;
                console.log('🔑 carregarDiasDoComum: usando comum_id do contexto:', comumId);
            }
            
            if (!comumId) {
                console.warn('⚠️ carregarDiasDoComum: Nenhum comum_id disponível');
                selectDias.innerHTML = '<option value="">Selecione o comum primeiro</option>';
                return;
            }
            
            try {
                console.log(`📡 Buscando config da comum: /api/comuns/${comumId}/config`);
                const response = await fetch(`/api/comuns/${comumId}/config`);
                
                if (!response.ok) {
                    console.error(`❌ Erro HTTP ${response.status} ao buscar config da comum ${comumId}`);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const config = await response.json();
                console.log(`✅ Config recebida da comum ${comumId}:`, config);
                console.log(`  📅 Dias de culto:`, config.dias_culto);
                
                selectDias.innerHTML = '';
                
                if (config.dias_culto && config.dias_culto.length > 0) {
                    console.log(`✅ Carregando ${config.dias_culto.length} dias da config`);
                    config.dias_culto.forEach(dia => {
                        const option = document.createElement('option');
                        option.value = dia;
                        option.textContent = dia;
                        selectDias.appendChild(option);
                        console.log(`  ➕ Adicionado dia: ${dia}`);
                    });
                } else {
                    console.warn(`⚠️ Config sem dias_culto, usando fallback`);
                    // Fallback para dias padrão
                    ['Domingo', 'Terça'].forEach(dia => {
                        const option = document.createElement('option');
                        option.value = dia;
                        option.textContent = dia;
                        selectDias.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dias do comum:', error);
                // Fallback para dias padrão
                selectDias.innerHTML = '';
                ['Domingo', 'Terça'].forEach(dia => {
                    const option = document.createElement('option');
                    option.value = dia;
                    option.textContent = dia;
                    selectDias.appendChild(option);
                });
            }
        }
        
        // Adicionar organista
        async function addOrganista(event) {
            event.preventDefault();
            
            const selectComum = document.getElementById('orgComumId');
            const hiddenComumId = document.getElementById('orgComumIdHidden');
            
            // Pegar comum_id do select (Master) ou do hidden (Encarregado)
            let comumId = null;
            if (hiddenComumId && hiddenComumId.value) {
                comumId = hiddenComumId.value;
                console.log('🔑 Usando comum_id do encarregado:', comumId);
            } else if (selectComum) {
                comumId = selectComum.value;
                console.log('🔑 Usando comum_id selecionado:', comumId);
            }
            
            const payload = {
                id: document.getElementById('orgId').value,
                nome: document.getElementById('orgNome').value,
                email: document.getElementById('orgEmail').value || '',
                telefone: document.getElementById('orgTelefone').value || '',
                tipos: Array.from(document.getElementById('orgTipos').selectedOptions).map(o => o.value),
                dias_permitidos: Array.from(document.getElementById('orgDias').selectedOptions).map(o => o.value),
                regras_especiais: {}
            };
            
            // Adicionar comum_id ao payload
            if (selectComum || hiddenComumId) {
                if (!comumId) {
                    showAlert('alertOrganista', 'Selecione o comum onde a organista atuará', 'error');
                    return;
                }
                payload.comum_id = comumId;
            }
            
            try {
                const response = await fetch('/organistas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('alertOrganista', 'Organista adicionado com sucesso!', 'success');
                    document.getElementById('formOrganista').reset();
                    loadOrganistas();
                } else {
                    showAlert('alertOrganista', result.error, 'error');
                }
            } catch (error) {
                showAlert('alertOrganista', 'Erro ao adicionar organista.', 'error');
            }
        }
        
        // Remover organista
        // Editar organista
        function editarOrganista(id) {
            const organista = organistas.find(o => o.id === id);
            if (!organista) {
                alert('Organista não encontrado!');
                return;
            }
            
            // Preencher formulário
            document.getElementById('editOrgId').value = organista.id;
            document.getElementById('editOrgNome').value = organista.nome;
            document.getElementById('editOrgEmail').value = organista.email || '';
            document.getElementById('editOrgTelefone').value = organista.telefone || '';
            
            // Selecionar tipos
            const selectTipos = document.getElementById('editOrgTipos');
            Array.from(selectTipos.options).forEach(option => {
                option.selected = organista.tipos.includes(option.value);
            });
            
            // Selecionar dias
            const selectDias = document.getElementById('editOrgDias');
            Array.from(selectDias.options).forEach(option => {
                option.selected = organista.dias_permitidos.includes(option.value);
            });
            
            // Abrir modal
            document.getElementById('modalEditarOrganista').classList.add('active');
        }
        
        function fecharModalEditar() {
            document.getElementById('modalEditarOrganista').classList.remove('active');
            document.getElementById('formEditarOrganista').reset();
        }
        
        async function salvarEdicaoOrganista(event) {
            event.preventDefault();
            
            const id = document.getElementById('editOrgId').value;
            const nome = document.getElementById('editOrgNome').value;
            
            const selectTipos = document.getElementById('editOrgTipos');
            const tipos = Array.from(selectTipos.selectedOptions).map(opt => opt.value);
            
            const selectDias = document.getElementById('editOrgDias');
            const dias_permitidos = Array.from(selectDias.selectedOptions).map(opt => opt.value);
            
            if (tipos.length === 0) {
                alert('⚠️ Selecione pelo menos um tipo!');
                return;
            }
            
            if (dias_permitidos.length === 0) {
                alert('⚠️ Selecione pelo menos um dia permitido!');
                return;
            }
            
            const email = document.getElementById('editOrgEmail').value || '';
            const telefone = document.getElementById('editOrgTelefone').value || '';
            
            try {
                const response = await fetch(`/organistas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome,
                        email,
                        telefone,
                        tipos,
                        dias_permitidos
                    })
                });
                
                if (response.ok) {
                    alert('✅ Organista atualizada com sucesso!');
                    fecharModalEditar();
                    await loadOrganistas();
                } else {
                    const error = await response.json();
                    alert(`❌ Erro: ${error.error || 'Falha ao atualizar'}`);
                }
            } catch (error) {
                console.error('Erro ao atualizar organista:', error);
                alert('❌ Erro ao atualizar organista.');
            }
        }
        
        async function deleteOrganista(id) {
            if (!confirm('Deseja realmente remover este organista?')) return;
            
            try {
                const response = await fetch(`/organistas/${id}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (response.ok) {
                    loadOrganistas();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Erro ao remover organista.');
            }
        }
        
        // Carregar indisponibilidades
        async function loadIndisponibilidades() {
            if (isCoord) {
                document.getElementById('calendarioIndisp').innerHTML = 
                    '<div style="background: #dbeafe; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">' +
                    '<h3 style="color: #1e40af; margin-bottom: 10px;">ℹ️ Coordenador</h3>' +
                    '<p style="color: #1e3a8a;">Coordenadores visualizam todas as indisponibilidades na página de geração de escala. Para ver/editar indisponibilidades de uma organista específica, entre com a conta dela.</p>' +
                    '</div>';
                document.getElementById('chipsDatas').innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch('/indisponibilidades');
                indisponibilidades = await response.json();
                
                renderCalendar();
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Renderizar calendário simplificado
        function renderCalendar() {
            // Usar datas configuradas no período
            const inicio = new Date('{{ cfg.bimestre.inicio }}T00:00:00');
            const fim = new Date('{{ cfg.bimestre.fim }}T23:59:59');
            
            const calendar = document.getElementById('calendarioIndisp');
            
            const mesesNome = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            
            // Agrupar datas por mês (apenas domingos e terças)
            const datasOrganizadas = {};
            let current = new Date(inicio);
            
            while (current <= fim) {
                const dayOfWeek = current.getDay();
                
                // Apenas domingos (0) e terças (2)
                if (dayOfWeek === 0 || dayOfWeek === 2) {
                    const mesAno = `${current.getFullYear()}-${current.getMonth()}`;
                    
                    if (!datasOrganizadas[mesAno]) {
                        datasOrganizadas[mesAno] = {
                            mes: mesesNome[current.getMonth()],
                            ano: current.getFullYear(),
                            datas: []
                        };
                    }
                    
                    datasOrganizadas[mesAno].datas.push({
                        data: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        dia: current.getDate(),
                        diaSemana: diasSemana[dayOfWeek]
                    });
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            // Renderizar por mês em ordem cronológica
            let html = '<div style="margin-bottom: 20px;"><p style="color: #666; font-size: 0.95rem; margin-bottom: 20px;">📅 Clique nas datas abaixo para marcar/desmarcar sua indisponibilidade:</p>';
            
            // Ordenar os meses cronologicamente
            const mesesOrdenados = Object.keys(datasOrganizadas).sort((a, b) => {
                const [anoA, mesA] = a.split('-').map(Number);
                const [anoB, mesB] = b.split('-').map(Number);
                if (anoA !== anoB) return anoA - anoB;
                return mesA - mesB;
            });
            
            mesesOrdenados.forEach(mesAno => {
                const mesData = datasOrganizadas[mesAno];
                
                html += `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                        <h3 style="color: #1e293b; font-size: 1.5rem; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
                            ${mesData.mes} / ${mesData.ano}
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                `;
                
                mesData.datas.forEach(item => {
                    const isSelected = indisponibilidades.some(i => i.data === item.dateStr);
                    
                    html += `
                        <div onclick="toggleDate('${item.dateStr}')" 
                            style="padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;
                            background: ${isSelected ? '#ef4444' : '#10b981'}; 
                            color: white; 
                            font-weight: 500; 
                            transition: all 0.2s;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px;">
                                ${item.diaSemana}
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold;">
                                ${String(item.dia).padStart(2, '0')}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 5px; opacity: 0.9;">
                                ${isSelected ? '✓ Indisponível' : 'Disponível'}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            calendar.innerHTML = html;
            updateChips();
        }
        
        // Toggle data
        async function toggleDate(dateStr) {
            const exists = indisponibilidades.some(i => i.data === dateStr);
            
            if (exists) {
                // Remover
                try {
                    const response = await fetch(`/indisponibilidades/${currentUserId}/${dateStr}`, {method: 'DELETE'});
                    if (response.ok) {
                        indisponibilidades = indisponibilidades.filter(i => i.data !== dateStr);
                        renderCalendar();
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Erro ao remover indisponibilidade.');
                    }
                } catch (error) {
                    alert('Erro ao remover indisponibilidade.');
                }
            } else {
                // Adicionar
                const payload = {
                    data: dateStr,
                    motivo: 'Indisponível'
                };
                
                try {
                    const response = await fetch('/indisponibilidades', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        indisponibilidades.push({...payload, id: currentUserId});
                        renderCalendar();
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Erro ao adicionar indisponibilidade.');
                    }
                } catch (error) {
                    alert('Erro ao adicionar indisponibilidade.');
                }
            }
        }
        
        // Atualizar chips
        function updateChips() {
            const chips = document.getElementById('chipsDatas');
            
            if (indisponibilidades.length === 0) {
                chips.innerHTML = '<p style="color: #666;">Nenhuma indisponibilidade marcada.</p>';
                return;
            }
            
            let html = '<h3>Datas marcadas como indisponíveis:</h3><div style="margin-top: 10px;">';
            indisponibilidades.forEach(i => {
                const date = new Date(i.data + 'T00:00:00');
                html += `<span class="info-badge" style="background: #fee2e2; color: #991b1b;">
                    ${date.toLocaleDateString('pt-BR')}
                </span>`;
            });
            html += '</div>';
            chips.innerHTML = html;
        }
        
        // Carregar todas indisponibilidades (Admin)
        async function loadAdminIndisp() {
            if (!isAdmin) return;
            
            try {
                const response = await fetch('/admin/indisponibilidades/todas');
                const data = await response.json();
                
                const container = document.getElementById('adminIndispList');
                container.innerHTML = '';
                
                if (Object.keys(data).length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">Nenhuma indisponibilidade cadastrada ainda.</p>';
                    return;
                }
                
                for (const [orgId, info] of Object.entries(data)) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.background = '#EDE9FE';
                    card.style.marginBottom = '15px';
                    
                    let html = `<h3 style="color: #312E81; margin-bottom: 10px;">👤 ${info.nome}</h3>`;
                    
                    if (info.indisponibilidades.length === 0) {
                        html += '<p style="color: #666;">Nenhuma indisponibilidade marcada.</p>';
                    } else {
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                        info.indisponibilidades.forEach(indisp => {
                            const dataBR = indisp.data.split('-').reverse().join('/');
                            html += `
                                <div style="background: #fee2e2; color: #991b1b; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                                    <span>${dataBR}</span>
                                    <button onclick="deleteIndispAdmin('${orgId}', '${indisp.data}')" 
                                            style="background: #ef4444; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer;">
                                        ✕
                                    </button>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    card.innerHTML = html;
                    container.appendChild(card);
                }
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Deletar indisponibilidade (Admin)
        async function deleteIndispAdmin(orgId, data) {
            if (!confirm(`Remover indisponibilidade de ${data.split('-').reverse().join('/')}?`)) return;
            
            try {
                const response = await fetch(`/indisponibilidades/${orgId}/${data}`, {method: 'DELETE'});
                if (response.ok) {
                    loadAdminIndisp();
                } else {
                    alert('Erro ao remover indisponibilidade.');
                }
            } catch (error) {
                alert('Erro ao remover indisponibilidade.');
            }
        }
        
        // Salvar configurações (Admin)
        async function saveConfig(event) {
            event.preventDefault();
            
            const payload = {
                bimestre: {
                    inicio: document.getElementById('configInicio').value,
                    fim: document.getElementById('configFim').value
                },
                fechamento_publicacao_dias: parseInt(document.getElementById('configFechamento').value)
            };
            
            try {
                const response = await fetch('/admin/config', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showAlert('alertConfig', '✅ Configurações salvas com sucesso! Atualizando...', 'success');
                    // Aguardar 1 segundo e recarregar a página para atualizar todas as datas
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('alertConfig', 'Erro ao salvar configurações.', 'error');
                }
            } catch (error) {
                showAlert('alertConfig', 'Erro ao salvar configurações.', 'error');
            }
        }
        
        // Mostrar alerta
        function showAlert(id, message, type) {
            const alert = document.getElementById(id);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }
        
        // Inicialização
        window.onload = async function() {
            // Carregar contexto primeiro
            await carregarContextoAtual();
            
            loadOrganistas();
            
            // Carregar dashboard apropriado
            if (isAdmin) {
                renderEscalaAtual();
            } else {
                renderMeusDias();
            }
            
            // Carregar filtro de organistas para admin
            if (isAdmin) {
                fetch('/organistas').then(r => r.json()).then(orgs => {
                    const select = document.getElementById('filterOrganista');
                    orgs.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.nome;
                        select.appendChild(option);
                    });
                });
            }
        };

        // ============================================
        // FUNÇÕES PARA ESCALA (FASE 2)
        // ============================================
        
        async function criarEscalaVazia() {
            try {
                // Garantir que temos a lista de organistas
                try {
                    const response = await fetch('/organistas');
                    organistas = await response.json();
                    console.log('Organistas carregadas:', organistas.length);
                } catch (error) {
                    console.error('Erro ao carregar organistas:', error);
                    throw new Error('Não foi possível carregar a lista de organistas');
                }
                
                // Buscar configuração do período
                const configResponse = await fetch('/admin/config');
                const config = await configResponse.json();
                
                console.log('📅 Config recebida:', config);
                
                // Suportar tanto 'periodo' (nova estrutura) quanto 'bimestre' (antiga)
                const periodoConfig = config.periodo || config.bimestre;
                
                if (!periodoConfig || !periodoConfig.inicio || !periodoConfig.fim) {
                    throw new Error('Período não configurado. Configure o período da comum primeiro nas Configurações.');
                }
                
                const inicio = new Date(periodoConfig.inicio + 'T00:00:00');
                const fim = new Date(periodoConfig.fim + 'T00:00:00');
                
                // Mapear dias da semana em português para números
                const diasSemanaMap = {
                    'Domingo': 0,
                    'Segunda': 1,
                    'Terça': 2,
                    'Quarta': 3,
                    'Quinta': 4,
                    'Sexta': 5,
                    'Sábado': 6
                };
                
                // Mapear números para nomes em inglês (necessário para compatibilidade com renderização)
                const diasSemanaIngles = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                // Pegar dias de culto da config (ou usar padrão)
                const diasCulto = config.dias_culto || ['Domingo', 'Terça'];
                const diasCultoNumeros = diasCulto.map(dia => diasSemanaMap[dia]).filter(n => n !== undefined);
                
                console.log('📅 Dias de culto configurados:', diasCulto);
                console.log('📅 Números dos dias:', diasCultoNumeros);
                console.log('📅 Período:', periodoConfig.inicio, 'até', periodoConfig.fim);
                
                // Criar escala vazia com os dias de culto configurados
                const escala = [];
                let current = new Date(inicio);
                
                while (current <= fim) {
                    const dayOfWeek = current.getDay();
                    
                    // Verificar se é um dia de culto
                    if (diasCultoNumeros.includes(dayOfWeek)) {
                        escala.push({
                            data: current.toISOString().split('T')[0],
                            dia_semana: diasSemanaIngles[dayOfWeek],  // CORRIGIDO: usar nome em inglês
                            meia_hora: null,
                            culto: null
                        });
                    }
                    
                    current.setDate(current.getDate() + 1);
                }
                
                console.log(`✅ Escala criada com ${escala.length} dias`);
                
                // Publicar escala vazia
                const response = await fetch('/escala/publicar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ escala: escala })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao criar escala');
                }

                showAlertEscala('✅ Escala criada! Agora preencha manualmente os organistas.', 'success');
                await loadEscalaAtual();
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        async function loadEscalaAtual() {
            try {
                // Carregar organistas
                try {
                    const orgResponse = await fetch('/organistas');
                    organistas = await orgResponse.json();
                    console.log('Organistas carregadas para escala:', organistas.length);
                } catch (error) {
                    console.error('Erro ao carregar organistas:', error);
                }
                
                // Carregar indisponibilidades
                try {
                    const indispResponse = await fetch('/indisponibilidades');
                    indisponibilidades = await indispResponse.json();
                    console.log('Indisponibilidades carregadas:', indisponibilidades.length);
                } catch (error) {
                    console.error('Erro ao carregar indisponibilidades:', error);
                }
                
                const response = await fetch('/escala/atual');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || error.error || 'Erro ao carregar escala');
                }

                const data = await response.json();
                
                if (data.escala && data.escala.length > 0) {
                    renderEscala(data.escala);
                    renderEstatisticas(data.estatisticas);
                    showAlertEscala('Escala atual carregada.', 'success');
                } else {
                    showAlertEscala('Nenhuma escala publicada ainda.', 'info');
                    document.getElementById('escalaContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala publicada ainda.</p>
                            ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Nova Escala" acima para começar.</p>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        // Deletar Escala Atual
        async function deletarEscalaAtual() {
            try {
                // Buscar escala atual para mostrar informações
                const response = await fetch('/escala/atual');
                const data = await response.json();
                
                if (!data.escala || data.escala.length === 0) {
                    alert('⚠️ Não há escala cadastrada para deletar.');
                    return;
                }
                
                const escala = data.escala;
                
                // Contar informações
                const totalDatas = escala.length;
                const organistasUnicos = [...new Set(escala.flatMap(item => [
                    item.meia_hora?.nome,
                    item.culto?.nome
                ].filter(Boolean)))];
                
                // Agrupar por mês
                const datas = escala.map(item => new Date(item.data));
                const dataInicio = new Date(Math.min(...datas));
                const dataFim = new Date(Math.max(...datas));
                
                const mesesNome = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const mesInicio = mesesNome[dataInicio.getMonth()];
                const mesFim = mesesNome[dataFim.getMonth()];
                const anoInicio = dataInicio.getFullYear();
                const anoFim = dataFim.getFullYear();
                
                const periodoTexto = anoInicio === anoFim 
                    ? `${mesInicio} a ${mesFim}/${anoInicio}`
                    : `${mesInicio}/${anoInicio} a ${mesFim}/${anoFim}`;
                
                // Montar mensagem
                let mensagem = `🗑️ DELETAR ESCALA DE CULTO OFICIAL\n\n`;
                mensagem += `📊 Informações da Escala:\n`;
                mensagem += `📅 Período: ${periodoTexto}\n`;
                mensagem += `📆 Total de datas: ${totalDatas}\n`;
                mensagem += `👥 Organistas envolvidos: ${organistasUnicos.length}\n\n`;
                
                if (organistasUnicos.length > 0) {
                    mensagem += `Organistas:\n`;
                    organistasUnicos.slice(0, 8).forEach(org => {
                        mensagem += `  • ${org}\n`;
                    });
                    if (organistasUnicos.length > 8) {
                        mensagem += `  ... e mais ${organistasUnicos.length - 8} organista(s)\n`;
                    }
                    mensagem += `\n`;
                }
                
                mensagem += `⚠️ ATENÇÃO: Esta ação NÃO pode ser desfeita!\n\n`;
                mensagem += `Todos os dados desta escala serão PERMANENTEMENTE removidos.\n\n`;
                mensagem += `Deseja realmente deletar esta escala?`;
                
                if (!confirm(mensagem)) {
                    return;
                }
                
                // Confirmar novamente
                const confirmacao = confirm('⚠️ ÚLTIMA CONFIRMAÇÃO\n\nTem CERTEZA ABSOLUTA que deseja deletar?\n\nEsta escala será PERDIDA PERMANENTEMENTE!');
                if (!confirmacao) {
                    return;
                }
                
                // Prosseguir com a exclusão
                showAlertEscala('Deletando escala...', 'info');
                
                const deleteResponse = await fetch('/escala/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await deleteResponse.json();
                
                if (result.success) {
                    showAlertEscala('✅ Escala deletada com sucesso!', 'success');
                    
                    // Limpar visualização
                    document.getElementById('escalaContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>✅ Escala deletada com sucesso.</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Nova Escala" para gerar uma nova.</p>
                        </div>
                    `;
                    
                    // Limpar estatísticas se existirem
                    const statsContainer = document.getElementById('estatisticasContainer');
                    if (statsContainer) {
                        statsContainer.innerHTML = '';
                    }
                    
                } else {
                    showAlertEscala('❌ Erro ao deletar: ' + (result.error || 'Erro desconhecido'), 'error');
                }
                
            } catch (error) {
                console.error('Erro ao deletar escala:', error);
                showAlertEscala('❌ Erro ao deletar escala: ' + error.message, 'error');
            }
        }

        function renderEscala(escala) {
            const container = document.getElementById('escalaContainer');
            
            if (!escala || escala.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>Nenhuma escala gerada ainda.</p>
                        ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Gerar Escala Automaticamente" acima.</p>' : ''}
                    </div>
                `;
                return;
            }

            // Agrupar por mês
            const escalaPorMes = {};
            const mesesNome = {
                1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
                5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
            };
            
            const diasSemana = {
                'Sunday': 'Domingo',
                'Tuesday': 'Terça-feira',
                'Monday': 'Segunda',
                'Wednesday': 'Quarta',
                'Thursday': 'Quinta',
                'Friday': 'Sexta',
                'Saturday': 'Sábado'
            };

            console.log('📊 DEBUG: Primeiros 3 itens da escala:', escala.slice(0, 3));

            escala.forEach(item => {
                const date = new Date(item.data + 'T00:00:00');
                const mesAno = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!escalaPorMes[mesAno]) {
                    escalaPorMes[mesAno] = {
                        nome: `${mesesNome[date.getMonth() + 1]} de ${date.getFullYear()}`,
                        itens: []
                    };
                }
                escalaPorMes[mesAno].itens.push(item);
            });

            // Atualizar informação do período
            const infoEscala = document.getElementById('infoEscala');
            const primeiraData = formatDateBR(escala[0].data);
            const ultimaData = formatDateBR(escala[escala.length - 1].data);
            infoEscala.innerHTML = `
                <p><strong>📅 Período:</strong> ${primeiraData} a ${ultimaData}</p>
                <p><strong>📊 Total de alocações:</strong> ${escala.length} (${Object.keys(escalaPorMes).length} ${Object.keys(escalaPorMes).length === 1 ? 'mês' : 'meses'})</p>
            `;

            // Renderizar cada mês separadamente
            let html = '';
            const mesesOrdenados = Object.keys(escalaPorMes).sort();
            
            mesesOrdenados.forEach((mesAno, index) => {
                const mes = escalaPorMes[mesAno];
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: linear-gradient(135deg, #A78BFA 0%, #6D28D9 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px;">
                            📅 ${mes.nome}
                        </h3>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: #8B5CF6; color: white;">
                                        <th style="padding: 12px; text-align: left;">Data</th>
                                        <th style="padding: 12px; text-align: left;">Dia</th>
                                        <th style="padding: 12px; text-align: center; border-left: 2px solid rgba(255,255,255,0.3);">
                                            🎹 Meia-hora
                                        </th>
                                        <th style="padding: 12px; text-align: center; border-left: 2px solid rgba(255,255,255,0.3);">
                                            🎵 Culto
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                mes.itens.forEach(item => {
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb; background: white;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <td style="padding: 12px; font-weight: 500;">${formatDateBR(item.data)}</td>
                            <td style="padding: 12px;">${diasSemana[item.dia_semana] || item.dia_semana}</td>
                    `;
                    
                    if (item.dia_semana === 'Sunday') {
                        // DOMINGO: Duas fases separadas (Meia-hora e Culto)
                        const meiaHora = item.meia_hora || '—';
                        const culto = item.culto || '—';
                        
                        html += `
                            <td style="padding: 12px; background: #f0fdf4;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #10b981; font-size: 0.75em; margin-bottom: 4px;">MEIA-HORA</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'meia_hora', meiaHora) : 
                                        `<span>${meiaHora}</span>`
                                    }
                                </div>
                            </td>
                            <td style="padding: 12px; background: #eff6ff;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #3b82f6; font-size: 0.75em; margin-bottom: 4px;">CULTO</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'culto', culto) : 
                                        `<span>${culto}</span>`
                                    }
                                </div>
                            </td>
                        `;
                    } else {
                        // TERÇA-FEIRA: Duas fases (podem ser pessoas diferentes)
                        // Para compatibilidade: se tiver 'unica', usar para ambas; senão usar campos separados
                        const meiaHora = item.meia_hora || item.unica || '—';
                        const culto = item.culto || item.unica || '—';
                        
                        html += `
                            <td style="padding: 12px; background: #fef3c7;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #d97706; font-size: 0.75em; margin-bottom: 4px;">MEIA-HORA</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'meia_hora', meiaHora) : 
                                        `<span>${meiaHora}</span>`
                                    }
                                </div>
                            </td>
                            <td style="padding: 12px; background: #fef3c7;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #d97706; font-size: 0.75em; margin-bottom: 4px;">CULTO</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'culto', culto) : 
                                        `<span>${culto}</span>`
                                    }
                                </div>
                            </td>
                        `;
                    }
                    
                    html += '</tr>';
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function createOrganistaSelectHTML(data, tipo, valorAtual) {
            const selectId = `select_${data}_${tipo}`;
            let html = `<select id="${selectId}" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px;">`;
            html += `<option value="">-- Selecione --</option>`;
            
            let opcoesDisponiveis = 0;
            
            organistas.forEach(org => {
                const selected = org.nome === valorAtual ? 'selected' : '';
                
                // Verificar se está indisponível nesta data
                const indisponivelNaData = indisponibilidades.some(
                    ind => ind.id === org.id && ind.data === data
                );
                
                // Verificar se tem a fase habilitada
                let temFaseHabilitada = true;
                if (tipo === 'meia_hora') {
                    temFaseHabilitada = org.tipos && org.tipos.includes('Meia-hora');
                } else if (tipo === 'culto') {
                    temFaseHabilitada = org.tipos && org.tipos.includes('Culto');
                } else if (tipo === 'unica') {
                    // Para terça precisa ter ambas as fases
                    temFaseHabilitada = org.tipos && 
                        org.tipos.includes('Meia-hora') && 
                        org.tipos.includes('Culto');
                }
                
                // Se não está indisponível E tem fase habilitada, conta como disponível
                if (!indisponivelNaData && temFaseHabilitada) {
                    opcoesDisponiveis++;
                }
                
                const disabled = indisponivelNaData || !temFaseHabilitada ? 'disabled' : '';
                const style = indisponivelNaData ? 'color: #999; text-decoration: line-through;' : 
                             !temFaseHabilitada ? 'color: #dc2626; font-style: italic;' : '';
                const suffix = indisponivelNaData ? ' (indisponível)' : 
                              !temFaseHabilitada ? ' (não habilitado)' : '';
                
                html += `<option value="${org.nome}" ${selected} ${disabled} style="${style}">${org.nome}${suffix}</option>`;
            });
            
            html += '</select>';
            
            // Debug: log se há poucas opções
            if (opcoesDisponiveis <= 1) {
                console.log(`⚠️ Dropdown ${tipo} na data ${data}: apenas ${opcoesDisponiveis} opção(ões) disponível(is)`);
            }
            
            return html;
        }

        async function salvarTodasAlteracoes() {
            try {
                showAlertEscala('Salvando todas as alterações...', 'info');
                
                // Buscar escala atual do backend
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escalaAtual = data.escala;
                
                if (!escalaAtual || escalaAtual.length === 0) {
                    showAlertEscala('⚠️ Nenhuma escala para salvar.', 'warning');
                    return;
                }
                
                let alteracoes = 0;
                let erros = 0;
                
                // Para cada item da escala, ler os valores dos dropdowns e atualizar
                for (const item of escalaAtual) {
                    const selectMeiaHora = document.getElementById(`select_${item.data}_meia_hora`);
                    const selectCulto = document.getElementById(`select_${item.data}_culto`);
                    
                    if (selectMeiaHora && selectCulto) {
                        const meiaHoraAtual = selectMeiaHora.value || null;
                        const cultoAtual = selectCulto.value || null;
                        
                        // Verificar se houve mudança
                        const meiaHoraOriginal = item.meia_hora || item.unica || null;
                        const cultoOriginal = item.culto || item.unica || null;
                        
                        if (meiaHoraAtual !== meiaHoraOriginal || cultoAtual !== cultoOriginal) {
                            try {
                                const saveResponse = await fetch(`/escala/editar/${item.data}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        alocacao: {
                                            meia_hora: meiaHoraAtual,
                                            culto: cultoAtual
                                        }
                                    })
                                });
                                
                                if (saveResponse.ok) {
                                    alteracoes++;
                                } else {
                                    erros++;
                                }
                            } catch (error) {
                                console.error(`Erro ao salvar ${item.data}:`, error);
                                erros++;
                            }
                        }
                    }
                }
                
                if (alteracoes > 0) {
                    showAlertEscala(`✅ ${alteracoes} alteração(ões) salva(s) com sucesso!${erros > 0 ? ` (${erros} erro(s))` : ''}`, 'success');
                    await loadEscalaAtual();
                    await renderEscalaAtual(); // Atualizar dashboard
                } else {
                    showAlertEscala('ℹ️ Nenhuma alteração detectada.', 'info');
                }
            } catch (error) {
                showAlertEscala('❌ Erro ao salvar alterações: ' + error.message, 'error');
            }
        }

        async function salvarEdicao(dataIso) {
            try {
                const selectMeiaHora = document.getElementById(`select_${dataIso}_meia_hora`);
                const selectCulto = document.getElementById(`select_${dataIso}_culto`);

                const alocacao = {};
                
                if (selectMeiaHora && selectCulto) {
                    // Domingo OU Terça (ambos agora usam meia_hora e culto)
                    alocacao.meia_hora = selectMeiaHora.value || null;
                    alocacao.culto = selectCulto.value || null;
                }

                const response = await fetch(`/escala/editar/${dataIso}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ alocacao })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar edição');
                }

                showAlertEscala('✅ Alocação atualizada com sucesso!', 'success');
                await loadEscalaAtual();
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        function renderLogs(logs) {
            const logsDiv = document.getElementById('logsGeracao');
            const logsContent = document.getElementById('logsContent');
            
            if (!logs || logs.length === 0) {
                logsDiv.style.display = 'none';
                return;
            }

            logsDiv.style.display = 'block';
            logsContent.innerHTML = logs.map(log => {
                const emoji = log.includes('✅') ? '' : 
                             log.includes('⚠️') ? '' : 
                             log.includes('❌') ? '' : '📝';
                return `<div style="margin-bottom: 5px;">${emoji} ${log}</div>`;
            }).join('');
        }

        function renderEstatisticas(stats) {
            const statsDiv = document.getElementById('statsEscala');
            
            if (!stats) {
                statsDiv.innerHTML = '<p style="color: #666;">Gere uma escala para ver as estatísticas.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            
            Object.entries(stats).forEach(([nome, contagem]) => {
                html += `
                    <div style="background: linear-gradient(135deg, #A78BFA 0%, #6D28D9 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">${nome}</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 5px;">${contagem.total}</div>
                        <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">
                            ${contagem.meia_hora || 0} Meia-hora • ${contagem.culto || 0} Culto • ${contagem.terca || 0} Terça
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statsDiv.innerHTML = html;
        }

        function showAlertEscala(message, type) {
            const alert = document.getElementById('alertEscala');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        function formatDateBR(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Adicionar evento à agenda (iCalendar)
        function adicionarAgenda(data, diaSemana, servicos) {
            try {
                // Parse da data
                const dataEvento = new Date(data);
                
                // Definir horários baseado no dia da semana e serviço
                let eventos = [];
                const nomeDia = diaSemana === 'Sunday' ? 'Domingo' : 'Terça-feira';
                
                servicos.forEach(servico => {
                    let horaInicio, horaFim, titulo;
                    
                    if (servico === 'meia_hora') {
                        if (diaSemana === 'Sunday') {
                            horaInicio = '18:00';
                            horaFim = '18:30';
                        } else {
                            horaInicio = '19:00';
                            horaFim = '19:30';
                        }
                        titulo = `Meia-hora - ${nomeDia}`;
                    } else if (servico === 'culto') {
                        if (diaSemana === 'Sunday') {
                            horaInicio = '18:30';
                            horaFim = '20:00';
                        } else {
                            horaInicio = '19:30';
                            horaFim = '21:00';
                        }
                        titulo = `Culto - ${nomeDia}`;
                    }
                    
                    eventos.push({ titulo, horaInicio, horaFim });
                });
                
                // Gerar arquivo iCalendar
                const comumNome = contextoAtual.comum?.nome || 'Nossa Comum';
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += `PRODID:-//Rodízio de Organistas - ${comumNome}//PT\r\n`;
                icsContent += 'CALSCALE:GREGORIAN\r\n';
                icsContent += 'METHOD:PUBLISH\r\n';
                
                eventos.forEach(evento => {
                    // Formatar data e hora para iCalendar (formato: YYYYMMDDTHHmmss)
                    const ano = dataEvento.getFullYear();
                    const mes = String(dataEvento.getMonth() + 1).padStart(2, '0');
                    const dia = String(dataEvento.getDate()).padStart(2, '0');
                    const [horaI, minI] = evento.horaInicio.split(':');
                    const [horaF, minF] = evento.horaFim.split(':');
                    
                    const dtStart = `${ano}${mes}${dia}T${horaI}${minI}00`;
                    const dtEnd = `${ano}${mes}${dia}T${horaF}${minF}00`;
                    const dtStamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    const uid = `${dtStart}-${Math.random().toString(36).substr(2, 9)}@rodizio-organistas`;
                    
                    icsContent += 'BEGIN:VEVENT\r\n';
                    icsContent += `UID:${uid}\r\n`;
                    icsContent += `DTSTAMP:${dtStamp}\r\n`;
                    icsContent += `DTSTART:${dtStart}\r\n`;
                    icsContent += `DTEND:${dtEnd}\r\n`;
                    icsContent += `SUMMARY:${evento.titulo} - Rodízio de Organistas\r\n`;
                    icsContent += `DESCRIPTION:Rodízio de Organistas - ${comumNome}\\n${evento.titulo}\r\n`;
                    icsContent += `LOCATION:Igreja ${comumNome}\r\n`;
                    icsContent += `STATUS:CONFIRMED\r\n`;
                    icsContent += 'BEGIN:VALARM\r\n';
                    icsContent += 'TRIGGER:-PT1H\r\n';
                    icsContent += 'ACTION:DISPLAY\r\n';
                    icsContent += `DESCRIPTION:Lembrete: ${evento.titulo} em 1 hora\r\n`;
                    icsContent += 'END:VALARM\r\n';
                    icsContent += 'END:VEVENT\r\n';
                });
                
                icsContent += 'END:VCALENDAR\r\n';
                
                // Criar blob e fazer download
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `rodizio-organista-${dataEvento.getDate()}-${dataEvento.getMonth()+1}-${dataEvento.getFullYear()}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
            } catch (error) {
                console.error('Erro ao criar evento:', error);
                alert('❌ Erro ao criar evento para a agenda.');
            }
        }

        function exportarPDF() {
            // Abre o PDF em nova aba com timestamp para evitar cache
            const timestamp = new Date().getTime();
            window.open('/escala/pdf?t=' + timestamp, '_blank');
        }

        // Compartilhar escala no WhatsApp
        async function compartilharWhatsApp() {
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escala = data.escala || [];
                
                if (!escala || escala.length === 0) {
                    alert('⚠️ Nenhuma escala cadastrada para compartilhar.');
                    return;
                }
                
                // Construir mensagem
                const comumNome = contextoAtual.comum?.nome || 'Nossa Comum';
                let mensagem = `*ESCALA DE ORGANISTAS - ${comumNome.toUpperCase()}*\n`;
                mensagem += `Período: {{ cfg.bimestre.inicio | date_br }} até {{ cfg.bimestre.fim | date_br }}\n\n`;
                
                // Agrupar por mês
                const meses = {};
                escala.forEach(item => {
                    const data = new Date(item.data);
                    const mes = data.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    const mesCapitalizado = mes.charAt(0).toUpperCase() + mes.slice(1);
                    
                    if (!meses[mesCapitalizado]) {
                        meses[mesCapitalizado] = [];
                    }
                    meses[mesCapitalizado].push(item);
                });
                
                // Formatar mensagem por mês
                Object.keys(meses).sort().forEach(mes => {
                    mensagem += `*${mes}*\n`;
                    mensagem += `${'─'.repeat(30)}\n`;
                    
                    meses[mes].forEach(item => {
                        const data = new Date(item.data);
                        const dia = data.getDate().toString().padStart(2, '0');
                        
                        // Mapear corretamente todos os dias da semana
                        const diasSemanaMap = {
                            'Sunday': 'Domingo',
                            'Monday': 'Segunda',
                            'Tuesday': 'Terça',
                            'Wednesday': 'Quarta',
                            'Thursday': 'Quinta',
                            'Friday': 'Sexta',
                            'Saturday': 'Sábado'
                        };
                        const diaSemana = diasSemanaMap[item.dia_semana] || item.dia_semana;
                        
                        mensagem += `\n*${dia} - ${diaSemana}*\n`;
                        mensagem += `Meia-hora: ${item.meia_hora || 'Não definido'}\n`;
                        mensagem += `Culto: ${item.culto || 'Não definido'}\n`;
                    });
                    
                    mensagem += `\n`;
                });
                
                mensagem += `\n_Gerado pelo Sistema de Rodízio_`;
                
                // Codificar mensagem para URL
                const mensagemCodificada = encodeURIComponent(mensagem);
                
                // Abrir WhatsApp
                const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
                window.open(urlWhatsApp, '_blank');
                
            } catch (error) {
                console.error('Erro ao compartilhar no WhatsApp:', error);
                alert('❌ Erro ao gerar mensagem para o WhatsApp.');
            }
        }

        // Inicializar dados ao carregar a página
        async function initializeApp() {
            try {
                console.log('🚀 Inicializando aplicação...');
                
                // Carregar contexto atual
                await carregarContextoAtual();
                
                // Carregar organistas primeiro
                await loadOrganistas();
                
                // Carregar indisponibilidades
                if (typeof loadIndisponibilidades === 'function') {
                    loadIndisponibilidades();
                }
                
                // Carregar escala do dashboard
                if (document.getElementById('escalaAtual')) {
                    await loadEscalaAtual();
                }
                
                // Carregar "Meus Dias" para organistas
                if (document.getElementById('meusDias')) {
                    await renderMeusDias();
                }
                
                // Carregar configurações
                if (typeof loadConfig === 'function') {
                    loadConfig();
                }
                
                // Carregar seletores de contexto para Master
                if (typeof carregarSeletoresContexto === 'function') {
                    await carregarSeletoresContexto();
                }
                
                console.log('✅ Aplicação inicializada com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao inicializar:', error);
            }
        }

        // ========== FUNÇÕES RJM ==========
        
        async function criarEscalaRJM() {
            if (!confirm('Criar nova escala RJM vazia? Isso irá substituir a escala existente.')) {
                return;
            }
            
            try {
                const response = await fetch('/rjm/criar-vazia', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    alert('✅ Escala RJM vazia criada com sucesso!');
                    await loadEscalaRJM();
                } else {
                    const error = await response.json();
                    alert(`❌ Erro: ${error.error || 'Falha ao criar escala'}`);
                }
            } catch (error) {
                console.error('Erro ao criar escala RJM:', error);
                alert('❌ Erro ao criar escala RJM.');
            }
        }
        
        // Deletar Escala RJM
        async function deletarEscalaRJM() {
            try {
                // Buscar escala RJM atual para mostrar informações
                const response = await fetch('/rjm/atual');
                const data = await response.json();
                
                if (!data.escala_rjm || data.escala_rjm.length === 0) {
                    alert('⚠️ Não há escala RJM cadastrada para deletar.');
                    return;
                }
                
                const escalaRJM = data.escala_rjm;
                
                // Contar informações
                const totalDatas = escalaRJM.length;
                const organistasUnicos = [...new Set(escalaRJM
                    .map(item => item.organista?.nome)
                    .filter(Boolean))];
                
                // Agrupar por mês
                const datas = escalaRJM.map(item => new Date(item.data));
                const dataInicio = new Date(Math.min(...datas));
                const dataFim = new Date(Math.max(...datas));
                
                const mesesNome = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const mesInicio = mesesNome[dataInicio.getMonth()];
                const mesFim = mesesNome[dataFim.getMonth()];
                const anoInicio = dataInicio.getFullYear();
                const anoFim = dataFim.getFullYear();
                
                const periodoTexto = anoInicio === anoFim 
                    ? `${mesInicio} a ${mesFim}/${anoInicio}`
                    : `${mesInicio}/${anoInicio} a ${mesFim}/${anoFim}`;
                
                // Montar mensagem
                let mensagem = `🗑️ DELETAR ESCALA RJM\n\n`;
                mensagem += `📊 Informações da Escala:\n`;
                mensagem += `📅 Período: ${periodoTexto}\n`;
                mensagem += `📆 Total de datas: ${totalDatas}\n`;
                mensagem += `👥 Organistas envolvidos: ${organistasUnicos.length}\n\n`;
                
                if (organistasUnicos.length > 0) {
                    mensagem += `Organistas:\n`;
                    organistasUnicos.slice(0, 8).forEach(org => {
                        mensagem += `  • ${org}\n`;
                    });
                    if (organistasUnicos.length > 8) {
                        mensagem += `  ... e mais ${organistasUnicos.length - 8} organista(s)\n`;
                    }
                    mensagem += `\n`;
                }
                
                mensagem += `⚠️ ATENÇÃO: Esta ação NÃO pode ser desfeita!\n\n`;
                mensagem += `Todos os dados desta escala RJM serão PERMANENTEMENTE removidos.\n\n`;
                mensagem += `Deseja realmente deletar esta escala?`;
                
                if (!confirm(mensagem)) {
                    return;
                }
                
                // Confirmar novamente
                const confirmacao = confirm('⚠️ ÚLTIMA CONFIRMAÇÃO\n\nTem CERTEZA ABSOLUTA que deseja deletar?\n\nEsta escala RJM será PERDIDA PERMANENTEMENTE!');
                if (!confirmacao) {
                    return;
                }
                
                // Prosseguir com a exclusão
                const deleteResponse = await fetch('/rjm/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await deleteResponse.json();
                
                if (result.success) {
                    alert('✅ Escala RJM deletada com sucesso!');
                    
                    // Limpar visualização
                    document.getElementById('escalaRJMContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>✅ Escala RJM deletada com sucesso.</p>
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Escala RJM Vazia" para gerar uma nova.</p>
                        </div>
                    `;
                    
                    // Limpar estatísticas
                    const statsContainer = document.getElementById('statsEscalaRJM');
                    if (statsContainer) {
                        statsContainer.innerHTML = '<p style="color: #666;">Gere uma escala para ver as estatísticas.</p>';
                    }
                    
                } else {
                    alert('❌ Erro ao deletar: ' + (result.error || 'Erro desconhecido'));
                }
                
            } catch (error) {
                console.error('Erro ao deletar escala RJM:', error);
                alert('❌ Erro ao deletar escala RJM: ' + error.message);
            }
        }
        
        async function loadEscalaRJM() {
            try {
                const response = await fetch('/rjm/atual');
                const data = await response.json();
                const escalaRJM = data.escala_rjm || [];
                
                if (!escalaRJM || escalaRJM.length === 0) {
                    document.getElementById('escalaRJMContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala RJM publicada ainda.</p>
                            ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Escala RJM Vazia" acima para começar.</p>' : ''}
                        </div>
                    `;
                    return;
                }
                
                // Renderizar tabela RJM
                let html = '<table class="escala-table"><thead><tr>';
                html += '<th style="width: 120px;">Data</th>';
                html += '<th style="width: 100px;">Dia</th>';
                html += '<th>Organista (10:00 - 11:30)</th>';
                html += '</tr></thead><tbody>';
                
                escalaRJM.forEach(item => {
                    const data = new Date(item.data);
                    const dataFormatada = data.toLocaleDateString('pt-BR');
                    const diaSemana = 'Domingo';
                    
                    html += '<tr>';
                    html += `<td><strong>${dataFormatada}</strong></td>`;
                    html += `<td><span class="badge badge-green">${diaSemana}</span></td>`;
                    
                    if (isAdmin) {
                        html += '<td>';
                        html += `<select class="organista-select" data-escala-id="${item.id}" data-tipo="organista" onchange="marcarAlteradoRJM(this)">`;
                        html += '<option value="">Selecione...</option>';
                        
                        organistas.forEach(org => {
                            const indisponivelNaData = indisponibilidades.some(ind => 
                                ind.id === org.id && ind.data === item.data
                            );
                            
                            const temPermissaoRJM = org.tipos && org.tipos.includes('RJM');
                            const selected = item.organista === org.nome ? 'selected' : '';
                            
                            if (indisponivelNaData) {
                                html += `<option value="${org.nome}" ${selected} style="text-decoration: line-through; color: red;">~~${org.nome}~~</option>`;
                            } else if (!temPermissaoRJM) {
                                html += `<option value="${org.nome}" ${selected} style="font-style: italic; color: red;">${org.nome} (sem permissão RJM)</option>`;
                            } else {
                                html += `<option value="${org.nome}" ${selected}>${org.nome}</option>`;
                            }
                        });
                        
                        html += '</select></td>';
                    } else {
                        html += `<td>${item.organista || '-'}</td>`;
                    }
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('escalaRJMContainer').innerHTML = html;
                
                // Atualizar info
                if (escalaRJM.length > 0) {
                    const primeiraData = formatDateBR(escalaRJM[0].data);
                    const ultimaData = formatDateBR(escalaRJM[escalaRJM.length - 1].data);
                    document.getElementById('infoEscalaRJM').innerHTML = `
                        <p><strong>📅 Período:</strong> ${primeiraData} a ${ultimaData}</p>
                        <p><strong>📊 Total de domingos RJM:</strong> ${escalaRJM.length}</p>
                    `;
                }
                
                // Estatísticas
                renderStatsRJM(escalaRJM);
                
            } catch (error) {
                console.error('Erro ao carregar escala RJM:', error);
                document.getElementById('escalaRJMContainer').innerHTML = 
                    '<div style="color: red; padding: 20px;">Erro ao carregar escala RJM</div>';
            }
        }
        
        function marcarAlteradoRJM(select) {
            select.style.border = '2px solid #f59e0b';
            select.style.background = '#fffbeb';
        }
        
        async function salvarTodasAlteracoesRJM() {
            const selects = document.querySelectorAll('#escalaRJMContainer select');
            const alteracoes = [];
            
            selects.forEach(select => {
                alteracoes.push({
                    id: select.dataset.escalaId,
                    organista: select.value
                });
            });
            
            if (alteracoes.length === 0) {
                alert('Nenhuma alteração para salvar.');
                return;
            }
            
            try {
                const response = await fetch('/rjm/atualizar-multiplos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({alteracoes})
                });
                
                if (response.ok) {
                    alert('✅ Todas as alterações foram salvas com sucesso!');
                    await loadEscalaRJM();
                } else {
                    const error = await response.json();
                    alert(`❌ Erro: ${error.error || 'Falha ao salvar'}`);
                }
            } catch (error) {
                console.error('Erro ao salvar alterações RJM:', error);
                alert('❌ Erro ao salvar alterações.');
            }
        }
        
        function renderStatsRJM(escalaRJM) {
            const statsDiv = document.getElementById('statsEscalaRJM');
            
            if (!escalaRJM || escalaRJM.length === 0) {
                statsDiv.innerHTML = '<p style="color: #666;">Gere uma escala para ver as estatísticas.</p>';
                return;
            }
            
            const contador = {};
            escalaRJM.forEach(item => {
                if (item.organista) {
                    contador[item.organista] = (contador[item.organista] || 0) + 1;
                }
            });
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';
            Object.entries(contador).sort((a, b) => b[1] - a[1]).forEach(([nome, total]) => {
                html += `
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">👤 ${nome}</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${total}</div>
                        <div style="font-size: 0.8em; color: #666;">domingos RJM</div>
                    </div>
                `;
            });
            html += '</div>';
            statsDiv.innerHTML = html;
        }
        
        function exportarPDFRJM() {
            const timestamp = new Date().getTime();
            window.open('/rjm/pdf?t=' + timestamp, '_blank');
        }
        
        async function compartilharWhatsAppRJM() {
            try {
                const response = await fetch('/rjm/atual');
                const data = await response.json();
                const escalaRJM = data.escala_rjm || [];
                
                if (!escalaRJM || escalaRJM.length === 0) {
                    alert('⚠️ Nenhuma escala RJM cadastrada para compartilhar.');
                    return;
                }
                
                const comumNome = contextoAtual.comum?.nome || 'Nossa Comum';
                let mensagem = `*ESCALA RJM - ${comumNome.toUpperCase()}*\n`;
                mensagem += `Reunião de Jovens e Menores\n`;
                mensagem += `Horário: Domingos 10:00 - 11:30\n\n`;
                
                // Agrupar por mês
                const meses = {};
                escalaRJM.forEach(item => {
                    const data = new Date(item.data);
                    const mesAno = data.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
                    if (!meses[mesAno]) {
                        meses[mesAno] = [];
                    }
                    meses[mesAno].push(item);
                });
                
                Object.keys(meses).forEach(mesAno => {
                    mensagem += `*${mesAno.charAt(0).toUpperCase() + mesAno.slice(1)}*\n`;
                    mensagem += `──────────────\n`;
                    
                    meses[mesAno].forEach(item => {
                        const data = new Date(item.data);
                        const dia = data.getDate().toString().padStart(2, '0');
                        const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                        
                        mensagem += `${dia}/${mes} - Domingo\n`;
                        mensagem += `   Organista: ${item.organista || 'A definir'}\n\n`;
                    });
                    
                    mensagem += `\n`;
                });
                
                const mensagemCodificada = encodeURIComponent(mensagem);
                const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
                window.open(urlWhatsApp, '_blank');
                
            } catch (error) {
                console.error('Erro ao compartilhar no WhatsApp:', error);
                alert('❌ Erro ao gerar mensagem para o WhatsApp.');
            }
        }
        
        // ==================== Gerenciamento de Hierarquia ====================
        
        let regionalSelecionada = null;
        let subRegionalSelecionada = null;
        
        // Carregar hierarquia completa
        async function carregarHierarquia() {
            if (contextoAtual.nivel !== 'master') return;
            
            try {
                const response = await fetch('/api/regionais');
                const regionais = await response.json();
                
                const container = document.getElementById('listaRegionais');
                container.innerHTML = '';
                
                if (regionais.length === 0) {
                    container.innerHTML = '<p style="color: #999;">Nenhuma regional cadastrada</p>';
                    return;
                }
                
                // Se não há regional selecionada, selecionar a primeira automaticamente
                if (!regionalSelecionada && regionais.length > 0) {
                    regionalSelecionada = regionais[0].id;
                }
                
                regionais.forEach(regional => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: #f3f4f6; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
                    card.onclick = () => selecionarRegional(regional.id);
                    
                    if (regionalSelecionada === regional.id) {
                        card.style.background = '#dbeafe';
                        card.style.borderLeft = '4px solid #3b82f6';
                    }
                    
                    card.innerHTML = `
                        <div>
                            <strong style="font-size: 1.1em;">🏙️ ${regional.nome}</strong>
                            <div style="font-size: 0.9em; color: #666;">ID: ${regional.id}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" style="padding: 5px 10px; background: #3b82f6; color: white;" onclick="event.stopPropagation(); editarRegional('${regional.id}', '${regional.nome}')">✏️</button>
                            <button class="btn" style="padding: 5px 10px; background: #ef4444; color: white;" onclick="event.stopPropagation(); deletarRegional('${regional.id}')">🗑️</button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Se há regional selecionada, carregar suas sub-regionais
                if (regionalSelecionada) {
                    await carregarSubRegionaisHierarquia(regionalSelecionada);
                }
                
            } catch (error) {
                console.error('Erro ao carregar hierarquia:', error);
                showNotification('Erro ao carregar hierarquia', 'error');
            }
        }
        
        // Selecionar regional
        async function selecionarRegional(regionalId) {
            regionalSelecionada = regionalId;
            subRegionalSelecionada = null;
            await carregarHierarquia();
            await carregarSubRegionaisHierarquia(regionalId);
            
            const container = document.getElementById('listaComuns');
            container.innerHTML = '<p style="color: #999;">Selecione uma Sub-Regional</p>';
        }
        
        // Carregar sub-regionais
        async function carregarSubRegionaisHierarquia(regionalId) {
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais`);
                const subRegionais = await response.json();
                
                const container = document.getElementById('listaSubRegionais');
                container.innerHTML = '';
                
                if (subRegionais.length === 0) {
                    container.innerHTML = '<p style="color: #999;">Nenhuma sub-regional nesta regional</p>';
                    const comunsContainer = document.getElementById('listaComuns');
                    comunsContainer.innerHTML = '<p style="color: #999;">Nenhuma sub-regional disponível</p>';
                    return;
                }
                
                // Se não há sub-regional selecionada, selecionar a primeira automaticamente
                if (!subRegionalSelecionada && subRegionais.length > 0) {
                    subRegionalSelecionada = subRegionais[0].id;
                }
                
                subRegionais.forEach(sub => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: #f3f4f6; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
                    card.onclick = () => selecionarSubRegional(sub.id);
                    
                    if (subRegionalSelecionada === sub.id) {
                        card.style.background = '#dbeafe';
                        card.style.borderLeft = '4px solid #3b82f6';
                    }
                    
                    card.innerHTML = `
                        <div>
                            <strong style="font-size: 1.1em;">📍 ${sub.nome}</strong>
                            <div style="font-size: 0.9em; color: #666;">ID: ${sub.id}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" style="padding: 5px 10px; background: #3b82f6; color: white;" onclick="event.stopPropagation(); editarSubRegional('${regionalId}', '${sub.id}', '${sub.nome}')">✏️</button>
                            <button class="btn" style="padding: 5px 10px; background: #ef4444; color: white;" onclick="event.stopPropagation(); deletarSubRegional('${regionalId}', '${sub.id}')">🗑️</button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Se há sub-regional selecionada, carregar suas comuns
                if (subRegionalSelecionada) {
                    await carregarComunsHierarquia(regionalId, subRegionalSelecionada);
                }
                
            } catch (error) {
                console.error('Erro ao carregar sub-regionais:', error);
            }
        }
        
        // Selecionar sub-regional
        async function selecionarSubRegional(subId) {
            subRegionalSelecionada = subId;
            await carregarSubRegionaisHierarquia(regionalSelecionada);
            await carregarComunsHierarquia(regionalSelecionada, subId);
        }
        
        // Carregar comuns
        async function carregarComunsHierarquia(regionalId, subId) {
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns`);
                const comuns = await response.json();
                
                const container = document.getElementById('listaComuns');
                container.innerHTML = '';
                
                if (comuns.length === 0) {
                    container.innerHTML = '<p style="color: #999;">Nenhum comum nesta sub-regional</p>';
                    return;
                }
                
                comuns.forEach(comum => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 10px;';
                    
                    // Montar informações de configuração
                    let configInfo = '';
                    if (comum.config) {
                        const diasCulto = comum.config.dias_culto || [];
                        const horarios = comum.config.horarios || {};
                        
                        if (diasCulto.length > 0) {
                            configInfo += '<div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid #3b82f6;">';
                            configInfo += '<div style="font-size: 0.85em; color: #666; margin-bottom: 8px;"><strong>📅 Dias e Horários Configurados:</strong></div>';
                            configInfo += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                            
                            diasCulto.forEach(dia => {
                                const horasDia = horarios[dia] || [];
                                const horariosTexto = horasDia.length > 0 ? horasDia.join(', ') : 'não definidos';
                                
                                // Escolher cor por dia
                                let corDia = '#6b7280';
                                if (dia === 'Domingo') corDia = '#dc2626';
                                else if (dia === 'Segunda') corDia = '#2563eb';
                                else if (dia === 'Terça') corDia = '#059669';
                                else if (dia === 'Quarta') corDia = '#ea580c';
                                else if (dia === 'Quinta') corDia = '#7c3aed';
                                else if (dia === 'Sexta') corDia = '#0891b2';
                                else if (dia === 'Sábado') corDia = '#ca8a04';
                                
                                configInfo += `
                                    <div style="background: ${corDia}15; border: 1px solid ${corDia}; padding: 6px 10px; border-radius: 6px; font-size: 0.85em;">
                                        <strong style="color: ${corDia};">${dia}</strong><br>
                                        <span style="color: #666; font-size: 0.9em;">⏰ ${horariosTexto}</span>
                                    </div>
                                `;
                            });
                            
                            configInfo += '</div>';
                            
                            // Fechamento
                            const fechamento = comum.config.fechamento_publicacao_dias || 7;
                            configInfo += `<div style="margin-top: 8px; font-size: 0.8em; color: #666;">⏱️ Fechamento: ${fechamento} dias antes</div>`;
                            configInfo += '</div>';
                        }
                    }
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong style="font-size: 1.1em;">⛪ ${comum.nome}</strong>
                                <div style="font-size: 0.9em; color: #666;">ID: ${comum.id}</div>
                                ${configInfo}
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                <button class="btn" style="padding: 5px 10px; background: #3b82f6; color: white;" onclick="abrirModalEditarComum('${regionalId}', '${subId}', '${comum.id}')">✏️</button>
                                <button class="btn" style="padding: 5px 10px; background: #ef4444; color: white;" onclick="deletarComum('${regionalId}', '${subId}', '${comum.id}')">🗑️</button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('Erro ao carregar comuns:', error);
            }
        }
        
        // Modais
        function mostrarModalNovaRegional() {
            document.getElementById('modalNovaRegional').style.display = 'flex';
        }
        
        function fecharModalNovaRegional() {
            document.getElementById('modalNovaRegional').style.display = 'none';
            document.getElementById('novaRegionalId').value = '';
            document.getElementById('novaRegionalNome').value = '';
        }
        
        async function mostrarModalNovaSubRegional() {
            // Carregar regionais no select
            const response = await fetch('/api/regionais');
            const regionais = await response.json();
            
            const select = document.getElementById('novaSubRegionalPai');
            select.innerHTML = '<option value="">Selecione...</option>';
            regionais.forEach(r => {
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = r.nome;
                if (regionalSelecionada === r.id) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('modalNovaSubRegional').style.display = 'flex';
        }
        
        function fecharModalNovaSubRegional() {
            document.getElementById('modalNovaSubRegional').style.display = 'none';
            document.getElementById('novaSubRegionalId').value = '';
            document.getElementById('novaSubRegionalNome').value = '';
        }
        
        async function mostrarModalNovoComum() {
            // Carregar regionais
            const response = await fetch('/api/regionais');
            const regionais = await response.json();
            
            const select = document.getElementById('novoComumRegional');
            select.innerHTML = '<option value="">Selecione...</option>';
            regionais.forEach(r => {
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = r.nome;
                if (regionalSelecionada === r.id) option.selected = true;
                select.appendChild(option);
            });
            
            // Se há regional selecionada, carregar sub-regionais
            if (regionalSelecionada) {
                await carregarSubRegionaisModal();
            }
            
            document.getElementById('modalNovoComum').style.display = 'flex';
        }
        
        function fecharModalNovoComum() {
            document.getElementById('modalNovoComum').style.display = 'none';
            document.getElementById('novoComumId').value = '';
            document.getElementById('novoComumNome').value = '';
        }
        
        async function carregarSubRegionaisModal() {
            const regionalId = document.getElementById('novoComumRegional').value;
            if (!regionalId) {
                document.getElementById('novoComumSubRegional').innerHTML = '<option value="">Selecione Regional primeiro...</option>';
                return;
            }
            
            const response = await fetch(`/api/regionais/${regionalId}/sub-regionais`);
            const subs = await response.json();
            
            const select = document.getElementById('novoComumSubRegional');
            select.innerHTML = '<option value="">Selecione...</option>';
            subs.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.nome;
                if (subRegionalSelecionada === s.id) option.selected = true;
                select.appendChild(option);
            });
        }
        
        // CRUD Regional
        async function criarRegional(event) {
            event.preventDefault();
            
            const id = document.getElementById('novaRegionalId').value;
            const nome = document.getElementById('novaRegionalNome').value;
            
            try {
                const response = await fetch('/api/regionais', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, nome})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Regional "${nome}" criada com sucesso!`, 'success');
                    fecharModalNovaRegional();
                    await carregarHierarquia();
                } else {
                    showNotification(data.error || 'Erro ao criar regional', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao criar regional', 'error');
            }
        }
        
        async function editarRegional(id, nomeAtual) {
            const novoNome = prompt('Novo nome para a regional:', nomeAtual);
            if (!novoNome || novoNome === nomeAtual) return;
            
            try {
                const response = await fetch(`/api/regionais/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nome: novoNome})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Regional atualizada!', 'success');
                    await carregarHierarquia();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao editar regional', 'error');
            }
        }
        
        async function deletarRegional(id) {
            if (!confirm('Tem certeza que deseja deletar esta regional? Ela deve estar vazia.')) return;
            
            try {
                const response = await fetch(`/api/regionais/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Regional deletada!', 'success');
                    if (regionalSelecionada === id) {
                        regionalSelecionada = null;
                        subRegionalSelecionada = null;
                    }
                    await carregarHierarquia();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao deletar regional', 'error');
            }
        }
        
        // CRUD Sub-Regional
        async function criarSubRegional(event) {
            event.preventDefault();
            
            const regionalId = document.getElementById('novaSubRegionalPai').value;
            const id = document.getElementById('novaSubRegionalId').value;
            const nome = document.getElementById('novaSubRegionalNome').value;
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, nome})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Sub-Regional "${nome}" criada!`, 'success');
                    fecharModalNovaSubRegional();
                    regionalSelecionada = regionalId;
                    await carregarHierarquia();
                    await carregarSubRegionaisHierarquia(regionalId);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao criar sub-regional', 'error');
            }
        }
        
        async function editarSubRegional(regionalId, subId, nomeAtual) {
            const novoNome = prompt('Novo nome para a sub-regional:', nomeAtual);
            if (!novoNome || novoNome === nomeAtual) return;
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nome: novoNome})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Sub-Regional atualizada!', 'success');
                    await carregarSubRegionaisHierarquia(regionalId);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao editar sub-regional', 'error');
            }
        }
        
        async function deletarSubRegional(regionalId, subId) {
            if (!confirm('Tem certeza? A sub-regional deve estar vazia.')) return;
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Sub-Regional deletada!', 'success');
                    if (subRegionalSelecionada === subId) {
                        subRegionalSelecionada = null;
                    }
                    await carregarSubRegionaisHierarquia(regionalId);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao deletar sub-regional', 'error');
            }
        }
        
        // Toggle horários no modal de comum
        function toggleModalHorarios(containerLabel) {
            const checkbox = containerLabel.querySelector('input[type="checkbox"]');
            const horariosContainer = containerLabel.querySelector('.modal-horarios-container');
            const inputHorarios = containerLabel.querySelector('.modal-horarios-input');
            const parentCard = containerLabel.closest('.dia-horario-config label');
            
            if (checkbox.checked) {
                horariosContainer.style.display = 'block';
                parentCard.style.borderColor = '#3b82f6';
                parentCard.style.background = '#eff6ff';
                inputHorarios.required = true;
                setTimeout(() => inputHorarios.focus(), 100);
            } else {
                horariosContainer.style.display = 'none';
                parentCard.style.borderColor = '#e5e7eb';
                parentCard.style.background = 'white';
                inputHorarios.required = false;
                inputHorarios.value = '';
            }
        }
        
        // CRUD Comum
        async function criarComum(event) {
            event.preventDefault();
            
            const regionalId = document.getElementById('novoComumRegional').value;
            const subId = document.getElementById('novoComumSubRegional').value;
            const id = document.getElementById('novoComumId').value;
            const nome = document.getElementById('novoComumNome').value;
            const fechamentoDias = parseInt(document.getElementById('novoComumFechamentoDias').value);
            
            // Coletar dias e horários
            const checkboxes = document.querySelectorAll('input[name="modal_dias_culto"]:checked');
            const dias_culto = [];
            const horarios = {};
            
            let erro = false;
            checkboxes.forEach(cb => {
                const dia = cb.value;
                dias_culto.push(dia);
                
                const inputHorarios = document.querySelector(`.modal-horarios-input[data-dia="${dia}"]`);
                const horariosTexto = inputHorarios.value.trim();
                
                if (!horariosTexto) {
                    showNotification(`Digite os horários para ${dia}`, 'error');
                    erro = true;
                    return;
                }
                
                // Parse horários (separados por vírgula)
                const horariosArray = horariosTexto.split(',')
                    .map(h => h.trim())
                    .filter(h => h)
                    .sort();
                
                if (horariosArray.length === 0) {
                    showNotification(`Digite pelo menos um horário para ${dia}`, 'error');
                    erro = true;
                    return;
                }
                
                // Validar formato HH:MM
                const formatoValido = horariosArray.every(h => /^\d{2}:\d{2}$/.test(h));
                if (!formatoValido) {
                    showNotification(`Formato inválido em ${dia}. Use HH:MM (ex: 09:00)`, 'error');
                    erro = true;
                    return;
                }
                
                horarios[dia] = horariosArray;
            });
            
            if (erro) return;
            
            if (dias_culto.length === 0) {
                showNotification('Selecione pelo menos um dia de culto', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id, 
                        nome,
                        config: {
                            dias_culto,
                            horarios,
                            fechamento_publicacao_dias: fechamentoDias
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`✅ Comum "${nome}" criado com sucesso!`, 'success');
                    fecharModalNovoComum();
                    regionalSelecionada = regionalId;
                    subRegionalSelecionada = subId;
                    await carregarHierarquia();
                    await carregarSubRegionaisHierarquia(regionalId);
                    await carregarComunsHierarquia(regionalId, subId);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao criar comum', 'error');
            }
        }
        
        // Abrir modal de editar comum
        async function abrirModalEditarComum(regionalId, subId, comumId) {
            try {
                // Buscar dados do comum
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns/${comumId}`);
                const comum = await response.json();
                
                // Buscar organistas do comum
                const orgResponse = await fetch(`/organistas?comum_id=${comumId}`);
                const organistas = await orgResponse.json();
                
                // Buscar escalas do comum
                let escalasCount = 0;
                try {
                    const escalaResponse = await fetch('/escala/atual');
                    const escalaData = await escalaResponse.json();
                    if (escalaData.escala && Array.isArray(escalaData.escala)) {
                        escalasCount = escalaData.escala.length;
                    }
                } catch (e) {
                    console.log('Não foi possível verificar escalas');
                }
                
                // Mostrar informações
                const infoBox = document.getElementById('editComumInfoBox');
                infoBox.style.display = 'block';
                
                document.getElementById('editComumOrganistasCount').textContent = organistas.length;
                document.getElementById('editComumEscalasCount').textContent = escalasCount;
                
                // Mostrar lista de organistas se houver
                const orgLista = document.getElementById('editComumOrganistasLista');
                if (organistas.length > 0) {
                    orgLista.style.display = 'block';
                    let listaHtml = '<strong>Organistas cadastrados:</strong><br>';
                    organistas.slice(0, 10).forEach(org => {
                        listaHtml += `• ${org.nome}<br>`;
                    });
                    if (organistas.length > 10) {
                        listaHtml += `<em>... e mais ${organistas.length - 10} organista(s)</em>`;
                    }
                    orgLista.innerHTML = listaHtml;
                } else {
                    orgLista.style.display = 'none';
                }
                
                // Preencher campos básicos
                document.getElementById('editComumRegionalId').value = regionalId;
                document.getElementById('editComumSubRegionalId').value = subId;
                document.getElementById('editComumId').value = comumId;
                document.getElementById('editComumNome').value = comum.nome;
                
                // Preencher fechamento
                const fechamento = comum.config?.fechamento_publicacao_dias || 7;
                document.getElementById('editComumFechamentoDias').value = fechamento;
                
                // Montar dias e horários
                const diasCulto = comum.config?.dias_culto || [];
                const horarios = comum.config?.horarios || {};
                
                const container = document.getElementById('editDiasHorariosContainer');
                container.innerHTML = '';
                
                const todosDias = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                const coresDias = {
                    'Domingo': '#dc2626',
                    'Segunda': '#2563eb',
                    'Terça': '#059669',
                    'Quarta': '#ea580c',
                    'Quinta': '#7c3aed',
                    'Sexta': '#0891b2',
                    'Sábado': '#ca8a04'
                };
                
                todosDias.forEach(dia => {
                    const checked = diasCulto.includes(dia);
                    const horasDia = horarios[dia] || [];
                    const horariosTexto = horasDia.join(', ');
                    const cor = coresDias[dia];
                    
                    const diaHtml = `
                        <div class="dia-horario-config">
                            <label style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: ${checked ? cor + '15' : 'white'}; border: 2px solid ${checked ? cor : '#e5e7eb'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" name="edit_dias_culto" value="${dia}" ${checked ? 'checked' : ''} onchange="toggleModalHorariosEdit(this.parentElement.parentElement.parentElement)" style="width: 18px; height: 18px;">
                                    <strong style="font-size: 1.05em; color: ${cor};">${dia === 'Domingo' ? '☀️' : '📅'} ${dia}${dia !== 'Domingo' && dia !== 'Sábado' ? '-feira' : ''}</strong>
                                </div>
                                <div class="modal-horarios-container" style="display: ${checked ? 'block' : 'none'}; padding-left: 28px;">
                                    <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 4px;">⏰ Horários:</label>
                                    <input type="text" class="modal-horarios-input" data-dia="${dia}" value="${horariosTexto}" placeholder="Ex: 09:00, 18:00" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95em;" ${checked ? 'required' : ''}>
                                </div>
                            </label>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', diaHtml);
                });
                
                // Mostrar modal
                document.getElementById('modalEditarComum').style.display = 'flex';
                
            } catch (error) {
                console.error('Erro ao carregar dados do comum:', error);
                showNotification('Erro ao carregar dados do comum', 'error');
            }
        }
        
        function fecharModalEditarComum() {
            document.getElementById('modalEditarComum').style.display = 'none';
        }
        
        function toggleModalHorariosEdit(containerLabel) {
            const checkbox = containerLabel.querySelector('input[type="checkbox"]');
            const horariosContainer = containerLabel.querySelector('.modal-horarios-container');
            const inputHorarios = containerLabel.querySelector('.modal-horarios-input');
            const parentCard = containerLabel.closest('.dia-horario-config label');
            const dia = checkbox.value;
            
            // Cores por dia
            const coresDias = {
                'Domingo': '#dc2626',
                'Segunda': '#2563eb',
                'Terça': '#059669',
                'Quarta': '#ea580c',
                'Quinta': '#7c3aed',
                'Sexta': '#0891b2',
                'Sábado': '#ca8a04'
            };
            const cor = coresDias[dia];
            
            if (checkbox.checked) {
                horariosContainer.style.display = 'block';
                parentCard.style.borderColor = cor;
                parentCard.style.background = cor + '15';
                inputHorarios.required = true;
                setTimeout(() => inputHorarios.focus(), 100);
            } else {
                horariosContainer.style.display = 'none';
                parentCard.style.borderColor = '#e5e7eb';
                parentCard.style.background = 'white';
                inputHorarios.required = false;
                inputHorarios.value = '';
            }
        }
        
        async function salvarEdicaoComum(event) {
            event.preventDefault();
            
            const regionalId = document.getElementById('editComumRegionalId').value;
            const subId = document.getElementById('editComumSubRegionalId').value;
            const comumId = document.getElementById('editComumId').value;
            const nome = document.getElementById('editComumNome').value;
            const fechamentoDias = parseInt(document.getElementById('editComumFechamentoDias').value);
            
            // Coletar dias e horários
            const checkboxes = document.querySelectorAll('input[name="edit_dias_culto"]:checked');
            const dias_culto = [];
            const horarios = {};
            
            let erro = false;
            checkboxes.forEach(cb => {
                const dia = cb.value;
                dias_culto.push(dia);
                
                const inputHorarios = document.querySelector(`.modal-horarios-input[data-dia="${dia}"]`);
                const horariosTexto = inputHorarios.value.trim();
                
                if (!horariosTexto) {
                    showNotification(`Digite os horários para ${dia}`, 'error');
                    erro = true;
                    return;
                }
                
                // Parse horários
                const horariosArray = horariosTexto.split(',')
                    .map(h => h.trim())
                    .filter(h => h)
                    .sort();
                
                if (horariosArray.length === 0) {
                    showNotification(`Digite pelo menos um horário para ${dia}`, 'error');
                    erro = true;
                    return;
                }
                
                // Validar formato HH:MM
                const formatoValido = horariosArray.every(h => /^\d{2}:\d{2}$/.test(h));
                if (!formatoValido) {
                    showNotification(`Formato inválido em ${dia}. Use HH:MM`, 'error');
                    erro = true;
                    return;
                }
                
                horarios[dia] = horariosArray;
            });
            
            if (erro) return;
            
            if (dias_culto.length === 0) {
                showNotification('Selecione pelo menos um dia de culto', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns/${comumId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome,
                        config: {
                            dias_culto,
                            horarios,
                            fechamento_publicacao_dias: fechamentoDias
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('✅ Comum atualizado com sucesso!', 'success');
                    fecharModalEditarComum();
                    await carregarComunsHierarquia(regionalId, subId);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao atualizar comum', 'error');
            }
        }
        
        async function deletarComum(regionalId, subId, comumId) {
            try {
                // Primeiro, buscar informações do comum
                const infoResponse = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns/${comumId}`);
                const comumInfo = await infoResponse.json();
                
                // Buscar organistas do comum
                const orgResponse = await fetch(`/organistas?comum_id=${comumId}`);
                const organistas = await orgResponse.json();
                
                // Buscar escalas do comum
                let escalasCount = 0;
                try {
                    const escalaResponse = await fetch('/escala/atual');
                    const escalaData = await escalaResponse.json();
                    if (escalaData.escala && Array.isArray(escalaData.escala)) {
                        escalasCount = escalaData.escala.length;
                    }
                } catch (e) {
                    console.log('Não foi possível verificar escalas');
                }
                
                // Montar mensagem com informações
                let mensagem = `🏛️ Comum: ${comumInfo.nome}\n`;
                mensagem += `📋 ID: ${comumId}\n\n`;
                mensagem += `📊 Dados Cadastrados:\n`;
                mensagem += `👥 Organistas: ${organistas.length}\n`;
                mensagem += `📅 Escalas: ${escalasCount}\n\n`;
                
                if (organistas.length > 0 || escalasCount > 0) {
                    mensagem += `⚠️ ATENÇÃO: Este comum possui dados cadastrados!\n\n`;
                    
                    if (organistas.length > 0) {
                        mensagem += `Organistas cadastrados:\n`;
                        organistas.slice(0, 5).forEach(org => {
                            mensagem += `  • ${org.nome}\n`;
                        });
                        if (organistas.length > 5) {
                            mensagem += `  ... e mais ${organistas.length - 5} organista(s)\n`;
                        }
                        mensagem += `\n`;
                    }
                    
                    mensagem += `❌ Não é possível deletar este comum.\n`;
                    mensagem += `Por favor, remova primeiro:\n`;
                    mensagem += `1. Todas as escalas (Rodízios > Carregar/Deletar Escala)\n`;
                    mensagem += `2. Todos os organistas (Encarregado Local > Organistas)\n`;
                    
                    alert(mensagem);
                    return;
                }
                
                // Se chegou aqui, o comum está vazio
                mensagem += `✅ Este comum está vazio e pode ser deletado.\n\n`;
                mensagem += `Deseja realmente deletar o comum "${comumInfo.nome}"?`;
                
                if (!confirm(mensagem)) return;
                
                // Prosseguir com a exclusão
                const response = await fetch(`/api/regionais/${regionalId}/sub-regionais/${subId}/comuns/${comumId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('✅ Comum deletado com sucesso!', 'success');
                    await carregarComunsHierarquia(regionalId, subId);
                } else {
                    showNotification(data.error || 'Erro ao deletar comum', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('❌ Erro ao processar solicitação', 'error');
            }
        }
        
        // ==================== Gerenciamento de Usuários ====================
        
        async function carregarUsuarios() {
            if (contextoAtual.nivel !== 'master') return;
            
            try {
                const response = await fetch('/api/usuarios');
                const usuarios = await response.json();
                
                const container = document.getElementById('listaUsuarios');
                
                if (usuarios.length === 0) {
                    container.innerHTML = '<p style="color: #999;">Nenhum usuário cadastrado</p>';
                    return;
                }
                
                // Criar tabela
                let html = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f3f4f6; text-align: left;">
                                <th style="padding: 12px; border: 1px solid #ddd;">ID</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Nome</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Tipo</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Contexto</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Email</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Status</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                usuarios.forEach(user => {
                    const tipoLabel = {
                        'master': '🔐 Master',
                        'admin_regional': '🏙️ Admin Regional',
                        'encarregado_sub_regional': '📍 Enc. Sub-Regional',
                        'encarregado_comum': '⛪ Enc. Comum'
                    }[user.tipo] || user.tipo;
                    
                    const statusBadge = user.ativo 
                        ? '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Ativo</span>'
                        : '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">Inativo</span>';
                    
                    html += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">${user.id}</td>
                            <td style="padding: 12px;"><strong>${user.nome}</strong></td>
                            <td style="padding: 12px;">${tipoLabel}</td>
                            <td style="padding: 12px;">${user.contexto_id || '-'}</td>
                            <td style="padding: 12px;">${user.email || '-'}</td>
                            <td style="padding: 12px;">${statusBadge}</td>
                            <td style="padding: 12px;">
                                <button class="btn" style="padding: 5px 10px; background: #3b82f6; color: white;" 
                                    onclick="editarUsuario('${user.id}')">✏️</button>
                                ${user.id !== 'admin_master' ? `
                                    <button class="btn" style="padding: 5px 10px; background: #ef4444; color: white;" 
                                        onclick="deletarUsuario('${user.id}')">🗑️</button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showNotification('Erro ao carregar usuários', 'error');
            }
        }
        
        function mostrarModalNovoUsuario() {
            document.getElementById('modalNovoUsuario').style.display = 'flex';
        }
        
        function fecharModalNovoUsuario() {
            document.getElementById('modalNovoUsuario').style.display = 'none';
            document.getElementById('novoUsuarioId').value = '';
            document.getElementById('novoUsuarioNome').value = '';
            document.getElementById('novoUsuarioTipo').value = '';
            document.getElementById('novoUsuarioContexto').innerHTML = '<option value="">Selecione o tipo primeiro...</option>';
            document.getElementById('novoUsuarioEmail').value = '';
            document.getElementById('novoUsuarioTelefone').value = '';
            document.getElementById('novoUsuarioSenha').value = '';
            document.getElementById('divContextoUsuario').style.display = 'none';
        }
        
        async function atualizarContextoUsuario() {
            const tipo = document.getElementById('novoUsuarioTipo').value;
            const divContexto = document.getElementById('divContextoUsuario');
            const selectContexto = document.getElementById('novoUsuarioContexto');
            
            if (tipo === 'master') {
                divContexto.style.display = 'none';
                selectContexto.innerHTML = '<option value="">Não requer contexto</option>';
                return;
            }
            
            divContexto.style.display = 'block';
            selectContexto.innerHTML = '<option value="">Carregando...</option>';
            
            try {
                if (tipo === 'admin_regional') {
                    // Carregar regionais
                    const response = await fetch('/api/regionais');
                    const regionais = await response.json();
                    
                    selectContexto.innerHTML = '<option value="">Selecione Regional...</option>';
                    regionais.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r.id;
                        option.textContent = r.nome;
                        selectContexto.appendChild(option);
                    });
                    
                } else if (tipo === 'encarregado_sub_regional') {
                    // Carregar sub-regionais de todas regionais
                    const response = await fetch('/api/regionais');
                    const regionais = await response.json();
                    
                    selectContexto.innerHTML = '<option value="">Selecione Sub-Regional...</option>';
                    
                    for (const regional of regionais) {
                        const subResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais`);
                        const subs = await subResponse.json();
                        
                        subs.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub.id;
                            option.textContent = `${regional.nome} › ${sub.nome}`;
                            selectContexto.appendChild(option);
                        });
                    }
                    
                } else if (tipo === 'encarregado_comum') {
                    // Carregar todos comuns
                    const response = await fetch('/api/regionais');
                    const regionais = await response.json();
                    
                    selectContexto.innerHTML = '<option value="">Selecione Comum...</option>';
                    
                    for (const regional of regionais) {
                        const subResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais`);
                        const subs = await subResponse.json();
                        
                        for (const sub of subs) {
                            const comunsResponse = await fetch(`/api/regionais/${regional.id}/sub-regionais/${sub.id}/comuns`);
                            const comuns = await comunsResponse.json();
                            
                            comuns.forEach(comum => {
                                const option = document.createElement('option');
                                option.value = comum.id;
                                option.textContent = `${regional.nome} › ${sub.nome} › ${comum.nome}`;
                                selectContexto.appendChild(option);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar contextos:', error);
                selectContexto.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }
        
        async function criarUsuario(event) {
            event.preventDefault();
            
            const id = document.getElementById('novoUsuarioId').value;
            const nome = document.getElementById('novoUsuarioNome').value;
            const tipo = document.getElementById('novoUsuarioTipo').value;
            const contexto_id = document.getElementById('novoUsuarioContexto').value;
            const email = document.getElementById('novoUsuarioEmail').value;
            const telefone = document.getElementById('novoUsuarioTelefone').value;
            const senha = document.getElementById('novoUsuarioSenha').value;
            
            try {
                const response = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id,
                        nome,
                        tipo,
                        contexto_id,
                        email,
                        telefone,
                        senha: senha || 'senha123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Usuário "${nome}" criado com sucesso! Login: ${id} / Senha: ${senha || 'senha123'}`, 'success');
                    fecharModalNovoUsuario();
                    await carregarUsuarios();
                } else {
                    showNotification(data.error || 'Erro ao criar usuário', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao criar usuário', 'error');
            }
        }
        
        async function editarUsuario(userId) {
            const novoNome = prompt('Novo nome para o usuário:');
            if (!novoNome) return;
            
            try {
                const response = await fetch(`/api/usuarios/${userId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nome: novoNome})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Usuário atualizado!', 'success');
                    await carregarUsuarios();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao editar usuário', 'error');
            }
        }
        
        async function deletarUsuario(userId) {
            if (!confirm(`Tem certeza que deseja deletar o usuário "${userId}"?`)) return;
            
            try {
                const response = await fetch(`/api/usuarios/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Usuário deletado!', 'success');
                    await carregarUsuarios();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao deletar usuário', 'error');
            }
        }
        
        // Toggle exibição de horários quando marca/desmarca dia
        function toggleHorarios(checkbox) {
            const container = checkbox.closest('.dia-horario-group').querySelector('.horarios-container');
            if (checkbox.checked) {
                container.style.display = 'block';
                // Se não tem horário, adicionar um padrão
                const dia = checkbox.value;
                const horariosDiv = document.getElementById(`horarios${dia}`);
                if (horariosDiv.children.length === 0) {
                    adicionarHorario(dia, '09:00'); // Horário padrão
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Adicionar campo de horário para um dia específico
        function adicionarHorario(dia, valorInicial = '') {
            const container = document.getElementById(`horarios${dia}`);
            
            const horarioItem = document.createElement('div');
            horarioItem.className = 'horario-item';
            horarioItem.style.cssText = 'display: flex; align-items: center; gap: 5px; background: white; padding: 5px 10px; border-radius: 4px; border: 1px solid #cbd5e1;';
            
            const input = document.createElement('input');
            input.type = 'time';
            input.className = 'horario-input';
            input.dataset.dia = dia;
            input.value = valorInicial;
            input.required = true;
            input.style.cssText = 'border: none; padding: 2px; font-size: 14px;';
            
            const btnRemover = document.createElement('button');
            btnRemover.type = 'button';
            btnRemover.textContent = '✕';
            btnRemover.style.cssText = 'background: #ef4444; color: white; border: none; border-radius: 3px; width: 22px; height: 22px; cursor: pointer; font-size: 12px; padding: 0;';
            btnRemover.onclick = () => {
                horarioItem.remove();
            };
            
            horarioItem.appendChild(input);
            horarioItem.appendChild(btnRemover);
            container.appendChild(horarioItem);
        }
        
        // Remover horário específico
        function removerHorario(button) {
            button.closest('.horario-item').remove();
        }
        
        // Configuração do Comum
        async function carregarConfigComum() {
            if (!contextoAtual.comum) return;
            
            try {
                const response = await fetch(`/api/comuns/${contextoAtual.comum.id}/config`);
                const config = await response.json();
                
                // Configurar checkboxes de dias e seus horários
                const checkboxes = document.querySelectorAll('input[name="dias_culto"]');
                checkboxes.forEach(cb => {
                    const dia = cb.value;
                    const estaMarcado = config.dias_culto && config.dias_culto.includes(dia);
                    cb.checked = estaMarcado;
                    
                    // Mostrar/ocultar container de horários
                    const container = cb.closest('.dia-horario-group').querySelector('.horarios-container');
                    container.style.display = estaMarcado ? 'block' : 'none';
                    
                    // Limpar horários existentes
                    const horariosDiv = document.getElementById(`horarios${dia}`);
                    horariosDiv.innerHTML = '';
                    
                    // Carregar horários salvos
                    if (estaMarcado && config.horarios && config.horarios[dia]) {
                        config.horarios[dia].forEach(horario => {
                            adicionarHorario(dia, horario);
                        });
                    } else if (estaMarcado) {
                        // Se está marcado mas não tem horário, adicionar padrão
                        adicionarHorario(dia, '09:00');
                    }
                });
                
                // Configurar período
                if (config.periodo) {
                    document.getElementById('configComumInicio').value = config.periodo.inicio;
                    document.getElementById('configComumFim').value = config.periodo.fim;
                }
                
                // Configurar fechamento de publicação
                if (config.fechamento_publicacao_dias) {
                    document.getElementById('configFechamentoDias').value = config.fechamento_publicacao_dias;
                }
            } catch (error) {
                console.error('Erro ao carregar config do comum:', error);
            }
        }
        
        async function salvarConfigComum(event) {
            event.preventDefault();
            
            if (!contextoAtual.comum) {
                showNotification('Nenhum comum selecionado', 'error');
                return;
            }
            
            // Coletar dias marcados
            const checkboxes = document.querySelectorAll('input[name="dias_culto"]:checked');
            const dias_culto = Array.from(checkboxes).map(cb => cb.value);
            
            if (dias_culto.length === 0) {
                showNotification('Selecione pelo menos um dia de culto', 'error');
                return;
            }
            
            // Coletar horários de cada dia
            const horarios = {};
            for (const dia of dias_culto) {
                const inputsHorarios = document.querySelectorAll(`.horario-input[data-dia="${dia}"]`);
                const horariosArray = Array.from(inputsHorarios).map(input => input.value).filter(h => h);
                
                if (horariosArray.length === 0) {
                    showNotification(`Adicione pelo menos um horário para ${dia}`, 'error');
                    return;
                }
                
                // Ordenar horários
                horariosArray.sort();
                horarios[dia] = horariosArray;
            }
            
            const inicio = document.getElementById('configComumInicio').value;
            const fim = document.getElementById('configComumFim').value;
            const fechamentoDias = parseInt(document.getElementById('configFechamentoDias').value);
            
            try {
                const response = await fetch(`/api/comuns/${contextoAtual.comum.id}/config`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        dias_culto,
                        horarios,
                        periodo: {
                            inicio,
                            fim
                        },
                        fechamento_publicacao_dias: fechamentoDias
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('✅ Configurações salvas com sucesso!', 'success');
                    // Recarregar config para confirmar
                    await carregarConfigComum();
                } else {
                    showNotification(data.error || 'Erro ao salvar', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('Erro ao salvar configurações', 'error');
            }
        }

        // Executar inicialização quando página carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
