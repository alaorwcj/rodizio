<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rod√≠zio de Organistas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .user-selector {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-selector label {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .user-selector select {
            padding: 10px 20px;
            border-radius: 5px;
            border: 2px solid rgba(255,255,255,0.5);
            font-size: 1em;
            cursor: pointer;
            background: white;
            min-width: 200px;
            font-weight: 500;
        }
        
        .user-selector select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        
        .user-indicator {
            background: #fbbf24;
            color: #78350f;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            background: #e0e0e0;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        .card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: #fbbf24;
            color: #78350f;
            font-weight: 600;
        }
        
        .btn-warning:hover {
            background: #f59e0b;
        }
        
        .info-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 5px;
        }
        
        .info-badge.green {
            background: #d1fae5;
            color: #065f46;
        }
        
        .info-badge.blue {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .escala-atual {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .escala-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-top: 4px solid #667eea;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .escala-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .escala-item.domingo {
            border-top-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        
        .escala-item.terca {
            border-top-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }
        
        .escala-item.passado {
            opacity: 0.5;
        }
        
        .escala-date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .escala-dia-numero {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .escala-item.domingo .escala-dia-numero {
            color: #10b981;
        }
        
        .escala-item.terca .escala-dia-numero {
            color: #fbbf24;
        }
        
        .escala-dia-semana {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        
        .escala-mes-ano {
            font-size: 0.9em;
            color: #666;
        }
        
        .escala-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .escala-badge.domingo {
            background: #d1fae5;
            color: #065f46;
        }
        
        .escala-badge.terca {
            background: #fef3c7;
            color: #78350f;
        }
        
        .escala-divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            margin: 15px 0;
        }
        
        .escala-servicos {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .escala-servico {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .escala-item.domingo .escala-servico {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: #10b981;
        }
        
        .escala-item.terca .escala-servico {
            background: rgba(251, 191, 36, 0.05);
            border-left-color: #fbbf24;
        }
        
        .escala-servico-icon {
            font-size: 1.3em;
        }
        
        .escala-servico-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .escala-tipo {
            font-size: 0.75em;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .escala-organista {
            font-size: 1em;
            font-weight: 600;
            color: #333;
        }
        
        .escala-vazio {
            color: #999;
            font-style: italic;
            font-size: 0.95em;
        }
        
        .btn-adicionar-agenda {
            transition: all 0.3s ease;
        }
        
        .btn-adicionar-agenda:hover {
            background: #2563eb !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .btn-adicionar-agenda:active {
            transform: translateY(0);
        }
        
        .dashboard-section {
            margin-bottom: 30px;
        }
        
        .dashboard-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .no-escala {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #667eea;
            color: white;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéπ Rod√≠zio de Organistas - Vila Paula</h1>
            <p>Per√≠odo: {{ cfg.bimestre.inicio | date_br }} at√© {{ cfg.bimestre.fim | date_br }}</p>
            
            <div class="user-selector">
                <label>Voc√™ est√° logado como:</label>
                <span class="user-indicator">
                    {% if user.is_admin %}
                         {{ user.nome }} (Administrador)
                    {% else %}
                        üë§ {{ user.nome }} (Organista)
                    {% endif %}
                </span>
                <button onclick="trocarSenha()" class="btn btn-warning" style="margin-left: 10px;">
                    üîê Trocar Senha
                </button>
                <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px;">
                    üö™ Sair
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            {% if user.is_admin %}
            <button class="nav-tab" onclick="showTab('organistas')">üë• Organistas</button>
            <button class="nav-tab" onclick="showTab('admin-indisp')">üóìÔ∏è Restri√ß√µes de Dias</button>
            <button class="nav-tab" onclick="showTab('config')">‚öôÔ∏è Configura√ß√µes</button>
            {% else %}
            <button class="nav-tab" onclick="showTab('indisponibilidades')">üóìÔ∏è Restri√ß√µes de Dias</button>
            {% endif %}
            <button class="nav-tab" onclick="showTab('escala')">üìã Culto Oficial</button>
            <button class="nav-tab" onclick="showTab('rjm')" style="display: flex; align-items: center; gap: 6px;">
                <img src="{{ url_for('static', filename='icons8-children-48.png') }}" alt="RJM" style="width: 18px; height: 18px;">
                RJM
            </button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-panel active">
                <div class="card">
                    <h2>üéπ Rod√≠zio de Organistas - Vila Paula</h2>
                    
                    <div style="margin-top: 20px;">
                        <span class="info-badge green">{{ cfg.bimestre.inicio | date_br }}</span>
                        <span class="info-badge blue">at√©</span>
                        <span class="info-badge green">{{ cfg.bimestre.fim | date_br }}</span>
                    </div>
                </div>
                
                {% if not user.is_admin %}
                <!-- Meus Dias de Rod√≠zio (apenas para organistas) -->
                <div class="card">
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">üéπ Meus Dias de Rod√≠zio</h2>
                        <div id="meusDias" class="escala-atual">
                            <div class="no-escala">Carregando seus dias...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if user.is_admin %}
                <!-- Todas as Escalas (apenas para admin) -->
                <div class="card">
                    <div class="dashboard-section">
                        <h2 class="dashboard-title">üìÖ Pr√≥ximas Escalas</h2>
                        <div id="escalaAtual" class="escala-atual">
                            <div class="no-escala">Carregando escala...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <h2>Status Atual</h2>
                    <p id="statusOrganistas">Carregando...</p>
                    <p id="statusIndisponibilidades">Carregando...</p>
                    <p id="statusEscala">Carregando...</p>
                </div>
            </div>
            
            <!-- Organistas Tab -->
            <div id="organistas" class="tab-panel">
                {% if user.is_coordenador %}
                <div class="card">
                    <h2>Cadastro de Organistas</h2>
                    <div id="alertOrganista" class="alert hidden"></div>
                    
                    <form id="formOrganista" onsubmit="addOrganista(event)">
                        <div class="form-group">
                            <label>ID (√∫nico):</label>
                            <input type="text" id="orgId" required>
                        </div>
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="orgNome" required>
                        </div>
                        <div class="form-group">
                            <label>Tipos (Ctrl+clique para m√∫ltiplos):</label>
                            <select id="orgTipos" multiple required>
                                <option value="Meia-hora">Meia-hora</option>
                                <option value="Culto">Culto</option>
                                <option value="RJM">RJM (Reuni√£o de Jovens e Menores)</option>
                            </select>
                            <small style="color: #666;">Selecione os tipos que a organista pode tocar</small>
                        </div>
                        <div class="form-group">
                            <label>Dias Permitidos (Ctrl+clique para m√∫ltiplos):</label>
                            <select id="orgDias" multiple required>
                                <option value="Domingo">Domingo</option>
                                <option value="Ter√ßa">Ter√ßa</option>
                            </select>
                            <small style="color: #666;">RJM √© sempre aos domingos</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar Organista</button>
                    </form>
                </div>
                {% endif %}
                
                <div class="card">
                    <h2>Organistas Cadastrados</h2>
                    <table id="tableOrganistas">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipos</th>
                                <th>Dias</th>
                                {% if user.is_admin %}
                                <th>A√ß√µes</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="tbodyOrganistas">
                            <tr><td colspan="4" style="text-align: center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Indisponibilidades Tab -->
            <div id="indisponibilidades" class="tab-panel">
                <div class="card">
                    <h2>üóìÔ∏è Restri√ß√µes de Dias</h2>
                    <p>Marque as datas em que voc√™ N√ÉO poder√° tocar no per√≠odo atual.</p>
                    <div id="alertIndisp" class="alert hidden"></div>
                    
                    <div id="calendarioIndisp" style="margin-top: 20px;">
                        <!-- Calend√°rio ser√° gerado dinamicamente -->
                    </div>
                    
                    <div id="chipsDatas" style="margin-top: 20px;">
                        <!-- Chips com datas selecionadas -->
                    </div>
                </div>
            </div>
            
            <!-- Admin - Todas Indisponibilidades Tab -->
            <div id="admin-indisp" class="tab-panel">
                <div class="card">
                    <h2>üîê Gerenciar Restri√ß√µes de Dias</h2>
                    <p>Como administrador, voc√™ pode visualizar e gerenciar as restri√ß√µes de dias de todas as organistas.</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="font-weight: bold;">Filtrar por organista:</label>
                        <select id="filterOrganista" onchange="loadAdminIndisp()" style="padding: 8px; margin-left: 10px; border-radius: 5px;">
                            <option value="">Todas</option>
                        </select>
                        <button onclick="loadAdminIndisp()" class="btn btn-primary" style="margin-left: 10px;">üîÑ Atualizar</button>
                    </div>
                    
                    <div id="adminIndispList" style="margin-top: 20px;">
                        <!-- Lista ser√° carregada via JS -->
                    </div>
                </div>
            </div>
            
            <!-- Configura√ß√µes Tab -->
            <div id="config" class="tab-panel">
                <div class="card">
                    <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                    <div id="alertConfig" class="alert hidden"></div>
                    
                    <form id="formConfig" onsubmit="saveConfig(event)">
                        <div class="form-group">
                            <label>Data de In√≠cio do Per√≠odo:</label>
                            <input type="date" id="configInicio" value="{{ cfg.bimestre.inicio }}" required>
                        </div>
                        <div class="form-group">
                            <label>Data de Fim do Per√≠odo:</label>
                            <input type="date" id="configFim" value="{{ cfg.bimestre.fim }}" required>
                        </div>
                        <div class="form-group">
                            <label>Prazo para marcar indisponibilidade antes da publica√ß√£o (dias):</label>
                            <input type="number" id="configFechamento" value="{{ cfg.fechamento_publicacao_dias }}" min="0" max="30" required>
                        </div>
                        <button type="submit" class="btn btn-success">üíæ Salvar Configura√ß√µes</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üìä Estat√≠sticas do Sistema</h2>
                    <div id="statsSystem">Carregando...</div>
                </div>
            </div>
            
            <!-- Escala Tab -->
            <div id="escala" class="tab-panel">
                {% if user.is_admin %}
                <div class="card">
                    <h2>üìã Gerenciamento de Escala</h2>
                    <div id="alertEscala" class="alert hidden"></div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button onclick="loadEscalaAtual()" class="btn" style="background: #64748b; color: white;">
                            üîÑ Carregar Escala Atual
                        </button>
                        <button onclick="criarEscalaVazia()" class="btn btn-success">
                            ‚ûï Criar Nova Escala
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ÔøΩ Culto Oficial</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if user.is_admin %}
                            <button onclick="salvarTodasAlteracoes()" class="btn" style="background: #10b981; color: white;">
                                üíæ Salvar Todas as Altera√ß√µes
                            </button>
                            {% endif %}
                            <button onclick="exportarPDF()" class="btn" style="background: #dc2626; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-pdf.gif') }}" alt="PDF" style="width: 20px; height: 20px;">
                                Exportar PDF
                            </button>
                            <button onclick="compartilharWhatsApp()" class="btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-whatsapp.gif') }}" alt="WhatsApp" style="width: 20px; height: 20px;">
                                Compartilhar no WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <div id="infoEscala" style="margin-bottom: 15px; color: #666;">
                        <p>Carregando...</p>
                    </div>
                    
                    <!-- Conte√∫do da escala ser√° inserido aqui -->
                    <div id="escalaContainer">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala publicada ainda.</p>
                            {% if user.is_admin %}
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Nova Escala" acima para come√ßar.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä Estat√≠sticas do Culto Oficial</h2>
                    <div id="statsEscala">
                        <p style="color: #666;">Gere uma escala para ver as estat√≠sticas.</p>
                    </div>
                </div>
            </div>
            
            <!-- RJM Tab -->
            <div id="rjm" class="tab-panel">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <img src="{{ url_for('static', filename='icons8-children-48.png') }}" alt="RJM" style="width: 32px; height: 32px;">
                            RJM - Reuni√£o de Jovens e Menores
                        </h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% if user.is_admin %}
                            <button onclick="salvarTodasAlteracoesRJM()" class="btn" style="background: #10b981; color: white;">
                                üíæ Salvar Todas as Altera√ß√µes
                            </button>
                            <button onclick="criarEscalaRJM()" class="btn btn-primary">
                                ‚ûï Criar Escala RJM Vazia
                            </button>
                            {% endif %}
                            <button onclick="exportarPDFRJM()" class="btn" style="background: #dc2626; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-pdf.gif') }}" alt="PDF" style="width: 20px; height: 20px;">
                                Exportar PDF
                            </button>
                            <button onclick="compartilharWhatsAppRJM()" class="btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <img src="{{ url_for('static', filename='icons8-whatsapp.gif') }}" alt="WhatsApp" style="width: 20px; height: 20px;">
                                Compartilhar no WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #92400e;">‚ÑπÔ∏è Sobre a RJM</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                            <li><strong>Hor√°rio:</strong> Domingos √†s 10:00</li>
                            <li><strong>Dura√ß√£o:</strong> Aproximadamente 1h30 (10:00 - 11:30)</li>
                            <li><strong>Organistas:</strong> Apenas 1 organista por domingo (n√£o h√° meia-hora)</li>
                        </ul>
                    </div>
                    
                    <div id="infoEscalaRJM" style="margin-bottom: 15px; color: #666;">
                        <p>Carregando...</p>
                    </div>
                    
                    <div id="escalaRJMContainer">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala RJM publicada ainda.</p>
                            {% if user.is_admin %}
                            <p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Escala RJM Vazia" acima para come√ßar.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä Estat√≠sticas da Escala RJM</h2>
                    <div id="statsEscalaRJM">
                        <p style="color: #666;">Gere uma escala para ver as estat√≠sticas.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Organista -->
    <div id="modalEditarOrganista" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">‚úèÔ∏è Editar Organista</h2>
                <button class="modal-close" onclick="fecharModalEditar()">√ó</button>
            </div>
            <form id="formEditarOrganista" onsubmit="salvarEdicaoOrganista(event)">
                <input type="hidden" id="editOrgId">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="editOrgNome" required>
                </div>
                <div class="form-group">
                    <label>Tipos (Ctrl+clique para m√∫ltiplos):</label>
                    <select id="editOrgTipos" multiple required style="min-height: 120px;">
                        <option value="Meia-hora">Meia-hora</option>
                        <option value="Culto">Culto</option>
                        <option value="RJM">RJM (Reuni√£o de Jovens e Menores)</option>
                    </select>
                    <small style="color: #666;">Selecione os tipos que a organista pode tocar</small>
                </div>
                <div class="form-group">
                    <label>Dias Permitidos (Ctrl+clique para m√∫ltiplos):</label>
                    <select id="editOrgDias" multiple required style="min-height: 80px;">
                        <option value="Domingo">Domingo</option>
                        <option value="Ter√ßa">Ter√ßa</option>
                    </select>
                    <small style="color: #666;">RJM √© sempre aos domingos</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn" style="flex: 1; background: #10b981; color: white;">üíæ Salvar Altera√ß√µes</button>
                    <button type="button" class="btn" style="flex: 1; background: #6b7280; color: white;" onclick="fecharModalEditar()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const currentUserId = '{{ user.id }}';
        const isAdmin = {{ 'true' if user.is_admin else 'false' }};
        // Compatibilidade
        const isCoord = isAdmin;
        let organistas = [];
        let indisponibilidades = [];
        
        // Navega√ß√£o entre tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Carregar dados espec√≠ficos de cada aba
            if (tabName === 'indisponibilidades') {
                loadIndisponibilidades();
            } else if (tabName === 'admin-indisp') {
                loadAdminIndisp();
            } else if (tabName === 'organistas') {
                loadOrganistas();
            } else if (tabName === 'rjm') {
                loadEscalaRJM();
            }
        }
        
        // Trocar Senha
        function trocarSenha() {
            window.location.href = '/trocar-senha';
        }
        
        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                window.location.href = '/logout';
            }
        }
        
        // Carregar organistas
        async function loadOrganistas() {
            try {
                const response = await fetch('/organistas');
                organistas = await response.json();
                
                // Atualizar tabela
                const tbody = document.getElementById('tbodyOrganistas');
                tbody.innerHTML = '';
                
                if (!isCoord) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">Apenas coordenador pode gerenciar organistas.</td></tr>';
                    return;
                }
                
                organistas.forEach(org => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${org.nome}</td>
                        <td>${org.tipos.join(', ')}</td>
                        <td>${org.dias_permitidos.join(', ')}</td>
                        <td>
                            <button class="btn" style="background: #3b82f6; color: white; margin-right: 5px;" onclick="editarOrganista('${org.id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="deleteOrganista('${org.id}')">üóëÔ∏è Remover</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Atualizar dashboard
                document.getElementById('statusOrganistas').textContent = 
                    `‚úÖ ${organistas.length} organista(s) cadastrado(s)`;
                    
                // Atualizar contador de indisponibilidades
                loadIndispCount();
            } catch (error) {
                console.error('Erro ao carregar organistas:', error);
            }
        }
        
        // Carregar contagem de indisponibilidades
        async function loadIndispCount() {
            try {
                const response = await fetch('/indisponibilidades');
                const indisp = await response.json();
                document.getElementById('statusIndisponibilidades').textContent = 
                    `‚úÖ ${indisp.length} indisponibilidade(s) marcada(s)`;
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Renderizar escala atual no dashboard
        async function renderEscalaAtual() {
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                console.log('Dados recebidos da API:', data);
                const escala = data.escala || [];
                console.log('Escala extra√≠da:', escala);
                
                const container = document.getElementById('escalaAtual');
                
                if (!escala || escala.length === 0) {
                    container.innerHTML = '<div class="no-escala">Nenhuma escala cadastrada ainda</div>';
                    document.getElementById('statusEscala').textContent = '‚ö†Ô∏è Nenhuma escala cadastrada';
                    return;
                }
                
                // Pegar data atual para compara√ß√£o
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Filtrar e ordenar: pegar pr√≥ximos 10 eventos a partir de hoje
                const proximasEscalas = escala
                    .filter(item => {
                        const dataEscala = new Date(item.data);
                        return dataEscala >= hoje;
                    })
                    .sort((a, b) => new Date(a.data) - new Date(b.data))
                    .slice(0, 10);
                
                if (proximasEscalas.length === 0) {
                    container.innerHTML = '<div class="no-escala">Todas as escalas j√° passaram</div>';
                    document.getElementById('statusEscala').textContent = '‚úÖ Todas as escalas j√° passaram';
                    return;
                }
                
                // Renderizar as pr√≥ximas escalas
                container.innerHTML = proximasEscalas.map(item => {
                    const data = new Date(item.data);
                    const dataEscala = new Date(item.data);
                    const passado = dataEscala < hoje;
                    
                    const dia = data.getDate();
                    const nomeMes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][data.getMonth()];
                    const ano = data.getFullYear();
                    
                    const diaSemana = item.dia_semana === 'Sunday' ? 'Domingo' : 'Ter√ßa-feira';
                    const tipoDia = item.dia_semana === 'Sunday' ? 'domingo' : 'terca';
                    const emoji = diaSemana === 'Domingo' ? 'üôè' : 'üìñ';
                    
                    return `
                        <div class="escala-item ${tipoDia} ${passado ? 'passado' : ''}">
                            <div class="escala-date-box">
                                <div class="escala-dia-numero">${dia}</div>
                                <div class="escala-dia-semana">${emoji} ${diaSemana}</div>
                                <div class="escala-mes-ano">${nomeMes} ${ano}</div>
                            </div>
                            
                            <div class="escala-divider"></div>
                            
                            <div class="escala-servicos">
                                <div class="escala-servico">
                                    <div class="escala-servico-icon">‚è∞</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Meia-hora</div>
                                        <div class="escala-organista ${!item.meia_hora ? 'escala-vazio' : ''}">
                                            ${item.meia_hora || 'N√£o definido'}
                                        </div>
                                    </div>
                                </div>
                                <div class="escala-servico">
                                    <div class="escala-servico-icon">üéπ</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Culto</div>
                                        <div class="escala-organista ${!item.culto ? 'escala-vazio' : ''}">
                                            ${item.culto || 'N√£o definido'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('statusEscala').textContent = 
                    `‚úÖ ${escala.length} escala(s) cadastrada(s)`;
                    
            } catch (error) {
                console.error('Erro ao renderizar escala atual:', error);
                document.getElementById('escalaAtual').innerHTML = 
                    '<div class="no-escala">Erro ao carregar escala</div>';
            }
        }
        
        // Renderizar apenas os dias do organista logado
        async function renderMeusDias() {
            if (isAdmin) return; // Admin n√£o precisa desta fun√ß√£o
            
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escala = data.escala || [];
                
                const container = document.getElementById('meusDias');
                
                if (!escala || escala.length === 0) {
                    container.innerHTML = '<div class="no-escala">Nenhuma escala cadastrada ainda</div>';
                    return;
                }
                
                // Pegar data atual para compara√ß√£o
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Pegar o nome do usu√°rio atual
                const nomeUsuario = '{{ user.nome }}';
                
                // Filtrar apenas os dias onde o usu√°rio est√° escalado
                const meusDias = escala
                    .filter(item => {
                        const dataEscala = new Date(item.data);
                        // Mostrar apenas dias futuros ou de hoje
                        if (dataEscala < hoje) return false;
                        
                        // Verificar se o usu√°rio est√° escalado (meia_hora ou culto)
                        return item.meia_hora === nomeUsuario || item.culto === nomeUsuario;
                    })
                    .sort((a, b) => new Date(a.data) - new Date(b.data));
                
                if (meusDias.length === 0) {
                    container.innerHTML = '<div class="no-escala">Voc√™ n√£o est√° escalado(a) em nenhuma data pr√≥xima</div>';
                    return;
                }
                
                // Renderizar os dias do organista
                container.innerHTML = meusDias.map(item => {
                    const data = new Date(item.data);
                    const dia = data.getDate();
                    const nomeMes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][data.getMonth()];
                    const ano = data.getFullYear();
                    
                    const diaSemana = item.dia_semana === 'Sunday' ? 'Domingo' : 'Ter√ßa-feira';
                    const tipoDia = item.dia_semana === 'Sunday' ? 'domingo' : 'terca';
                    const emoji = diaSemana === 'Domingo' ? 'üôè' : 'üìñ';
                    
                    // Verificar em qual servi√ßo o organista est√°
                    const isMeiaHora = item.meia_hora === nomeUsuario;
                    const isCulto = item.culto === nomeUsuario;
                    
                    // Preparar lista de servi√ßos para passar para a fun√ß√£o
                    const servicos = [];
                    if (isMeiaHora) servicos.push('meia_hora');
                    if (isCulto) servicos.push('culto');
                    const servicosStr = JSON.stringify(servicos).replace(/"/g, '&quot;');
                    
                    return `
                        <div class="escala-item ${tipoDia}">
                            <div class="escala-date-box">
                                <div class="escala-dia-numero">${dia}</div>
                                <div class="escala-dia-semana">${emoji} ${diaSemana}</div>
                                <div class="escala-mes-ano">${nomeMes} ${ano}</div>
                            </div>
                            
                            <div class="escala-divider"></div>
                            
                            <div class="escala-servicos">
                                ${isMeiaHora ? `
                                <div class="escala-servico" style="background: rgba(16, 185, 129, 0.15); border-left-color: #10b981; border-left-width: 4px;">
                                    <div class="escala-servico-icon">‚è∞</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Meia-hora</div>
                                        <div class="escala-organista" style="color: #10b981; font-weight: bold;">‚úì Voc√™</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${isCulto ? `
                                <div class="escala-servico" style="background: rgba(16, 185, 129, 0.15); border-left-color: #10b981; border-left-width: 4px;">
                                    <div class="escala-servico-icon">üéπ</div>
                                    <div class="escala-servico-text">
                                        <div class="escala-tipo">Culto</div>
                                        <div class="escala-organista" style="color: #10b981; font-weight: bold;">‚úì Voc√™</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <button onclick="adicionarAgenda('${item.data}', '${item.dia_semana}', ${servicosStr})" 
                                        class="btn-adicionar-agenda"
                                        style="margin-top: 10px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                    üìÖ Adicionar √† Agenda
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                    
            } catch (error) {
                console.error('Erro ao renderizar meus dias:', error);
                document.getElementById('meusDias').innerHTML = 
                    '<div class="no-escala">Erro ao carregar seus dias</div>';
            }
        }
        
        // Adicionar organista
        async function addOrganista(event) {
            event.preventDefault();
            
            const payload = {
                id: document.getElementById('orgId').value,
                nome: document.getElementById('orgNome').value,
                tipos: Array.from(document.getElementById('orgTipos').selectedOptions).map(o => o.value),
                dias_permitidos: Array.from(document.getElementById('orgDias').selectedOptions).map(o => o.value),
                regras_especiais: {}
            };
            
            try {
                const response = await fetch('/organistas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('alertOrganista', 'Organista adicionado com sucesso!', 'success');
                    document.getElementById('formOrganista').reset();
                    loadOrganistas();
                } else {
                    showAlert('alertOrganista', result.error, 'error');
                }
            } catch (error) {
                showAlert('alertOrganista', 'Erro ao adicionar organista.', 'error');
            }
        }
        
        // Remover organista
        // Editar organista
        function editarOrganista(id) {
            const organista = organistas.find(o => o.id === id);
            if (!organista) {
                alert('Organista n√£o encontrado!');
                return;
            }
            
            // Preencher formul√°rio
            document.getElementById('editOrgId').value = organista.id;
            document.getElementById('editOrgNome').value = organista.nome;
            
            // Selecionar tipos
            const selectTipos = document.getElementById('editOrgTipos');
            Array.from(selectTipos.options).forEach(option => {
                option.selected = organista.tipos.includes(option.value);
            });
            
            // Selecionar dias
            const selectDias = document.getElementById('editOrgDias');
            Array.from(selectDias.options).forEach(option => {
                option.selected = organista.dias_permitidos.includes(option.value);
            });
            
            // Abrir modal
            document.getElementById('modalEditarOrganista').classList.add('active');
        }
        
        function fecharModalEditar() {
            document.getElementById('modalEditarOrganista').classList.remove('active');
            document.getElementById('formEditarOrganista').reset();
        }
        
        async function salvarEdicaoOrganista(event) {
            event.preventDefault();
            
            const id = document.getElementById('editOrgId').value;
            const nome = document.getElementById('editOrgNome').value;
            
            const selectTipos = document.getElementById('editOrgTipos');
            const tipos = Array.from(selectTipos.selectedOptions).map(opt => opt.value);
            
            const selectDias = document.getElementById('editOrgDias');
            const dias_permitidos = Array.from(selectDias.selectedOptions).map(opt => opt.value);
            
            if (tipos.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um tipo!');
                return;
            }
            
            if (dias_permitidos.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um dia permitido!');
                return;
            }
            
            try {
                const response = await fetch(`/organistas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome,
                        tipos,
                        dias_permitidos
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Organista atualizada com sucesso!');
                    fecharModalEditar();
                    await loadOrganistas();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Erro: ${error.error || 'Falha ao atualizar'}`);
                }
            } catch (error) {
                console.error('Erro ao atualizar organista:', error);
                alert('‚ùå Erro ao atualizar organista.');
            }
        }
        
        async function deleteOrganista(id) {
            if (!confirm('Deseja realmente remover este organista?')) return;
            
            try {
                const response = await fetch(`/organistas/${id}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (response.ok) {
                    loadOrganistas();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Erro ao remover organista.');
            }
        }
        
        // Carregar indisponibilidades
        async function loadIndisponibilidades() {
            if (isCoord) {
                document.getElementById('calendarioIndisp').innerHTML = 
                    '<div style="background: #dbeafe; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">' +
                    '<h3 style="color: #1e40af; margin-bottom: 10px;">‚ÑπÔ∏è Coordenador</h3>' +
                    '<p style="color: #1e3a8a;">Coordenadores visualizam todas as indisponibilidades na p√°gina de gera√ß√£o de escala. Para ver/editar indisponibilidades de uma organista espec√≠fica, entre com a conta dela.</p>' +
                    '</div>';
                document.getElementById('chipsDatas').innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch('/indisponibilidades');
                indisponibilidades = await response.json();
                
                renderCalendar();
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Renderizar calend√°rio simplificado
        function renderCalendar() {
            // Usar datas configuradas no per√≠odo
            const inicio = new Date('{{ cfg.bimestre.inicio }}T00:00:00');
            const fim = new Date('{{ cfg.bimestre.fim }}T23:59:59');
            
            const calendar = document.getElementById('calendarioIndisp');
            
            const mesesNome = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            // Agrupar datas por m√™s (apenas domingos e ter√ßas)
            const datasOrganizadas = {};
            let current = new Date(inicio);
            
            while (current <= fim) {
                const dayOfWeek = current.getDay();
                
                // Apenas domingos (0) e ter√ßas (2)
                if (dayOfWeek === 0 || dayOfWeek === 2) {
                    const mesAno = `${current.getFullYear()}-${current.getMonth()}`;
                    
                    if (!datasOrganizadas[mesAno]) {
                        datasOrganizadas[mesAno] = {
                            mes: mesesNome[current.getMonth()],
                            ano: current.getFullYear(),
                            datas: []
                        };
                    }
                    
                    datasOrganizadas[mesAno].datas.push({
                        data: new Date(current),
                        dateStr: current.toISOString().split('T')[0],
                        dia: current.getDate(),
                        diaSemana: diasSemana[dayOfWeek]
                    });
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            // Renderizar por m√™s em ordem cronol√≥gica
            let html = '<div style="margin-bottom: 20px;"><p style="color: #666; font-size: 0.95rem; margin-bottom: 20px;">üìÖ Clique nas datas abaixo para marcar/desmarcar sua indisponibilidade:</p>';
            
            // Ordenar os meses cronologicamente
            const mesesOrdenados = Object.keys(datasOrganizadas).sort((a, b) => {
                const [anoA, mesA] = a.split('-').map(Number);
                const [anoB, mesB] = b.split('-').map(Number);
                if (anoA !== anoB) return anoA - anoB;
                return mesA - mesB;
            });
            
            mesesOrdenados.forEach(mesAno => {
                const mesData = datasOrganizadas[mesAno];
                
                html += `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                        <h3 style="color: #1e293b; font-size: 1.5rem; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
                            ${mesData.mes} / ${mesData.ano}
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                `;
                
                mesData.datas.forEach(item => {
                    const isSelected = indisponibilidades.some(i => i.data === item.dateStr);
                    
                    html += `
                        <div onclick="toggleDate('${item.dateStr}')" 
                            style="padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;
                            background: ${isSelected ? '#ef4444' : '#10b981'}; 
                            color: white; 
                            font-weight: 500; 
                            transition: all 0.2s;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px;">
                                ${item.diaSemana}
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold;">
                                ${String(item.dia).padStart(2, '0')}
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 5px; opacity: 0.9;">
                                ${isSelected ? '‚úì Indispon√≠vel' : 'Dispon√≠vel'}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            calendar.innerHTML = html;
            updateChips();
        }
        
        // Toggle data
        async function toggleDate(dateStr) {
            const exists = indisponibilidades.some(i => i.data === dateStr);
            
            if (exists) {
                // Remover
                try {
                    const response = await fetch(`/indisponibilidades/${currentUserId}/${dateStr}`, {method: 'DELETE'});
                    if (response.ok) {
                        indisponibilidades = indisponibilidades.filter(i => i.data !== dateStr);
                        renderCalendar();
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Erro ao remover indisponibilidade.');
                    }
                } catch (error) {
                    alert('Erro ao remover indisponibilidade.');
                }
            } else {
                // Adicionar
                const payload = {
                    data: dateStr,
                    motivo: 'Indispon√≠vel'
                };
                
                try {
                    const response = await fetch('/indisponibilidades', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        indisponibilidades.push({...payload, id: currentUserId});
                        renderCalendar();
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Erro ao adicionar indisponibilidade.');
                    }
                } catch (error) {
                    alert('Erro ao adicionar indisponibilidade.');
                }
            }
        }
        
        // Atualizar chips
        function updateChips() {
            const chips = document.getElementById('chipsDatas');
            
            if (indisponibilidades.length === 0) {
                chips.innerHTML = '<p style="color: #666;">Nenhuma indisponibilidade marcada.</p>';
                return;
            }
            
            let html = '<h3>Datas marcadas como indispon√≠veis:</h3><div style="margin-top: 10px;">';
            indisponibilidades.forEach(i => {
                const date = new Date(i.data + 'T00:00:00');
                html += `<span class="info-badge" style="background: #fee2e2; color: #991b1b;">
                    ${date.toLocaleDateString('pt-BR')}
                </span>`;
            });
            html += '</div>';
            chips.innerHTML = html;
        }
        
        // Carregar todas indisponibilidades (Admin)
        async function loadAdminIndisp() {
            if (!isAdmin) return;
            
            try {
                const response = await fetch('/admin/indisponibilidades/todas');
                const data = await response.json();
                
                const container = document.getElementById('adminIndispList');
                container.innerHTML = '';
                
                if (Object.keys(data).length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">Nenhuma indisponibilidade cadastrada ainda.</p>';
                    return;
                }
                
                for (const [orgId, info] of Object.entries(data)) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.background = '#f9fafb';
                    card.style.marginBottom = '15px';
                    
                    let html = `<h3 style="color: #667eea; margin-bottom: 10px;">üë§ ${info.nome}</h3>`;
                    
                    if (info.indisponibilidades.length === 0) {
                        html += '<p style="color: #666;">Nenhuma indisponibilidade marcada.</p>';
                    } else {
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                        info.indisponibilidades.forEach(indisp => {
                            const dataBR = indisp.data.split('-').reverse().join('/');
                            html += `
                                <div style="background: #fee2e2; color: #991b1b; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                                    <span>${dataBR}</span>
                                    <button onclick="deleteIndispAdmin('${orgId}', '${indisp.data}')" 
                                            style="background: #ef4444; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer;">
                                        ‚úï
                                    </button>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    card.innerHTML = html;
                    container.appendChild(card);
                }
            } catch (error) {
                console.error('Erro ao carregar indisponibilidades:', error);
            }
        }
        
        // Deletar indisponibilidade (Admin)
        async function deleteIndispAdmin(orgId, data) {
            if (!confirm(`Remover indisponibilidade de ${data.split('-').reverse().join('/')}?`)) return;
            
            try {
                const response = await fetch(`/indisponibilidades/${orgId}/${data}`, {method: 'DELETE'});
                if (response.ok) {
                    loadAdminIndisp();
                } else {
                    alert('Erro ao remover indisponibilidade.');
                }
            } catch (error) {
                alert('Erro ao remover indisponibilidade.');
            }
        }
        
        // Salvar configura√ß√µes (Admin)
        async function saveConfig(event) {
            event.preventDefault();
            
            const payload = {
                bimestre: {
                    inicio: document.getElementById('configInicio').value,
                    fim: document.getElementById('configFim').value
                },
                fechamento_publicacao_dias: parseInt(document.getElementById('configFechamento').value)
            };
            
            try {
                const response = await fetch('/admin/config', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showAlert('alertConfig', '‚úÖ Configura√ß√µes salvas com sucesso! Atualizando...', 'success');
                    // Aguardar 1 segundo e recarregar a p√°gina para atualizar todas as datas
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('alertConfig', 'Erro ao salvar configura√ß√µes.', 'error');
                }
            } catch (error) {
                showAlert('alertConfig', 'Erro ao salvar configura√ß√µes.', 'error');
            }
        }
        
        // Mostrar alerta
        function showAlert(id, message, type) {
            const alert = document.getElementById(id);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }
        
        // Inicializa√ß√£o
        window.onload = function() {
            loadOrganistas();
            
            // Carregar dashboard apropriado
            if (isAdmin) {
                renderEscalaAtual();
            } else {
                renderMeusDias();
            }
            
            // Carregar filtro de organistas para admin
            if (isAdmin) {
                fetch('/organistas').then(r => r.json()).then(orgs => {
                    const select = document.getElementById('filterOrganista');
                    orgs.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.nome;
                        select.appendChild(option);
                    });
                });
            }
        };

        // ============================================
        // FUN√á√ïES PARA ESCALA (FASE 2)
        // ============================================
        
        async function criarEscalaVazia() {
            try {
                // Garantir que temos a lista de organistas
                try {
                    const response = await fetch('/organistas');
                    organistas = await response.json();
                    console.log('Organistas carregadas:', organistas.length);
                } catch (error) {
                    console.error('Erro ao carregar organistas:', error);
                    throw new Error('N√£o foi poss√≠vel carregar a lista de organistas');
                }
                
                // Buscar configura√ß√£o do bimestre
                const configResponse = await fetch('/admin/config');
                const config = await configResponse.json();
                
                const inicio = new Date(config.bimestre.inicio + 'T00:00:00');
                const fim = new Date(config.bimestre.fim + 'T00:00:00');
                
                // Criar escala vazia com todos os domingos e ter√ßas
                const escala = [];
                let current = new Date(inicio);
                
                while (current <= fim) {
                    const dayOfWeek = current.getDay();
                    
                    // Domingo (0) ou Ter√ßa (2)
                    if (dayOfWeek === 0) {
                        escala.push({
                            data: current.toISOString().split('T')[0],
                            dia_semana: 'Sunday',
                            meia_hora: null,
                            culto: null
                        });
                    } else if (dayOfWeek === 2) {
                        escala.push({
                            data: current.toISOString().split('T')[0],
                            dia_semana: 'Tuesday',
                            meia_hora: null,
                            culto: null
                        });
                    }
                    
                    current.setDate(current.getDate() + 1);
                }
                
                // Publicar escala vazia
                const response = await fetch('/escala/publicar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ escala: escala })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao criar escala');
                }

                showAlertEscala('‚úÖ Escala criada! Agora preencha manualmente os organistas.', 'success');
                await loadEscalaAtual();
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        async function loadEscalaAtual() {
            try {
                // Carregar organistas
                try {
                    const orgResponse = await fetch('/organistas');
                    organistas = await orgResponse.json();
                    console.log('Organistas carregadas para escala:', organistas.length);
                } catch (error) {
                    console.error('Erro ao carregar organistas:', error);
                }
                
                // Carregar indisponibilidades
                try {
                    const indispResponse = await fetch('/indisponibilidades');
                    indisponibilidades = await indispResponse.json();
                    console.log('Indisponibilidades carregadas:', indisponibilidades.length);
                } catch (error) {
                    console.error('Erro ao carregar indisponibilidades:', error);
                }
                
                const response = await fetch('/escala/atual');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || error.error || 'Erro ao carregar escala');
                }

                const data = await response.json();
                
                if (data.escala && data.escala.length > 0) {
                    renderEscala(data.escala);
                    renderEstatisticas(data.estatisticas);
                    showAlertEscala('Escala atual carregada.', 'success');
                } else {
                    showAlertEscala('Nenhuma escala publicada ainda.', 'info');
                    document.getElementById('escalaContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala publicada ainda.</p>
                            ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Nova Escala" acima para come√ßar.</p>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        function renderEscala(escala) {
            const container = document.getElementById('escalaContainer');
            
            if (!escala || escala.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>Nenhuma escala gerada ainda.</p>
                        ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Gerar Escala Automaticamente" acima.</p>' : ''}
                    </div>
                `;
                return;
            }

            // Agrupar por m√™s
            const escalaPorMes = {};
            const mesesNome = {
                1: 'Janeiro', 2: 'Fevereiro', 3: 'Mar√ßo', 4: 'Abril',
                5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
            };
            
            const diasSemana = {
                'Sunday': 'Domingo',
                'Tuesday': 'Ter√ßa-feira',
                'Monday': 'Segunda',
                'Wednesday': 'Quarta',
                'Thursday': 'Quinta',
                'Friday': 'Sexta',
                'Saturday': 'S√°bado'
            };

            escala.forEach(item => {
                const date = new Date(item.data + 'T00:00:00');
                const mesAno = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!escalaPorMes[mesAno]) {
                    escalaPorMes[mesAno] = {
                        nome: `${mesesNome[date.getMonth() + 1]} de ${date.getFullYear()}`,
                        itens: []
                    };
                }
                escalaPorMes[mesAno].itens.push(item);
            });

            // Atualizar informa√ß√£o do per√≠odo
            const infoEscala = document.getElementById('infoEscala');
            const primeiraData = formatDateBR(escala[0].data);
            const ultimaData = formatDateBR(escala[escala.length - 1].data);
            infoEscala.innerHTML = `
                <p><strong>üìÖ Per√≠odo:</strong> ${primeiraData} a ${ultimaData}</p>
                <p><strong>üìä Total de aloca√ß√µes:</strong> ${escala.length} (${Object.keys(escalaPorMes).length} ${Object.keys(escalaPorMes).length === 1 ? 'm√™s' : 'meses'})</p>
            `;

            // Renderizar cada m√™s separadamente
            let html = '';
            const mesesOrdenados = Object.keys(escalaPorMes).sort();
            
            mesesOrdenados.forEach((mesAno, index) => {
                const mes = escalaPorMes[mesAno];
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px;">
                            üìÖ ${mes.nome}
                        </h3>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 12px; text-align: left;">Data</th>
                                        <th style="padding: 12px; text-align: left;">Dia</th>
                                        <th style="padding: 12px; text-align: center; border-left: 2px solid rgba(255,255,255,0.3);">
                                            üéπ Meia-hora
                                        </th>
                                        <th style="padding: 12px; text-align: center; border-left: 2px solid rgba(255,255,255,0.3);">
                                            üéµ Culto
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                mes.itens.forEach(item => {
                    html += `
                        <tr style="border-bottom: 1px solid #e5e7eb; background: white;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                            <td style="padding: 12px; font-weight: 500;">${formatDateBR(item.data)}</td>
                            <td style="padding: 12px;">${diasSemana[item.dia_semana] || item.dia_semana}</td>
                    `;
                    
                    if (item.dia_semana === 'Sunday') {
                        // DOMINGO: Duas fases separadas (Meia-hora e Culto)
                        const meiaHora = item.meia_hora || '‚Äî';
                        const culto = item.culto || '‚Äî';
                        
                        html += `
                            <td style="padding: 12px; background: #f0fdf4;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #10b981; font-size: 0.75em; margin-bottom: 4px;">MEIA-HORA</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'meia_hora', meiaHora) : 
                                        `<span>${meiaHora}</span>`
                                    }
                                </div>
                            </td>
                            <td style="padding: 12px; background: #eff6ff;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #3b82f6; font-size: 0.75em; margin-bottom: 4px;">CULTO</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'culto', culto) : 
                                        `<span>${culto}</span>`
                                    }
                                </div>
                            </td>
                        `;
                    } else {
                        // TER√áA-FEIRA: Duas fases (podem ser pessoas diferentes)
                        // Para compatibilidade: se tiver 'unica', usar para ambas; sen√£o usar campos separados
                        const meiaHora = item.meia_hora || item.unica || '‚Äî';
                        const culto = item.culto || item.unica || '‚Äî';
                        
                        html += `
                            <td style="padding: 12px; background: #fef3c7;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #d97706; font-size: 0.75em; margin-bottom: 4px;">MEIA-HORA</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'meia_hora', meiaHora) : 
                                        `<span>${meiaHora}</span>`
                                    }
                                </div>
                            </td>
                            <td style="padding: 12px; background: #fef3c7;">
                                <div style="display: flex; flex-direction: column;">
                                    <strong style="color: #d97706; font-size: 0.75em; margin-bottom: 4px;">CULTO</strong>
                                    ${isAdmin ? 
                                        createOrganistaSelectHTML(item.data, 'culto', culto) : 
                                        `<span>${culto}</span>`
                                    }
                                </div>
                            </td>
                        `;
                    }
                    
                    html += '</tr>';
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function createOrganistaSelectHTML(data, tipo, valorAtual) {
            const selectId = `select_${data}_${tipo}`;
            let html = `<select id="${selectId}" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px;">`;
            html += `<option value="">-- Selecione --</option>`;
            
            let opcoesDisponiveis = 0;
            
            organistas.forEach(org => {
                const selected = org.nome === valorAtual ? 'selected' : '';
                
                // Verificar se est√° indispon√≠vel nesta data
                const indisponivelNaData = indisponibilidades.some(
                    ind => ind.id === org.id && ind.data === data
                );
                
                // Verificar se tem a fase habilitada
                let temFaseHabilitada = true;
                if (tipo === 'meia_hora') {
                    temFaseHabilitada = org.tipos && org.tipos.includes('Meia-hora');
                } else if (tipo === 'culto') {
                    temFaseHabilitada = org.tipos && org.tipos.includes('Culto');
                } else if (tipo === 'unica') {
                    // Para ter√ßa precisa ter ambas as fases
                    temFaseHabilitada = org.tipos && 
                        org.tipos.includes('Meia-hora') && 
                        org.tipos.includes('Culto');
                }
                
                // Se n√£o est√° indispon√≠vel E tem fase habilitada, conta como dispon√≠vel
                if (!indisponivelNaData && temFaseHabilitada) {
                    opcoesDisponiveis++;
                }
                
                const disabled = indisponivelNaData || !temFaseHabilitada ? 'disabled' : '';
                const style = indisponivelNaData ? 'color: #999; text-decoration: line-through;' : 
                             !temFaseHabilitada ? 'color: #dc2626; font-style: italic;' : '';
                const suffix = indisponivelNaData ? ' (indispon√≠vel)' : 
                              !temFaseHabilitada ? ' (n√£o habilitado)' : '';
                
                html += `<option value="${org.nome}" ${selected} ${disabled} style="${style}">${org.nome}${suffix}</option>`;
            });
            
            html += '</select>';
            
            // Debug: log se h√° poucas op√ß√µes
            if (opcoesDisponiveis <= 1) {
                console.log(`‚ö†Ô∏è Dropdown ${tipo} na data ${data}: apenas ${opcoesDisponiveis} op√ß√£o(√µes) dispon√≠vel(is)`);
            }
            
            return html;
        }

        async function salvarTodasAlteracoes() {
            try {
                showAlertEscala('Salvando todas as altera√ß√µes...', 'info');
                
                // Buscar escala atual do backend
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escalaAtual = data.escala;
                
                if (!escalaAtual || escalaAtual.length === 0) {
                    showAlertEscala('‚ö†Ô∏è Nenhuma escala para salvar.', 'warning');
                    return;
                }
                
                let alteracoes = 0;
                let erros = 0;
                
                // Para cada item da escala, ler os valores dos dropdowns e atualizar
                for (const item of escalaAtual) {
                    const selectMeiaHora = document.getElementById(`select_${item.data}_meia_hora`);
                    const selectCulto = document.getElementById(`select_${item.data}_culto`);
                    
                    if (selectMeiaHora && selectCulto) {
                        const meiaHoraAtual = selectMeiaHora.value || null;
                        const cultoAtual = selectCulto.value || null;
                        
                        // Verificar se houve mudan√ßa
                        const meiaHoraOriginal = item.meia_hora || item.unica || null;
                        const cultoOriginal = item.culto || item.unica || null;
                        
                        if (meiaHoraAtual !== meiaHoraOriginal || cultoAtual !== cultoOriginal) {
                            try {
                                const saveResponse = await fetch(`/escala/editar/${item.data}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        alocacao: {
                                            meia_hora: meiaHoraAtual,
                                            culto: cultoAtual
                                        }
                                    })
                                });
                                
                                if (saveResponse.ok) {
                                    alteracoes++;
                                } else {
                                    erros++;
                                }
                            } catch (error) {
                                console.error(`Erro ao salvar ${item.data}:`, error);
                                erros++;
                            }
                        }
                    }
                }
                
                if (alteracoes > 0) {
                    showAlertEscala(`‚úÖ ${alteracoes} altera√ß√£o(√µes) salva(s) com sucesso!${erros > 0 ? ` (${erros} erro(s))` : ''}`, 'success');
                    await loadEscalaAtual();
                    await renderEscalaAtual(); // Atualizar dashboard
                } else {
                    showAlertEscala('‚ÑπÔ∏è Nenhuma altera√ß√£o detectada.', 'info');
                }
            } catch (error) {
                showAlertEscala('‚ùå Erro ao salvar altera√ß√µes: ' + error.message, 'error');
            }
        }

        async function salvarEdicao(dataIso) {
            try {
                const selectMeiaHora = document.getElementById(`select_${dataIso}_meia_hora`);
                const selectCulto = document.getElementById(`select_${dataIso}_culto`);

                const alocacao = {};
                
                if (selectMeiaHora && selectCulto) {
                    // Domingo OU Ter√ßa (ambos agora usam meia_hora e culto)
                    alocacao.meia_hora = selectMeiaHora.value || null;
                    alocacao.culto = selectCulto.value || null;
                }

                const response = await fetch(`/escala/editar/${dataIso}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ alocacao })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.erro || 'Erro ao salvar edi√ß√£o');
                }

                showAlertEscala('‚úÖ Aloca√ß√£o atualizada com sucesso!', 'success');
                await loadEscalaAtual();
            } catch (error) {
                showAlertEscala('Erro: ' + error.message, 'error');
            }
        }

        function renderLogs(logs) {
            const logsDiv = document.getElementById('logsGeracao');
            const logsContent = document.getElementById('logsContent');
            
            if (!logs || logs.length === 0) {
                logsDiv.style.display = 'none';
                return;
            }

            logsDiv.style.display = 'block';
            logsContent.innerHTML = logs.map(log => {
                const emoji = log.includes('‚úÖ') ? '' : 
                             log.includes('‚ö†Ô∏è') ? '' : 
                             log.includes('‚ùå') ? '' : 'üìù';
                return `<div style="margin-bottom: 5px;">${emoji} ${log}</div>`;
            }).join('');
        }

        function renderEstatisticas(stats) {
            const statsDiv = document.getElementById('statsEscala');
            
            if (!stats) {
                statsDiv.innerHTML = '<p style="color: #666;">Gere uma escala para ver as estat√≠sticas.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            
            Object.entries(stats).forEach(([nome, contagem]) => {
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9em; opacity: 0.9;">${nome}</div>
                        <div style="font-size: 2em; font-weight: bold; margin-top: 5px;">${contagem.total}</div>
                        <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">
                            ${contagem.meia_hora || 0} Meia-hora ‚Ä¢ ${contagem.culto || 0} Culto ‚Ä¢ ${contagem.terca || 0} Ter√ßa
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statsDiv.innerHTML = html;
        }

        function showAlertEscala(message, type) {
            const alert = document.getElementById('alertEscala');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        function formatDateBR(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Adicionar evento √† agenda (iCalendar)
        function adicionarAgenda(data, diaSemana, servicos) {
            try {
                // Parse da data
                const dataEvento = new Date(data);
                
                // Definir hor√°rios baseado no dia da semana e servi√ßo
                let eventos = [];
                const nomeDia = diaSemana === 'Sunday' ? 'Domingo' : 'Ter√ßa-feira';
                
                servicos.forEach(servico => {
                    let horaInicio, horaFim, titulo;
                    
                    if (servico === 'meia_hora') {
                        if (diaSemana === 'Sunday') {
                            horaInicio = '18:00';
                            horaFim = '18:30';
                        } else {
                            horaInicio = '19:00';
                            horaFim = '19:30';
                        }
                        titulo = `Meia-hora - ${nomeDia}`;
                    } else if (servico === 'culto') {
                        if (diaSemana === 'Sunday') {
                            horaInicio = '18:30';
                            horaFim = '20:00';
                        } else {
                            horaInicio = '19:30';
                            horaFim = '21:00';
                        }
                        titulo = `Culto - ${nomeDia}`;
                    }
                    
                    eventos.push({ titulo, horaInicio, horaFim });
                });
                
                // Gerar arquivo iCalendar
                let icsContent = 'BEGIN:VCALENDAR\r\n';
                icsContent += 'VERSION:2.0\r\n';
                icsContent += 'PRODID:-//Rod√≠zio de Organistas - Vila Paula//PT\r\n';
                icsContent += 'CALSCALE:GREGORIAN\r\n';
                icsContent += 'METHOD:PUBLISH\r\n';
                
                eventos.forEach(evento => {
                    // Formatar data e hora para iCalendar (formato: YYYYMMDDTHHmmss)
                    const ano = dataEvento.getFullYear();
                    const mes = String(dataEvento.getMonth() + 1).padStart(2, '0');
                    const dia = String(dataEvento.getDate()).padStart(2, '0');
                    const [horaI, minI] = evento.horaInicio.split(':');
                    const [horaF, minF] = evento.horaFim.split(':');
                    
                    const dtStart = `${ano}${mes}${dia}T${horaI}${minI}00`;
                    const dtEnd = `${ano}${mes}${dia}T${horaF}${minF}00`;
                    const dtStamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    const uid = `${dtStart}-${Math.random().toString(36).substr(2, 9)}@rodizio-organistas`;
                    
                    icsContent += 'BEGIN:VEVENT\r\n';
                    icsContent += `UID:${uid}\r\n`;
                    icsContent += `DTSTAMP:${dtStamp}\r\n`;
                    icsContent += `DTSTART:${dtStart}\r\n`;
                    icsContent += `DTEND:${dtEnd}\r\n`;
                    icsContent += `SUMMARY:${evento.titulo} - Rod√≠zio de Organistas\r\n`;
                    icsContent += `DESCRIPTION:Rod√≠zio de Organistas - Vila Paula\\n${evento.titulo}\r\n`;
                    icsContent += `LOCATION:Igreja Vila Paula\r\n`;
                    icsContent += `STATUS:CONFIRMED\r\n`;
                    icsContent += 'BEGIN:VALARM\r\n';
                    icsContent += 'TRIGGER:-PT1H\r\n';
                    icsContent += 'ACTION:DISPLAY\r\n';
                    icsContent += `DESCRIPTION:Lembrete: ${evento.titulo} em 1 hora\r\n`;
                    icsContent += 'END:VALARM\r\n';
                    icsContent += 'END:VEVENT\r\n';
                });
                
                icsContent += 'END:VCALENDAR\r\n';
                
                // Criar blob e fazer download
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `rodizio-organista-${dataEvento.getDate()}-${dataEvento.getMonth()+1}-${dataEvento.getFullYear()}.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
            } catch (error) {
                console.error('Erro ao criar evento:', error);
                alert('‚ùå Erro ao criar evento para a agenda.');
            }
        }

        function exportarPDF() {
            // Abre o PDF em nova aba com timestamp para evitar cache
            const timestamp = new Date().getTime();
            window.open('/escala/pdf?t=' + timestamp, '_blank');
        }

        // Compartilhar escala no WhatsApp
        async function compartilharWhatsApp() {
            try {
                const response = await fetch('/escala/atual');
                const data = await response.json();
                const escala = data.escala || [];
                
                if (!escala || escala.length === 0) {
                    alert('‚ö†Ô∏è Nenhuma escala cadastrada para compartilhar.');
                    return;
                }
                
                // Construir mensagem
                let mensagem = `*ESCALA DE ORGANISTAS - VILA PAULA*\n`;
                mensagem += `Per√≠odo: {{ cfg.bimestre.inicio | date_br }} at√© {{ cfg.bimestre.fim | date_br }}\n\n`;
                
                // Agrupar por m√™s
                const meses = {};
                escala.forEach(item => {
                    const data = new Date(item.data);
                    const mes = data.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    const mesCapitalizado = mes.charAt(0).toUpperCase() + mes.slice(1);
                    
                    if (!meses[mesCapitalizado]) {
                        meses[mesCapitalizado] = [];
                    }
                    meses[mesCapitalizado].push(item);
                });
                
                // Formatar mensagem por m√™s
                Object.keys(meses).sort().forEach(mes => {
                    mensagem += `*${mes}*\n`;
                    mensagem += `${'‚îÄ'.repeat(30)}\n`;
                    
                    meses[mes].forEach(item => {
                        const data = new Date(item.data);
                        const dia = data.getDate().toString().padStart(2, '0');
                        const diaSemana = item.dia_semana === 'Sunday' ? 'Domingo' : 'Ter√ßa';
                        
                        mensagem += `\n*${dia} - ${diaSemana}*\n`;
                        mensagem += `Meia-hora: ${item.meia_hora || 'N√£o definido'}\n`;
                        mensagem += `Culto: ${item.culto || 'N√£o definido'}\n`;
                    });
                    
                    mensagem += `\n`;
                });
                
                mensagem += `\n_Gerado pelo Sistema de Rod√≠zio_`;
                
                // Codificar mensagem para URL
                const mensagemCodificada = encodeURIComponent(mensagem);
                
                // Abrir WhatsApp
                const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
                window.open(urlWhatsApp, '_blank');
                
            } catch (error) {
                console.error('Erro ao compartilhar no WhatsApp:', error);
                alert('‚ùå Erro ao gerar mensagem para o WhatsApp.');
            }
        }

        // Inicializar dados ao carregar a p√°gina
        async function initializeApp() {
            try {
                // Carregar organistas primeiro
                await loadOrganistas();
                
                // Depois carregar escala se estiver na aba
                if (document.getElementById('escala')) {
                    await loadEscalaAtual();
                }
            } catch (error) {
                console.error('Erro ao inicializar:', error);
            }
        }

        // ========== FUN√á√ïES RJM ==========
        
        async function criarEscalaRJM() {
            if (!confirm('Criar nova escala RJM vazia? Isso ir√° substituir a escala existente.')) {
                return;
            }
            
            try {
                const response = await fetch('/rjm/criar-vazia', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    alert('‚úÖ Escala RJM vazia criada com sucesso!');
                    await loadEscalaRJM();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Erro: ${error.error || 'Falha ao criar escala'}`);
                }
            } catch (error) {
                console.error('Erro ao criar escala RJM:', error);
                alert('‚ùå Erro ao criar escala RJM.');
            }
        }
        
        async function loadEscalaRJM() {
            try {
                const response = await fetch('/rjm/atual');
                const data = await response.json();
                const escalaRJM = data.escala_rjm || [];
                
                if (!escalaRJM || escalaRJM.length === 0) {
                    document.getElementById('escalaRJMContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nenhuma escala RJM publicada ainda.</p>
                            ${isAdmin ? '<p style="font-size: 0.9em; margin-top: 10px;">Clique em "Criar Escala RJM Vazia" acima para come√ßar.</p>' : ''}
                        </div>
                    `;
                    return;
                }
                
                // Renderizar tabela RJM
                let html = '<table class="escala-table"><thead><tr>';
                html += '<th style="width: 120px;">Data</th>';
                html += '<th style="width: 100px;">Dia</th>';
                html += '<th>Organista (10:00 - 11:30)</th>';
                html += '</tr></thead><tbody>';
                
                escalaRJM.forEach(item => {
                    const data = new Date(item.data);
                    const dataFormatada = data.toLocaleDateString('pt-BR');
                    const diaSemana = 'Domingo';
                    
                    html += '<tr>';
                    html += `<td><strong>${dataFormatada}</strong></td>`;
                    html += `<td><span class="badge badge-green">${diaSemana}</span></td>`;
                    
                    if (isAdmin) {
                        html += '<td>';
                        html += `<select class="organista-select" data-escala-id="${item.id}" data-tipo="organista" onchange="marcarAlteradoRJM(this)">`;
                        html += '<option value="">Selecione...</option>';
                        
                        organistas.forEach(org => {
                            const indisponivelNaData = indisponibilidades.some(ind => 
                                ind.id === org.id && ind.data === item.data
                            );
                            
                            const temPermissaoRJM = org.tipos && org.tipos.includes('RJM');
                            const selected = item.organista === org.nome ? 'selected' : '';
                            
                            if (indisponivelNaData) {
                                html += `<option value="${org.nome}" ${selected} style="text-decoration: line-through; color: red;">~~${org.nome}~~</option>`;
                            } else if (!temPermissaoRJM) {
                                html += `<option value="${org.nome}" ${selected} style="font-style: italic; color: red;">${org.nome} (sem permiss√£o RJM)</option>`;
                            } else {
                                html += `<option value="${org.nome}" ${selected}>${org.nome}</option>`;
                            }
                        });
                        
                        html += '</select></td>';
                    } else {
                        html += `<td>${item.organista || '-'}</td>`;
                    }
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                document.getElementById('escalaRJMContainer').innerHTML = html;
                
                // Atualizar info
                if (escalaRJM.length > 0) {
                    const primeiraData = formatDateBR(escalaRJM[0].data);
                    const ultimaData = formatDateBR(escalaRJM[escalaRJM.length - 1].data);
                    document.getElementById('infoEscalaRJM').innerHTML = `
                        <p><strong>üìÖ Per√≠odo:</strong> ${primeiraData} a ${ultimaData}</p>
                        <p><strong>üìä Total de domingos RJM:</strong> ${escalaRJM.length}</p>
                    `;
                }
                
                // Estat√≠sticas
                renderStatsRJM(escalaRJM);
                
            } catch (error) {
                console.error('Erro ao carregar escala RJM:', error);
                document.getElementById('escalaRJMContainer').innerHTML = 
                    '<div style="color: red; padding: 20px;">Erro ao carregar escala RJM</div>';
            }
        }
        
        function marcarAlteradoRJM(select) {
            select.style.border = '2px solid #f59e0b';
            select.style.background = '#fffbeb';
        }
        
        async function salvarTodasAlteracoesRJM() {
            const selects = document.querySelectorAll('#escalaRJMContainer select');
            const alteracoes = [];
            
            selects.forEach(select => {
                alteracoes.push({
                    id: select.dataset.escalaId,
                    organista: select.value
                });
            });
            
            if (alteracoes.length === 0) {
                alert('Nenhuma altera√ß√£o para salvar.');
                return;
            }
            
            try {
                const response = await fetch('/rjm/atualizar-multiplos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({alteracoes})
                });
                
                if (response.ok) {
                    alert('‚úÖ Todas as altera√ß√µes foram salvas com sucesso!');
                    await loadEscalaRJM();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Erro: ${error.error || 'Falha ao salvar'}`);
                }
            } catch (error) {
                console.error('Erro ao salvar altera√ß√µes RJM:', error);
                alert('‚ùå Erro ao salvar altera√ß√µes.');
            }
        }
        
        function renderStatsRJM(escalaRJM) {
            const statsDiv = document.getElementById('statsEscalaRJM');
            
            if (!escalaRJM || escalaRJM.length === 0) {
                statsDiv.innerHTML = '<p style="color: #666;">Gere uma escala para ver as estat√≠sticas.</p>';
                return;
            }
            
            const contador = {};
            escalaRJM.forEach(item => {
                if (item.organista) {
                    contador[item.organista] = (contador[item.organista] || 0) + 1;
                }
            });
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';
            Object.entries(contador).sort((a, b) => b[1] - a[1]).forEach(([nome, total]) => {
                html += `
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">üë§ ${nome}</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${total}</div>
                        <div style="font-size: 0.8em; color: #666;">domingos RJM</div>
                    </div>
                `;
            });
            html += '</div>';
            statsDiv.innerHTML = html;
        }
        
        function exportarPDFRJM() {
            const timestamp = new Date().getTime();
            window.open('/rjm/pdf?t=' + timestamp, '_blank');
        }
        
        async function compartilharWhatsAppRJM() {
            try {
                const response = await fetch('/rjm/atual');
                const data = await response.json();
                const escalaRJM = data.escala_rjm || [];
                
                if (!escalaRJM || escalaRJM.length === 0) {
                    alert('‚ö†Ô∏è Nenhuma escala RJM cadastrada para compartilhar.');
                    return;
                }
                
                let mensagem = `*ESCALA RJM - VILA PAULA*\n`;
                mensagem += `Reuni√£o de Jovens e Menores\n`;
                mensagem += `Hor√°rio: Domingos 10:00 - 11:30\n\n`;
                
                // Agrupar por m√™s
                const meses = {};
                escalaRJM.forEach(item => {
                    const data = new Date(item.data);
                    const mesAno = data.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
                    if (!meses[mesAno]) {
                        meses[mesAno] = [];
                    }
                    meses[mesAno].push(item);
                });
                
                Object.keys(meses).forEach(mesAno => {
                    mensagem += `*${mesAno.charAt(0).toUpperCase() + mesAno.slice(1)}*\n`;
                    mensagem += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                    
                    meses[mesAno].forEach(item => {
                        const data = new Date(item.data);
                        const dia = data.getDate().toString().padStart(2, '0');
                        const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                        
                        mensagem += `${dia}/${mes} - Domingo\n`;
                        mensagem += `   Organista: ${item.organista || 'A definir'}\n\n`;
                    });
                    
                    mensagem += `\n`;
                });
                
                const mensagemCodificada = encodeURIComponent(mensagem);
                const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
                window.open(urlWhatsApp, '_blank');
                
            } catch (error) {
                console.error('Erro ao compartilhar no WhatsApp:', error);
                alert('‚ùå Erro ao gerar mensagem para o WhatsApp.');
            }
        }

        // Executar inicializa√ß√£o quando p√°gina carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
